(()=>{"use strict";class t{constructor(t,e,s,i){this.audioCtx=t,this.waveform=e,this.masterVolume=s,this.volumeFunc=i,this.initialized=!1,this.initializedFully=!1,this.effects=[],this.FLR=10,this.FS=11,this.VLR=20,this.VS=21}enable(){this._init()}disable(){this.maxGain.gain.value=0}_init(){if(!this.initialized)if(this.initialized=!0,this.maxGain=this.audioCtx.createGain(),this.maxGain.connect(this.masterVolume),this.maxGain.gain.value=0,this.volumeValue=0,this.gain=this.audioCtx.createGain(),this.gain.connect(this.maxGain),"noise"==this.waveform){var t,e,s,i,r,o,a;this.filter=this.audioCtx.createBiquadFilter(),this.filter.type="bandpass",this.filter.frequency.value=440,this.frequency=this.filter.frequency,this.filter.Q.value=5,this.filter.connect(this.gain),t=e=s=i=r=o=a=0;var n=this.audioCtx.createScriptProcessor(4096,1,1);n.onaudioprocess=function(n){for(var l=n.outputBuffer.getChannelData(0),h=0;h<4096;h++){var c=2*Math.random()-1;t=.99886*t+.0555179*c,e=.99332*e+.0750759*c,s=.969*s+.153852*c,i=.8665*i+.3104856*c,r=.55*r+.5329522*c,o=-.7616*o-.016898*c,l[h]=t+e+s+i+r+o+a+.5362*c,l[h]*=.11,a=.115926*c}},this.occilator=n,this.occilator.connect(this.filter),this.gain.gain.value=0,this.gain.gain.setValueAtTime(0,this.audioCtx.currentTime),this.initializedFully=!0}else this.filter=null,this.occilator=this.audioCtx.createOscillator(),this.occilator.frequency.value=440,this.frequency=this.occilator.frequency,this.occilator.type=this.waveform,this.occilator.connect(this.gain),this.gain.gain.value=0,this.gain.gain.setValueAtTime(0,this.audioCtx.currentTime),this.occilator.start(0),this.initializedFully=!0}setVolume(t){this.enable(),this.maxGain.gain.value=t,this.volumeValue=t,0==t&&this.disable()}playBeep(t,e){if(this._init(),this.initializedFully){var s=e/1e3,i=s/20,r=s-s/20,o=s,a=this.audioCtx.currentTime;this.frequency.cancelScheduledValues(a),this.gain.gain.cancelScheduledValues(a),this.frequency.setValueAtTime(t,a),this.gain.gain.linearRampToValueAtTime(1,a+i),this.gain.gain.linearRampToValueAtTime(1,a+r),this.gain.gain.linearRampToValueAtTime(0,a+o)}}clearEffect(){this.effects=[]}addEffect(t,e,s){this.effects.length>254||this.effects.push({type:t,value:e,time:s})}playEffect(t){if(this._init(),this.initializedFully){var e=this.audioCtx.currentTime;this.gain.gain.cancelScheduledValues(e),this.frequency.cancelScheduledValues(e),e+=1e-6;for(var s=0;s<this.effects.length;s++){var i=this.effects[s];i.type==this.VLR?this.gain.gain.linearRampToValueAtTime(i.value,e+i.time/1e3):i.type==this.FLR?this.frequency.linearRampToValueAtTime(i.value+t,e+i.time/1e3):i.type==this.VS?this.gain.gain.setValueAtTime(i.value,e+i.time/1e3):i.type==this.FS&&this.frequency.setValueAtTime(i.value+t,e+i.time/1e3)}}}setAttackDecayRelease(t,e,s){this.attackT=t,this.decayT=e,this.releaseT=s}setSustainLevel(t){this.sustainV=t}playSound(t,e){var s=this.audioCtx.currentTime;if(this._init(),this.initializedFully){var i=this.attackT/1e3,r=this.attackT/1e3+this.decayT/1e3,o=this.attackT/1e3+this.decayT/1e3+e/1e3,a=this.attackT/1e3+this.decayT/1e3+e/1e3+this.releaseT/1e3;this.frequency.cancelScheduledValues(s),this.gain.gain.cancelScheduledValues(s),this.frequency.setValueAtTime(t,s),this.gain.gain.linearRampToValueAtTime(1,s+i),this.gain.gain.linearRampToValueAtTime(this.sustainV,s+r),this.gain.gain.linearRampToValueAtTime(this.sustainV,s+o),this.gain.gain.linearRampToValueAtTime(0,s+a)}}setFrequency(t){var e=this.audioCtx.currentTime;this.frequency.cancelScheduledValues(e),this.frequency.setValueAtTime(t,e)}startSound(t){if(this._init(),this.initializedFully){var e=this.attackT/1e3,s=this.attackT/1e3+this.decayT/1e3;this.frequency.cancelScheduledValues(i),this.frequency.setValueAtTime(t,i);var i=this.audioCtx.currentTime;this.gain.gain.cancelScheduledValues(i),this.gain.gain.linearRampToValueAtTime(1,i+e),this.gain.gain.linearRampToValueAtTime(this.sustainV,i+s)}}releaseSound(t){if(this._init(),this.initializedFully){var e=this.releaseT/1e3;this.frequency.value=t;var s=this.audioCtx.currentTime;this.gain.gain.cancelScheduledValues(s),this.gain.gain.linearRampToValueAtTime(0,s+e)}}}class e{constructor(t){this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.masterVolume={value:.8},this.channels=[],this.defaults=["square","sawtooth","triangle","sine","noise","square","sawtooth","triangle"],this.masterGain=this.audioCtx.createGain(),this.masterGain.connect(this.audioCtx.destination),this.masterGain.gain.value=0,this.channelCount=8;for(var e=0;e<this.channelCount;e++)this.channels.push(new t(this.audioCtx,this.defaults[e],this.masterGain,this._int_v2g));this.FLR=10,this.FS=11,this.VLR=20,this.VS=21}_int_log10(t){return Math.log(t)/Math.LN10}_int_v2g(t){var e=-Math.log(1-.9*t)/Math.LN10;return console.log(t,"->",e),e}reset(){for(var t=0;t<this.channelCount;t++)this.channels[t].setVolume(0),this.channels[t].clearEffect()}setVolume(t){this.masterGain.gain.value=this._int_v2g(t)}channelVolume(t,e){this.channels[t].setVolume(e)}channelFrequency(t,e){this.channels[t].setFrequency(e)}channelSetAttackDecayRelease(t,e,s,i){if(t<0||t>7)throw"MrBeep:no such channel "+t;this.channels[t].setAttackDecayRelease(e,s,i)}channelSetSustainLevel(t,e){if(t<0||t>7)throw"MrBeep:no such channel "+t;this.channels[t].setSustainLevel(e)}playBeep(t,e,s){if(t<0||t>7)throw"MrBeep:no such channel "+t;this.channels[t].playBeep(e,s)}playSound(t,e,s){if(t<0||t>7)throw"MrBeep:no such channel "+t;this.channels[t].playSound(e,s)}startSound(t,e){if(t<0||t>7)throw"MrBeep:no such channel "+t;this.channels[t].startSound(e)}releaseSound(t,e){if(t<0||t>7)throw"MrBeep:no such channel "+t;this.channels[t].releaseSound(e)}addEffect(t,e,s,i){this.channels[t].addEffect(e,s,i)}clearEffect(t){this.channels[t].clearEffect()}playEffect(t,e){this.channels[t].playEffect(e)}}class s{constructor(){this.options={};var t=[];t.push({opt:"file",display:"File"}),t.push({opt:"copy",display:"Copy"}),t.push({opt:"basic",display:"Basic"}),t.push({opt:"screeneditor",display:"Screen"}),t.push({opt:"help",display:"Help"}),this.options.main=t,(t=[]).push({opt:"@requestClipboardCopy",display:"Copy program"}),navigator.clipboard.readText?t.push({opt:"pasteFromClip",data:"pgm",display:"Paste program"}):t.push({opt:"pasteBox",data:"pgm",display:"Paste program"}),t.push({opt:"@requestClipboardCopyScreen",display:"Copy screen data"}),navigator.clipboard.readText?t.push({opt:"pasteFromClip",data:"txt",display:"Paste text"}):t.push({opt:"pasteBox",data:"txt",display:"Paste text"}),this.options.copy=t,(t=[]).push({opt:"@requestRun",display:"Run"}),t.push({opt:"@requestStop",display:"Stop"}),t.push({opt:"@requestList",display:"List Program"}),t.push({opt:"@requestVars",display:"Debug: List Variables"}),t.push({opt:"@requestDataBlocks",display:"Debug: List Data-blocks"}),t.push({opt:"@requestRenumber",display:"Renumber Program"}),t.push({opt:"@requestNew",display:"New Program"}),this.options.basic=t,(t=[]).push({opt:"@requestListDirectory",display:"List directory"}),t.push({opt:"@requestFileSystems",display:"List file systems"}),t.push({opt:"@requestListScripts",display:"List embedded scripts"}),t.push({opt:"@requestExport",display:"Export Basic Program"}),this.options.file=t,(t=[]).push({opt:"@requestResetConsole",display:"Reset Console"}),t.push({opt:"@requestColorReset",data:{fg:1,bg:0,border:10},display:"Dark Mode 1"}),t.push({opt:"@requestColorReset",data:{fg:14,bg:0,border:0},display:"Dark Mode 2"}),t.push({opt:"@requestColorReset",data:{fg:5,bg:0,border:10},display:"Dark Mode 3"}),t.push({opt:"@requestColorReset",data:{fg:0,bg:8,border:0},display:"Light Mode 1"}),t.push({opt:"@requestColorReset",data:{fg:0,bg:8,border:10},display:"Light Mode 2"}),t.push({opt:"@requestColorReset",data:{fg:0,bg:1,border:10},display:"Light Mode 3"}),t.push({opt:"@requestColorReset",data:{fg:15,bg:4,border:15},display:" C64 Theme"}),t.push({opt:"@requestColorReset",data:{fg:14,bg:10,border:14},display:"C128 Theme"}),t.push({opt:"@requestColorReset",data:{fg:4,bg:1,border:6},display:"Vic20 Theme"}),t.push({opt:"@requestColorReset",data:{fg:0,bg:9,border:9},display:"ZX-Spectrum Theme"}),t.push({opt:"@requestColorReset",data:{fg:1,bg:4,border:4},display:"MSX Theme"}),t.push({opt:"@requestColorReset",data:{fg:1,bg:0,border:0},display:"BBC Theme"}),t.push({opt:"@requestColorReset",data:{fg:3,bg:0,border:0},display:"Apple2 Theme"}),this.options.screeneditor=t,(t=[]).push({opt:"@requestHelp",display:"Basic Commands"}),t.push({opt:"@requestAbout",display:"About"}),this.options.help=t}getOptions(){return this.options}}class i{constructor(t){this.menuSys=t,this.sys=this.menuSys.sys}setBasic(){this.basic=this.sys.m.basic}doExposedAction(t,e){"paste"==t&&(navigator.clipboard.readText?this.handler_pasteFromClip(e):this.handler_pasteBox(e))}handler_pasteBox(t){this.menuSys.pastebox.style.display="block",this.menuSys.pasteArea.value=this.menuSys.defaultPasteText,this.oldInnerText=this.menuSys.pasteArea.innerText,this.input=this.sys.input,this.input.unsetInputHandler(),this.menuSys.clearMenu(),this.menuSys.hideMenu(),this.menuSys.pasteArea.style.color=this.menuSys.color,this.menuSys.pasteArea.style.backgroundColor=this.menuSys.bgColor,this.menuSys.pasteArea.focus(),this.menuSys.pasteArea.select(),this.sys.out.hideInner();var e=this;this.pasteHandler=function(t){setTimeout(e.pasteHandler2,10)},this.pasteHandler2=function(s){e.sys.out.showInner(),e.menuSys.unhideMenu(),e.basic.setInput(e.sys.input),e.menuSys.pasteArea.removeEventListener("paste",e.pasteHandler),e.menuSys.pastebox.style.display="none",e.oldInnerText!=e.menuSys.pasteArea.value&&e.basic.pasteTextFromClipboard(e.menuSys.pasteArea.value,t)},this.menuSys.pasteArea.addEventListener("paste",this.pasteHandler)}handler_pasteFromClip(t){var e=this;navigator.clipboard.readText||alert("Clipboard reading is disabled in your browser\nYou have to enable it to make this feature work."),navigator.clipboard.readText().then((s=>{e.basic.pasteTextFromClipboard(s,t)}))}}var r=new class{constructor(){this.fs={},this.fs.default="cache",this.display={},this.display.mode=100,this.warnings={},this.warnings.privacyMute=!0,this.subSys="S3",this.keyboard={},this.keyboard.allowDefault={};var t=this.keyboard.allowDefault;t.all=!1,t.events=[];var e=t.events;e.push("F5"),e.push("F12")}},o=new class{constructor(t,e){var s={};this.m={},s.m=this.m,s.bootCfg=t,this.sys=s,s.init={},s.staticTarget=e,s.headerElement=null,s.domContainer=document.createElement("div"),document.body.appendChild(s.domContainer),s.SIG="BOSS64",s.SUBSYS=s.bootCfg.subSys,s.VERSION="0.2",s.CODENAME="Papa Smurf",s.nulcon=[],s.nulcon.push("Starting System..."),s.nulcon.push("SYS version "+s.VERSION),s.nulcon.push("SYS name "+s.SIG+":"+s.SUBSYS+' "'+s.CODENAME+'"'),s.nulcon.push('SYS release name "'+s.CODENAME+'"'),s.nulcon.push("Starting Boot Sequence...");var i=document.getElementById("boot");this.rootScript=i,this.displayMode=parseInt(i.dataset.mode),isNaN(this.displayMode)&&(this.displayMode=t.display.mode),this.bootMode=i.dataset.boot,this.dynamicMinTarget=!1,this.bootMode&&(this.dynamicMinTarget=this.bootMode.indexOf("min")>=0),s.dynamicMinTarget=this.dynamicMinTarget,this.bootDebug=this.bootMode.indexOf("debug")>=0,this.bootDebug&&s.nulcon.push("Enabled debug mode"),this.dynamicMinTarget&&s.nulcon.push("Enabled minimal target settings for dynamic mode"),document.body.style.backgroundColor="#444444"}getSys(){return this.sys}initSimpleLogging(){var t=this.sys;t.out={buf:""};var e=t.out;t.out.getAll=function(){return e.buf},t.out.writeln=function(t){var s="$"+t+"\n";e.buf+=s,console.log(s)},e.writeln("$Init logging..."),t.rawlog=function(e,s){var i=s,r="";r+=e+": ";for(var o=0;o<i.length;o++){var a=" ";0==o&&(a=""),r+=a+i[o]}t.out.writeln(r)},t.rawlogcon=function(t,e){var s=e,i="";i+=t+": ";for(var r=0;r<s.length;r++){var o=" ";0==r&&(o=""),i+=o+s[r]}console.log(i)},t.log=function(){var e=Array.prototype.slice.call(arguments);t.rawlog("info",e),console.log.apply(console,e)},t.logwarn=function(){var e=Array.prototype.slice.call(arguments);t.rawlog("warn",e),console.warn(e)},t.logerr=function(){var e=Array.prototype.slice.call(arguments);t.rawlog("error",e),console.error.apply(console,e)},this.logerr=t.logerr,this.logwarn=t.logwarn,this.log=t.log,this.bootDebug||(t.rawlog=t.rawlogcon)}}(r,!0),a=o.getSys();function n(t,e,s){if(s>=5)throw console.log("HALT, probably dependency recursion detected"),"HALT, probably dependency recursion detected";if(console.log(" dependencies for "+t+" checkL="+s),o.dep[t]){console.log("FOUND DEPENDENCY LIST for "+t);for(var i=o.dep[t],r=0;r<i.length;r++)console.log(" add dependency:  "+i[r]),n(i[r],h,s+1)}for(var a=0;a<e.length;a++)if(e[a]==t)return;console.log("ADD MODULE "+t),e.push(t)}o.dep={},o.i={},o.i.displaymodes=class{constructor(t){this.initialized=!1,this.default=100,this.sys=t,this.drivers=[]}init(){this.initialized||(this.drivers.text=this.sys.m.tablecon,this.drivers.canvas=this.sys.m.canvas,this.modes=[],this.modes[0]="text:80x30:font=14",this.modes[1]="text:80x30:font=16",this.modes[2]="text:80x30:font=18",this.modes[3]="text:80x30:font=22",this.modes[4]="text:80x50:font=14",this.modes[5]="text:80x50:font=16",this.modes[6]="text:80x50:font=18",this.modes[7]="text:80x50:font=22",this.modes[8]="text:80x150:font=14",this.modes[9]="text:80x150:font=16",this.modes[10]="text:80x150:font=18",this.modes[11]="text:80x150:font=22",this.modes[100]="canvas:%95",this.modes[101]="canvas:%85",this.modes[102]="canvas:%75",this.modes[103]="canvas:%65",this.modes[104]="canvas:%45",this.modes[105]="canvas:%35",this.modes[106]="canvas:%25",this.modes[107]="canvas:%15",this.modes[110]="canvas:%%95,25",this.modes[111]="canvas:%%95,50",this.modes[120]="canvas:%%25,95",this.modes[121]="canvas:%%50,95",this.modes[200]="canvas:1024x768",this.modes[500]="canvas:800x600",this.modes[501]="canvas:640x512",this.modes[502]="canvas:640x480",this.modes[503]="canvas:640x400",this.modes[504]="canvas:320x512",this.modes[505]="canvas:320x400",this.modes[506]="canvas:320x256",this.modes[507]="canvas:320x200",this.menuCreated=!1)}getDriver(){return this.currentDriver}getMode(t){return this.init(),t?this.modes[t]:getMode(this.default)}getModes(){return this.modes}getCurrentMode(){return this.currentMode}setMode(t,e){this.init(),e&&(this.menu=e),(null==t||-1===t||Number.isNaN(t))&&this.setMode(this.default,e);var s=this.getDeviceConfig(t);if(s){var i=this.currentMode;null==i||-1===i||Number.isNaN(t)||(this.endMode(this.currentMode),this.menuCreated=!1),this.menuCreated||(this.menu.create(),this.menuCreated=!0),s.device.initMode(s.config,this.menu),this.sys.out=s.device,this.sys.out.notifyOnClick(this.sys.m.basicmenu,"onDeselect"),this.currentMode=t,this.currentDriver=s.device}}endMode(){this.init(),this.currentDriver&&(this.currentDriver.destroy(),this.menu.destroy(),this.currentMode=void 0,this.currentDriver=void 0)}getDeviceConfig(t){if(null!=t&&-1!==t&&!Number.isNaN(t)&&this.modes[t]){var e=this.modes[t].split(":");if(!(e.length<2)){var s=e[0];if(this.drivers[s])return{device:this.drivers[s],config:e.splice(1)}}}}},o.i.tablecon=class{constructor(t){this.sys=t,this.cursorOn=!1,this.cols=80,this.rows=30,this.x=0,this.y=0,this.hidden=!1,this.blinking=!0,this.reverse=!1,this.outColors={},this.fontSizeInt=18,this.fontSizeCSS=this.fontSizeInt+"px",this.fontFamily="monospace",this.htmlPalette=["#000000","#ffffff","#ee2222","#22ee22","#2222ee","#eeee22","#22eeee","#ee22ee","#aaaaaa","#777777","#444444","#FFAC1C","#5C3317","#F88379","#79F883","#8379F8"],this.outColors.txtBgColor=this.htmlPalette[0],this.outColors.txtColor=this.htmlPalette[5]}htmlColor(t){return this.htmlPalette[t]}destroy(){this.outDiv0.remove(),this.cvs=null,this.cvs2=null,this.ctx=null,this.ctx2=null,this.rowel=void 0,this.cellel=void 0,this.blinkInterval&&(clearInterval(this.blinkInterval),this.blinkInterval=void 0)}init(){}getColumCount(){return this.cols}getRowCount(){return this.rows}getDimensions(){return[this.cols,this.rows]}initMode(t,e){var s=this.sys,i=s.init.queuedMessages;s.init.inputElement=window,this.x=0,this.y=0,this.blinking=!0;var r=t[0].split("x");if(2==r.length&&(this.rows=parseInt(r[1]),this.cols=parseInt(r[0]),2==(r=t[1].split("=")).length)){this.fontSizeInt=parseInt(r[1]),this.fontSizeCSS=this.fontSizeInt+"px",this.colsPercentage=1/this.cols*100,this.outColors.txtBgColor=this.htmlPalette[4],this.outColors.txtColor=this.htmlPalette[1],this.outDiv0=document.createElement("div"),this.outDiv1=document.createElement("div"),this.outEl=document.createElement("table"),this.outEl.value="",this.outDiv0.addEventListener("copy",(t=>{var e=function(){if(document.selection&&document.selection.createRange)return document.selection.createRange().toString();if(window.getSelection){var t=window.getSelection();if(t.rangeCount>0){for(var e=t.getRangeAt(0).cloneContents().childNodes,s="",i=0;i<e.length;i++){""!=s&&(s+="\n");for(var r=e[i].childNodes,o=0;o<r.length;o++)s+=r[o].firstChild.data}return s}return""}return""}();t.clipboardData.setData("text/plain",e),t.preventDefault()})),this.table=this.outEl,this.table.style.borderCollapse="collapse",this.table.style.borderSpacing=0,this.table.style.backgroundColor=this.outColors.txtBgColor,this.table.style.resize="none",this.table.style.fontFamily=this.fontFamily,this.table.style.fontSize=this.fontSizeCSS,this.table.style.tableLayout="fixed",this.table.readOnly=!0,this.table.textAlign="center",this.rowel=[],this.cellel=[];for(var o=0;o<this.rows;o++){var a=document.createElement("tr");a.style.padding="0px",a.style.maxHeight=this.fontSizeInt,a.style.height=this.fontSizeInt,this.rowel.push(a),this.outEl.appendChild(a);for(var n=[],l=0;l<this.cols;l++){var h=document.createElement("td");h.style.padding="0px",h.style.color=this.outColors.txtColor,h.style.backgroundColor=void 0,h.style.textOverflow="",h.style.whiteSpace="nowrap",h.style.overflow="hidden",h.style.maxWidth=this.fontSizeInt,h.style.maxHeight=this.fontSizeInt,h.style.height=this.fontSizeInt,h.innerHTML="&nbsp;",n.push(h),a.appendChild(h)}this.cellel.push(n)}document.body.appendChild(this.outDiv0),this.outDiv0.style.display="table",this.outDiv0.style.width="99%",this.outDiv0.style.height="99%",this.outDiv0.style.position="absolute",this.outDiv0.style.zIndex="10000",this.outDiv1.style.display="table-cell",this.outDiv1.style.verticalAlign="middle",this.table.style.marginLeft="auto",this.table.style.marginRight="auto",this.outDiv0.appendChild(this.outDiv1),e&&(this.headerElementManager=e,this.outDiv1.appendChild(this.headerElementManager.get()),this.headerElementManager.enable()),this.outDiv1.appendChild(this.outEl),e&&this.headerElementManager.setDimensions(this.outEl.clientWidth,480),this.outEl.focus(),this.dirty=!0,this.dirtyFlags={bg:!0,color:!0};var c=this;this.blinkInterval=setInterval((function(){c._int_blink()}),500);for(var d=0;d<i.length;d++)this.writeln(i[d]);this.sys.log("TBCON Ready.")}}native(t){throw"@Operation "+t.action+" not supported on TABLECON"}blinkMode(t){this.blinking=t}notifyOnClick(){}hasPixels(){return!1}_int_updateArea(t,e,s,i,r){for(var o=e;o<=i;o++)for(var a=s;a<=r;a++){var n=this.cellel[a][o],l=t[a-s][o-e];" "==l.txt?n.innerHTML="&nbsp;":n.textContent=l.txt,n.style.color=this.htmlPalette[l.fg],n.style.backgroundColor=this.htmlPalette[l.bg]}}update(t,e){this._int_blinkOff(),this.show(),this.x=t.cx,this.y=t.cy,(this.x<0||this.y<0||this.x>=this.cols||this.y>=this.rows)&&console.log("ouch"),this.outColors.txtBgColor=this.htmlPalette[t.bg],this.outColors.txtColor=this.htmlPalette[t.fg];for(var s=0;s<e.length;s++){var i=e[s];this._int_updateArea(i.cells,i.x1,i.y1,i.x2,i.y2)}}updateAll(t,e){this._int_blinkOff(),this.show(),this.x=t.cx,this.y=t.cy,(this.x<0||this.y<0||this.x>=this.cols||this.y>=this.rows)&&console.log("ouch"),this.outColors.txtBgColor=this.htmlPalette[t.bg],this.outColors.txtColor=this.htmlPalette[t.fg],this._int_updateArea(e,0,0,this.cols-1,this.rows-1)}hide(){this.hidden||(this.outDiv0.hidden=!0,this.hidden=!0)}show(){this.hidden&&(this.outDiv0.hidden=!1,this.hidden=!1)}getElement(){return null}_int_blinkOff(){if(this.cursorOn){this.cursorOn=!1;var t=this.cellel[this.y][this.x];null!=t?(t.style.color=this.outColors.txtColor,t.style.backgroundColor=this.outColors.txtBgColor):console.log("cell at "+this.x+","+this.y+" == null ")}}_int_blink(){if(this.blinking){var t;try{t=this.cellel[this.y][this.x]}catch{t=null}null!=t?(this.cursorOn=!this.cursorOn,this.cursorOn?(t.style.backgroundColor=this.outColors.txtColor,t.style.color=this.outColors.txtBgColor):(t.style.color=this.outColors.txtColor,t.style.backgroundColor=this.outColors.txtBgColor)):console.log("Blink exception: Cell at "+this.x+","+this.y+" == null ")}}clear(){this._int_blinkOff(),this.show();for(var t=0;t<this.cols;t++)for(var e=0;e<this.rows;e++){var s=this.cellel[e][t];s.innerHTML="&nbsp;",s.style.color=this.outColors.txtColor,s.style.backgroundColor=this.outColors.txtBgColor}this.x=0,this.y=0}__int_nl(){this.x=0,this.y++,this.y>=this.rows&&(this.__int_scrollDown(),this.y=this.rows-1)}writeln(t){this._int_blinkOff(),this.show();for(var e=0;e<t.length;e++){var s=t.substr(e,1);this.__int_write_direct_ch(s)}this.__int_nl()}__int_write_direct_ch(t){var e=this.cellel[this.y][this.x];null!=e?(e.innerHTML=" "==t?"&nbsp":t,this.reverse?(e.style.backgroundColor=this.outColors.txtColor,e.style.color=this.outColors.txtBgColor):(e.style.color=this.outColors.txtColor,e.style.backgroundColor=void 0),this.x++,this.x>=this.cols&&(this.x=0,this.__int_nl())):console.log("cell at "+this.x+","+this.y+" == null ")}__int_scrollDown(){for(var t=0;t<this.cols;t++)for(var e=0;e<this.rows-1;e++){var s=this.cellel[e][t],i=this.cellel[e+1][t];s.textContent=i.textContent,s.style.color=i.style.color,s.style.backgroundColor=i.style.backgroundColor}var r=this.rows-1;for(t=0;t<this.cols;t++)(s=this.cellel[r][t]).innerHTML="&nbsp;",this.reverse?(s.style.backgroundColor=this.outColors.txtColor,s.style.color="rgba(0,255,0,0.0)"):(s.style.color=this.outColors.txtColor,s.style.backgroundColor=void 0)}},o.i.canvas=class{constructor(t){this.sys=t,this.cursorOn=!1,this.hidden=!1,this.blinking=!0,this.reverse=!1,this.cursorMode="insert",this.colors={},this.palette=["#000000","#ffffff","#ee2222","#22aa22","#1111cc","#eeee22","#22eeee","#ee22ee","#bbbbbb","#777777","#444444","#FFAC1C","#5C3317","#F88379","#79F883","#8379F8"];for(var e=function(t){for(var e=t;e.length<2;)e="0"+e;return e},s=this.palette.length,i=0;i<s;i++){var r=this.palette[i],o="#"+(a=e(Math.floor(parseInt(r.substr(1,2),16)/2).toString(16)))+(n=e(Math.floor(parseInt(r.substr(3,2),16)/2).toString(16)))+(l=e(Math.floor(parseInt(r.substr(5,2),16)/2).toString(16)));this.palette.push(o)}for(this.bmPalette=[],i=0;i<this.palette.length;i++){r=this.palette[i];var a=parseInt(r.substr(1,2),16),n=parseInt(r.substr(3,2),16),l=parseInt(r.substr(5,2),16);this.bmPalette.push({r:a,g:n,b:l})}this.defaultTextMode()}htmlColor(t){return this.palette[t]}destroy(){this.outDiv0.remove(),this.cvs=null,this.cvs2=null,this.cvsCursor=null,this.ctx=null,this.ctx2=null,this.ctxCursor=null,this.cache=null,this.cells=[],this.blinkInterval&&(clearInterval(this.blinkInterval),this.blinkInterval=void 0)}defaultTextMode(){this.cols=80,this.rows=30,this.x=0,this.y=0,this.fontSize="20",this.fontSizeCSS=this.fontSize+"px",this.fontSizeIntW=12,this.fontSizeIntH=parseInt(this.fontSize),this.fontFamily="monospace";var t=this.colors;t.bg=0,t.fg=5,this.colors.bgHTML=this.palette[t.bg],this.colors.fgHTML=this.palette[t.fg]}init(){}initMode(t,e){var s,i,r=this.sys,o=r.init.queuedMessages;if(this.cursorOn=!1,this.blinking=!0,this.reverse=!1,t[0].indexOf("x")>0){var a=t[0].split("x");s=parseInt(a[0]),i=parseInt(a[1])}else{var n=window.innerWidth,l=window.innerHeight;if(t[0].startsWith("%%")){var h=t[0].substr(2).split(","),c=h[0]/100,d=h[1]/100;s=Math.floor(n*c),i=Math.floor(l*d)}else if(t[0].startsWith("%")){var u=t[0].substr(1);u/=100,s=Math.floor(n*u),i=Math.floor(l*u)}}this.cols=Math.floor(s/this.fontSizeIntW),this.rows=Math.floor(i/this.fontSizeIntH),s=this.cols*this.fontSizeIntW,i=this.rows*this.fontSizeIntH;var p=this.fontSizeIntW,g=this.fontSizeIntH;this.width=s,this.height=i,console.log("Reinit with ",s,i),console.log(" colsXrows ",this.cols,this.rows),this.x=0,this.y=0,this.blinking=!0;var f=this.colors;f.bg=0,f.fg=5,f.bgHTML=this.palette[f.bg],f.fgHTML=this.palette[f.fg],r.init.inputElement=document.body,this.outDiv0=document.createElement("div"),this.outDiv1=document.createElement("div"),this.center=document.createElement("center"),this.cvs=document.createElement("canvas"),this.ctx=this.cvs.getContext("2d",{alpha:!1}),this.ctx.strokeStyle="#ffffff",this.cX=0,this.cY=0,this.cvs2=document.createElement("canvas"),this.ctx2=this.cvs2.getContext("2d"),this.cvsCursor=document.createElement("canvas"),this.ctxCursor=this.cvsCursor.getContext("2d"),this.cache=[],this.updCtxImageData={synched:!1},this.cvs.width=s,this.cvs.height=i,this.cvs2.width=s,this.cvs2.height=i,this.cvsCursor.width=p,this.cvsCursor.height=g,this.offsets=[];var m=this.ctx;m.font=this.fontSizeCSS+" "+this.fontFamily,m.textBaseline="bottom";var y=this.fontSizeIntW/2;for(const t of"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890@+_!#%&/()=?*-:;,.'\""){var v=y-this.ctx.measureText(t).width/2;(a=Math.floor(v))<0&&(a=0),this.offsets[t]=a}this.oIndicatorChar="â–•",this.oIndicatorSize=this.ctx.measureText(this.oIndicatorChar),this.oIndicatorOffset=Math.floor(y-this.oIndicatorSize.width/2),this.cells=[];for(var b=this.colors,x=0;x<this.rows;x++){for(var S=[],k=0;k<this.cols;k++)S.push({txt:" ",fg:b.fg,bg:b.bg});this.cells.push(S)}document.body.appendChild(this.outDiv0),this.outDiv0.style.display="table",this.outDiv0.style.width="99%",this.outDiv0.style.height="99%",this.outDiv0.style.position="absolute",this.outDiv0.style.zIndex="10000",this.outDiv1.style.display="table-cell",this.outDiv1.style.verticalAlign="middle",this.cvs.style.marginLeft="auto",this.cvs.style.marginRight="auto",this.outDiv0.appendChild(this.outDiv1),this.outDiv1.appendChild(this.center),e&&(this.headerElementManager=e,this.center.appendChild(this.headerElementManager.get()),this.headerElementManager.setDimensions(s,i),this.headerElementManager.enable()),this.center.appendChild(this.cvs),this.cvs.focus();var C=this;this.blinkInterval=setInterval((function(){C._int_blink()}),300);for(var w=0;w<o.length;w++)this.writeln(o[w]);this.clear(),this.sys.log("CANVASCON Ready.")}notifyOnClick(t,e){this.cvs.addEventListener("click",(function(){t[e]()}))}hideInner(){this.cvs.hidden=!0}showInner(){this.cvs.hidden=!1}hide(){this.init(),this.hidden||(this.outDiv0.hidden=!0,this.hidden=!0)}show(){this.init(),this.hidden&&(this.outDiv0.hidden=!1,this.hidden=!1)}getElement(){return null}blinkMode(t){this.blinking=t}_int_blinkOff(){if(this.cursorOn){var t=this.fontSizeIntW,e=this.fontSizeIntH,s=t*this.x,i=e*this.y;this.ctx,this.ctx.drawImage(this.cvsCursor,s,i),this.cursorOn=!1}}_int_storeset_color(t,e){this.oldfg=t,this.oldbg=e;var s=this.colors;s.fg=t,s.bg=e,s.fgHTML=this.palette[s.fg],s.bgHTML=this.palette[s.bg]}_int_restore_color(){var t=this.colors;t.fg=this.oldfg,t.bg=this.oldbg,t.fgHTML=this.palette[t.fg],t.bgHTML=this.palette[t.bg]}_int_blink(){if(this.blinking){this.cursorOn,this.cursorOn=!this.cursorOn;var t=this.fontSizeIntW,e=this.fontSizeIntH,s=t*this.x,i=e*this.y,r=(this.colors,this.ctx,this.cells[this.y][this.x]);if(this.cursorOn){this.ctxCursor.drawImage(this.cvs,s,i,t,e,0,0,t,e),this.colors.fgHTML;var o=this.colors.fg,a=this.colors.bg;return r.fg==r.bg?0==r.fg?(o=1,a=0):(o=0,a=1):(o=r.fg,a=r.bg),void this.paintCursor(s,i,r.txt,o,a,"overwrite"==this.cursorMode)}this.ctx.drawImage(this.cvsCursor,s,i)}}_int_updateArea(t,e,s,i,r){this.ctx;var o,a,n=this.fontSizeIntW,l=this.fontSizeIntH,h=this.colors;try{for(a=s;a<=r;a++){var c=l*a,d=e*n;for(o=e;o<=i;o++){var u=this.cells[a][o],p=t[a-s][o-e],g=p.txt;h.bg=p.bg,h.fg=p.fg,h.bgHTML=this.palette[p.bg],h.fgHTML=this.palette[p.fg],u.txt=g,u.fg=p.fg,u.bg=p.bg,this._int_paintchar(d,c,g),d+=n}}}catch(t){console.log("x= "+o+" y= "+a),console.log("x0=",e,"y0=",s,"x1=",i,"y1=",r),console.log(t)}}paintCursor(t,e,s,i,r,o){this._int_storeset_color(r,i),this._int_paintchar(t,e,s),o&&this._int_drawIndicator(t,e,s),this._int_restore_color()}_int_drawIndicator(t,e,s){var i=this.ctx;i.font=this.fontSizeCSS+" "+this.fontFamily,i.textBaseline="top",i.fillStyle=this.colors.fgHTML,i.fillRect(t,e+4*this.fontSizeIntH/5,this.fontSizeIntW,this.fontSizeIntH/5)}_int_paintchar(t,e,s){this.updCtxImageData.synched=!1;var i=this.colors,r=s+":"+i.bg+":"+i.fg,o=this.cache[r],a=this.fontSizeIntW,n=this.fontSizeIntH;if(!o){var l=document.createElement("canvas"),h=l.getContext("2d",{alpha:!1});if(s.charCodeAt(0)>255){var c=this.ctx.measureText(s),d=Math.floor(c.width);d>a&&(a=d)}l.width=a,l.height=n,h.font=this.fontSizeCSS+" "+this.fontFamily,h.textBaseline="top";var u=0;this.offsets[s]&&(u=this.offsets[s]),h.fillStyle=this.colors.bgHTML,h.fillRect(0,0,a,n),h.fillStyle=this.colors.fgHTML,h.fillText(s,u,0),this.cache[r]={ctx:h,cvs:l,w:a},o=this.cache[r]}this.ctx.drawImage(o.cvs,t,e)}op_gcolor(t){var e=this.palette[t.c];this.ctx.strokeStyle=e}op_line(t){this.updCtxImageData.synched=!1;var e=this.ctx,s=t.x0,i=t.y0;s<0&&(s=this.cX),i<0&&(i=this.cY),e.beginPath(),e.moveTo(s,i),e.lineTo(t.x1,t.y1),e.stroke(),this.cX=t.x1,this.cY=t.y1}native(t){this["op_"+t.action](t.params)}gfxUpdate(t){var e=4*this.width,s=t.pixels,i=this.ctx,r=this.updCtxImageData;r.synched||(r.imd=i.getImageData(0,0,this.width,this.height),r.data=r.imd.data,r.synched=!0);for(var o=r.data,a=r.imd,n=0;n<s.length;n++){var l=s[n],h=l.x,c=l.y*e+4*h,d=this.bmPalette[l.c];o[c+0]=d.r,o[c+1]=d.g,o[c+2]=d.b}i.putImageData(a,0,0)}update(t,e){this._int_blinkOff(),this.show(),this.x=t.cx,this.y=t.cy,(this.x<0||this.y<0||this.x>=this.cols||this.y>=this.rows)&&console.log("ouch"),this.colors.bgHTML=this.palette[t.bg],this.colors.fgHTML=this.palette[t.fg],this.colors.bg=t.bg,this.colors.fg=t.fg,this.cursorMode=t.cursorMode;for(var s=0;s<e.length;s++){var i=e[s];this._int_updateArea(i.cells,i.x1,i.y1,i.x2,i.y2)}}updateAll(t,e){this._int_blinkOff(),this.show(),this.x=t.cx,this.y=t.cy,(this.x<0||this.y<0||this.x>=this.cols||this.y>=this.rows)&&console.log("ouch"),this.colors.bgHTML=this.palette[t.bg],this.colors.fgHTML=this.palette[t.fg],this.colors.bg=t.bg,this.colors.fg=t.fg,this.cursorMode=t.cursorMode,this._int_updateArea(e,0,0,this.cols-1,this.rows-1)}clear(){this._int_blinkOff(),this.show();for(var t=0,e=0;e<this.cols;e++){t=1-t;for(var s=0;s<this.rows;s++)this.cells[s][e].txt=" ",this.cells[s][e].fg=this.colors.fg,this.cells[s][e].bg=this.colors.bg}this.ctx.fillStyle=this.colors.bg,this.ctx.fillRect(0,0,this.cvs.width,this.cvs.height),this.x=0,this.y=0}__int_nl(){this.x=0,this.y++,this.y>=this.rows&&(this.__int_scrollDown(),this.y=this.rows-1)}writeln(t){this._int_blinkOff(),this.show();for(const e of t)this.__int_write_direct_ch(e);this.__int_nl()}__int_write_direct_ch(t){var e=this.cells[this.y][this.x];if(null!=e){e=t.txt;var s=this.ctx,i=this.fontSizeIntW,r=this.fontSizeIntH,o=0;this.offsets[t.txt]&&(o=this.offsets[t.txt]),this.ctx.fillStyle=this.colors.bgHTML,s.fillRect(i*this.x,r*this.y,i,r),s.fillStyle=this.colors.fgHTML,s.fillText(t.txt,o+i*this.x,r*(this.y+1)),this.x++,this.x>=this.cols&&(this.x=0,this.__int_nl())}else console.log("cell at "+this.x+","+this.y+" == null ")}getDimensions(){return[this.cols,this.rows]}hasPixels(){return!0}getBitmapDimensions(){return[this.width,this.height]}getColumCount(){return this.cols}getRowCount(){return this.rows}__int_scrollDown(){for(var t=0;t<this.cols;t++)for(var e=0;e<this.rows-1;e++)this.cells[e][t],this.cells[e+1][t];var s=this.rows-1;for(t=0;t<this.cols;t++)this.cells[s][t].txt=" ";this.fontSizeIntW;var i=this.fontSizeIntW;this.ctx2.drawImage(this.cvs,0,0);var r=this.cvs2.width,o=this.cvs2.height-i;this.ctx.fillStyle=this.colors.bg,this.ctx.fillRect(0,0,this.cvs.width,this.cvs.height),this.ctx.drawImage(this.cvs2,0,i,r,o-i,0,0,r,o-i)}},o.i.mrbeepaudio=class{constructor(t){this.sys=t}destroy(){}init(){this.mrBeep=new e(t)}reset(){this.mrBeep.reset()}setVolume(t){this.mrBeep.setVolume(t)}channelVolume(t,e){this.mrBeep.channelVolume(t,e)}channelFrequency(t,e){this.mrBeep.channelFrequency(t,e)}channelSetAttackDecayRelease(t,e,s,i){this.mrBeep.channelSetAttackDecayRelease(t,e,s,i)}channelSetSustainLevel(t,e){this.mrBeep.channelSetSustainLevel(t,e)}playBeep(t,e,s){this.mrBeep.playBeep(t,e,s)}playSound(t,e,s){this.mrBeep.playSound(t,e,s)}startSound(t,e){this.mrBeep.startSound(t,e)}releaseSound(t,e){this.mrBeep.releaseSound(t,e)}addEffect(t,e,s,i){this.mrBeep.addEffect(t,e,s,i)}clearEffect(t){this.mrBeep.clearEffect(t)}playEffect(t,e){this.mrBeep.playEffect(t,e)}},o.i.simplewarning=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.key=t.SIG+"__LSConfirmed",this.warningOngoing=!1,console.log("simplewarning initialized"),t.notify=this}init(){}simpleWarning(){if(!this.warningOngoing){this.oldBGColor=document.body.style.backgroundColor,document.body.style.backgroundColor="#ffffff";var t=this;setTimeout((function(){document.body.style.backgroundColor=t.oldBGColor,t.warningOngoing=!1}),200)}}},o.i.priv=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.disable=t.bootCfg.warnings.privacyMute,this.key=t.SIG+"__LSConfirmed",this.verified=!1,this.denied=!1,console.log("PrivWarning initialized")}init(){}confirmLocalStorage(){return!(this.denied||"true"!=localStorage.getItem(this.key)&&!this.disable&&(confirm("!! Do you allow "+this.sys.SIG+" to write to local browser storage !!\nThis is needed to simulate a local harddisk.\n If you do not agree, you can still use the system,\n but you won't be able to save any files, or session information.\n\nAll information will only be stored on the local storage,\n and will not be shared with any server, unless you will give explicit permission.\n\nThank you!")?(localStorage.setItem(this.key,"true"),0):(this.denied=!0,1)))}},o.i.mutedinput=class{constructor(t){}init(){}getKey(){return null}setInputHandler(t,e){}},o.i.domelinput=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.evtQueueKeyPress=[],this.handler=null,this.prefix="",this.cfg=t.bootCfg.keyboard}init(){this.init.inputElement,this.target=window}getKey(){return this.handler||0==this.evtQueueKeyPress.length?null:this.evtQueueKeyPress.shift()}unsetInputHandler(){this.elFun&&(this.target.removeEventListener("keydown",this.elFun),this.elFun=null)}checkIfAllowDefault(t){var e=this.cfg.allowDefault;if(!e)return!0;if(e.all)return!0;for(var s=e.events,i=0;i<s.length;i++)if(s[i]==t.key)return!0;return!1}setInputHandler(t,e){this.handler=t,this.prefix=e,this.elFun&&(this.target.removeEventListener("keydown",this.elFun),this.elFun=null);var s=this.evtQueueKeyPress,i=(this.sys.out,this.handler),r=(e=this.prefix,this),o=function(t){var o={type:"keydown",key:t.key,keyLabel:t.key,shiftKey:t.shiftKey,ctrlKey:t.ctrlKey};t.key.length>1&&(o.key=null,o.keyLabel=t.key,"Enter"==t.key&&(o.key="\n")),r.checkIfAllowDefault(t)||t.preventDefault(),i?i[e+"KeyHandler"](o):s.push(o)};this.elFun=o,this.target.inputMode="text",this.target.addEventListener("keydown",o)}},o.i.htmlwrapper=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.node=document.body,document.body.id="top",this.isAttr=!1}init(){}executeFunction(t){"body.style.backgroundImage"==t[0]&&(document.body.style.backgroundImage="url('"+t[1]+"')",document.body.style.backgroundSize="cover")}execute(t){var e=t[0];console.log("execute",e);var s=e.htmlHandle;if(s?this.setnode(s):this.isAttr=!1,null!=this.node)if(0==this.isAttr)if(e.htmlAppend){var i=document.createElement("span");i.innerHTML=e.htmlValue;const t=i.childNodes;var r=[];for(let e=0;e<t.length;e++)r.push(t[e]);for(let t=0;t<r.length;t++)this.node.appendChild(r[t]);i=null}else{if("top"==this.node.id)return void console.log("Cannot replace body code. it would crash the console!");this.node.innerHTML=e.htmlValue}else{var o=this.node.attributes.getNamedItem(this.attrName);if(null==o)return void console.log("Attr '"+this.attrName+"' not found on html node "+this.node.id+"!");o=o.nodeValue,e.htmlAppend?o+=e.htmlValue:o=e.htmlValue,this.node.setAttribute(this.attrName,o)}else console.log("invalid html root")}setnode(t){if(console.log("setnode",t),this.isAttr=!1,".."==t)this.node=this.node.parentNode;else{var e=t.split("."),s=null,i=null;if(e.length>1?(i=e[0],s=e[1]):i=t,""!=i){var r=document.getElementById(i);if(!r)return void console.log("could not find",t);this.node=r}""!=s&&null!=s&&(this.isAttr=!0,this.attrName=s)}}},o.i.basic=class{constructor(t){this.apps=[],this.sys=t,this.audioInitFlag=!1}audioInit(){if(!this.audioInitFlag){var t=this.sys.audio;this.audio=t,t.channelVolume(0,1),t.setVolume(1),this.audioInitFlag=!0}}init(){var t=this.sys,e=t.out;this.cfg=this.sys.bootCfg,this.settings={},t.m.htmlwrapper,t.m.displaymodes,this.out=e,this.menu=t.m.basicmenu,t.staticTarget?this.worker=new Worker("basicworker.js"):t.dynamicMinTarget?this.worker=new Worker("sys/modules/basic/worker/workerbootstrap_min.js"):this.worker=new Worker("sys/modules/basic/worker/workerbootstrap_max.js"),this.sys.m.qfs.loadFile("cache://settings.cfg",{clazz:this,method:"initMore"})}initMore(t,e,s){var i=this.sys,r=i.out,o=i.audio,a=i.m.htmlwrapper,n=i.m.displaymodes,l=void 0;s.success&&(l=s.data.colors),this.worker.postMessage({type:"inittxtarea",w:r.getColumCount(),h:r.getRowCount()}),this.worker.postMessage({type:"initcolors",colors:l}),this.worker.postMessage({type:"systeminfo",modes:n.getModes(),mode:n.getCurrentMode(),windowWidth:window.innerWidth,windowHeight:window.innerHeight}),this.worker.postMessage({type:"setcfg",cfg:this.cfg});var h=[-1,-1];r.hasPixels()&&(h=r.getBitmapDimensions()),this.worker.postMessage({type:"initbitmap",w:h[0],h:h[1]});var c=this;this.worker.onmessage=function(t){var e=t.data.message,s=t.data.type;if("syslog"==s)i.log("BWSYS:",t.data.message);else if("syserr"==s)i.logerr("BWERR:",t.data.message);else if("write"==s)for(var l=0;l<e.length;l++)r.write(e[l]);else if("writeln"==s)for(l=0;l<e.length;l++)r.writeln(e[l]);else if("writec"==s)r.writec(e);else if("border"==s)document.body.style.backgroundColor=r.htmlColor(e.d);else if("audio"==s){c.audioInit();var h=e.method,d=e.parCount;1==d?o[h](e.p1):2==d?o[h](e.p1,e.p2):3==d?o[h](e.p1,e.p2,e.p3):4==d?o[h](e.p1,e.p2,e.p3,e.p4):0==d&&o[h]()}else if("blinkMode"==s)r.blinkMode(e.m);else if("signalHideMenu"==s)i.m.basicmenu&&(console.log("signalHideMenu hideFlag=",e.hide),i.m.basicmenu.showMenu(!e.hide));else if("locate"==s)r.setPos(e.c,e.r);else if("load"==s)c.loadAppFromProgram(this,e);else if("loaddata"==s)c.loadDataFromProgram(this,e);else if("save"==s)c.saveProgram(this,e);else if("delete"==s)c.deleteFile(this,e);else if("dir"==s)c.dir(e.path,e);else if("setfs"==s)c.setfs(e.path,e),c.menu.setStatus(null);else if("listfs"==s)c.listfs(e);else if("html"==s)a.execute(e);else if("htmlnode"==s)a.setnode(e[0].value);else if("htmldofun"==s)a.executeFunction(e);else if("displaymode"==s){n.setMode(e.m,c.menu),n.cursor,r=n.getDriver(),i.out=r;var u=r.getDimensions(),p=[-1,-1];r.hasPixels()&&(p=r.getBitmapDimensions()),this.postMessage({type:"message",processId:e.processId,message:"displaysize:done",messageObject:{mode:e.m,textW:u[0],textH:u[1],bitmapW:p[0],bitmapH:p[1]}})}else if("textupdate"==s){var g={cx:e.cx,cy:e.cy,fg:e.fg,bg:e.bg,cursorMode:e.cursorMode};i.out.update(g,e.areasList)}else if("textupdate-all"==s)g={cx:e.cx,cy:e.cy,fg:e.fg,bg:e.bg,cursorMode:e.cursorMode},i.out.updateAll(g,e.cells);else if("gfxupdate"==s)i.out.gfxUpdate(e);else if("export"==s)if("disk"==e.destination){var f={clazz:c,method:"nullHandler",data:""};i.m.qfs.saveFile("export://myprogram.bas",e.code,f)}else navigator.clipboard.writeText(e.code);else"nativeout"==s?i.out.native(e):"status"==s&&c.menu.setStatus(e.status)};var d=this;window.addEventListener("resize",(function(t){d.windowResizeEvent(t)}))}windowResizeEvent(t){var e=window.innerWidth,s=window.innerHeight;this.worker.postMessage({type:"interrupt",sub:"resize",data:{w:e,h:s}})}nullHandler(t){console.log("nullhandler "+t)}loadApp(t){var e=this.sys;e.log("BSYS:","Load",t),e.m.qfs.loadFile(t,{clazz:this,method:"loadedApp"})}pasteTextFromClipboard(t,e){if("txt"==e)for(var s={keyLabel:"",shiftKey:!1,ctrlKey:!1,key:"",type:"keydown"},i=0;i<t.length;i++){var r=t.charAt(i);s.key=r,10==t.charCodeAt(i)?s.keyLabel="Enter":s.keyLabel="",this.worker.postMessage(s)}else this.worker.postMessage({type:"pastpgm",data:t})}requestClipboardCopy(){this.worker.postMessage({type:"clipboardCopy"})}requestClipboardCopyScreen(){this.worker.postMessage({type:"clipboardCopyScreen"})}requestColorReset(t){this.worker.postMessage({type:"colorReset",colors:t});var e={clazz:this,method:"nullHandler",data:""};this.settings.colors=t,this.sys.fs.saveFile("cache://settings.cfg",this.settings,e)}requestExport(){this.worker.postMessage({type:"export"})}requestFileSystems(){for(var t=this.sys.fs.listFS(),e=["FS",""],s=0;s<t.length;s++){var i=t[s];e.push(i)}this.requestShowList(e)}requestListDirectory(){for(var t=this.sys.fs.getDir(this.sys.fs.getCurrent()),e=["DIR",""],s=0;s<t.files.length;s++){var i=t.files[s].fname;e.push(i)}this.requestShowList(e)}requestListScripts(){console.log("I am handler_listScripts",this);for(var t=this.sys.m.script.getDir(),e=[],s=0;s<t.files.length;s++){var i=t.files[s].fname;e.push(i)}this.requestShowList(e)}requestAbout(){this.worker.postMessage({type:"resetConsole"});var t=[];t.push(""),t.push("---------------------------"),t.push("  B3 Basic"),t.push("  Version 0.9"),t.push("  Copyright: "),t.push("    CursorKeys Retro, 2022"),t.push("---------------------------"),t.push(""),this.requestShowList(t)}requestList(){this.worker.postMessage({type:"list"})}requestRenumber(){this.worker.postMessage({type:"renumber"})}requestNew(){this.worker.postMessage({type:"new"})}requestVars(){this.worker.postMessage({type:"vars"})}requestDataBlocks(){this.worker.postMessage({type:"datablocks"})}requestHelp(){this.worker.postMessage({type:"help"})}requestClearScreen(){this.worker.postMessage({type:"clearScreen"})}requestResetConsole(){this.worker.postMessage({type:"resetConsole"})}requestShowList(t){this.worker.postMessage({type:"showList",list:t})}requestRun(){this.worker.postMessage({type:"run"})}requestStop(){this.worker.postMessage({type:"stop"})}deleteFile(t,e){var s=this.sys;try{s.log("BSYS:","delete",e.path),s.m.qfs.deleteFile(e.path,{clazz:this,method:"deletedFile",path:e.path,processId:e.processId})}catch(t){console.log(t),this.worker.postMessage({type:"message",processId:e.processId,message:"delete:error",messageObject:{reason:t.message}})}}deletedFile(t){this.sys.log("BSYS:","Deleted",t.args.qpath);var e="ok",s="delete:completed";t.result||(e="error",s="delete:error"),this.worker.postMessage({type:"message",processId:t.origCallBackRecord.processId,message:s,messageObject:{status:e,reason:void 0}})}saveProgram(t,e){var s=this.sys;try{s.log("BSYS:","Load",e.path),s.m.qfs.saveFile(e.path,e.data,{clazz:this,method:"savedProgram",processId:e.processId})}catch(t){console.log(t),this.worker.postMessage({type:"message",processId:e.processId,message:"save:error",messageObject:{reason:t.message}})}}savedProgram(t){this.sys.log("BSYS:","Saved",t.url);var e="ok";t.result||(e="error"),this.worker.postMessage({type:"message",processId:t.origCallBackRecord.processId,message:"save:completed",messageObject:{status:e}})}loadDataFromProgram(t,e){var s=this.sys;try{s.log("BSYS:","Load",e.path),s.m.qfs.loadFile(e.path,{clazz:this,method:"loadedDataFromProgram",processId:e.processId,label:e.label,type:e.type})}catch(t){console.log(t),this.worker.postMessage({type:"message",processId:e.processId,message:"loaddata:error",messageObject:{error:t.message}})}}loadAppFromProgram(t,e){var s=this.sys;try{s.log("BSYS:","Load",e.path),s.m.qfs.loadFile(e.path,{clazz:this,method:"loadedAppFromProgram",processId:e.processId})}catch(t){console.log(t),this.worker.postMessage({type:"message",processId:e.processId,message:"load:error",messageObject:{reason:t.message}})}}loadedApp(t,e,s){this.sys.log("BSYS:","Loaded",e.url),this.out.blinkMode(!1),this.worker.postMessage({type:"loadpgm",pgmData:s.data,QPath:t})}loadedDataFromProgram(t,e,s){this.sys.log("BSYS:","Loaded",e.url),s.success?this.worker.postMessage({type:"message",processId:e.processId,message:"loaddata:completed",messageObject:{data:s.data,label:e.label,type:e.type}}):this.worker.postMessage({type:"message",processId:e.processId,message:"loaddata:error",messageObject:{pgmData:null,reason:s.reason}})}loadedAppFromProgram(t,e,s){this.sys.log("BSYS:","Loaded",e.url),s.success?this.worker.postMessage({type:"message",processId:e.processId,message:"load:completed",messageObject:{pgmData:s.data}}):this.worker.postMessage({type:"message",processId:e.processId,message:"load:error",messageObject:{pgmData:null,reason:s.reason}})}listfs(t){var e=this.sys.fs.listFS();this.worker.postMessage({type:"message",processId:t.processId,message:"listfs:completed",messageObject:{fs:e,currentFs:this.sys.fs.getCurrent()}})}setfs(t,e){var s=this.sys.fs.setFS(t);s=s?"ok":"error",this.worker.postMessage({type:"message",processId:e.processId,message:"setfs:completed",messageObject:{status:s}})}dir(t,e){var s=this.sys.fs.getDir(t);this.worker.postMessage({type:"message",processId:e.processId,message:"dir:completed",messageObject:{files:s.files,title:s.title,free:s.free,fs:s.fs}})}setInput(t){this.sys.log("BSYS: Setting input on BAPPS.."),this.input=t,this.input.setInputHandler(this,"input")}inputKeyHandler(t){if(this.sys.m.basicmenu&&(this.sys.m.basicmenu.clearMenu(),"v"==t.key&&t.ctrlKey))return console.log(t),void this.sys.m.basicmenu.doAction("paste","txt");"Backspace"==t.keyLabel&&t.ctrlKey?this.worker.postMessage({type:"toggleMenu"}):this.worker.postMessage(t)}},o.i.basicmenu=class{constructor(t){this.sys=t,this.defaultPasteText="Press CTRL-V here",this.options=(new s).getOptions(),this.handlers=new i(this),this.menus={},this.statusWidgets={},this.status={pgmLen:0,status:"stopped",varLen:0,displayMode:0},this.mnuBttnOptContainers=[],this.mnuBttnOptContainersTgl=[],this.mnuBttns=[],this.mnuBttnContainers=[],this.mnuLinks=[],this.color="#ffffff",this.bgColor="#000000",this.font="16px arial,serif",this.statusTopMargin="4px",this.statusColor="#eeffff",this.statusBgColor="#000000",this.statusFont="700 14px arial,serif",this.cnt=0}destroy(){for(var t=this.getOnClickMenuButtonFunc(),e=0;e<this.mnuBttns.length;e++){var s=this.mnuBttns[e];s.dataset.i=e,this.mnuBttnOptContainers[e],t=this.getOnClickMenuButtonFunc(),s.removeEventListener("click",t);for(var i=this.mnuLinks[e],r=0;r<i.length;r++){var o=i[r];o.dataset.i=e,o.removeEventListener("click",this.getClickLinkFunc()),o.removeEventListener("mouseover",this.getOnOverLinkFunc())}}this.element=null}init(){this.handlers.setBasic(),this.basic=this.sys.m.basic}showMenu(t){this.element.style.display=t?"flex":"none"}button(t,e,s,i){var r=document.createElement("div"),o=document.createElement("button"),a=document.createElement("div");r.appendChild(o),r.appendChild(a),r.id="menu_buttnparent_"+e,o.innerHTML=s,o.id="menu_buttn_"+e,o.style.backgroundColor=this.bgColor,o.style.color=this.color,o.style.font=this.font,o.style.marginLeft="2px",o.style.marginRight="0px",o.style.borderTop="0px #ccc solid",o.style.borderBottom="0px #ccc solid",o.style.borderLeft="0px #777 solid",o.style.borderRight="0px #777 solid",a.id="menu_opts_buttn_"+e,a.style.display="none",a.style.marginLeft="2px",a.style.position="absolute",a.style.minWidth="260px",a.style.zIndex="1",a.style.backgroundColor=this.bgColor,a.style.color=this.color,a.style.borderTop="1px #ccc solid",a.style.borderBottom="1px #ccc solid",a.style.borderLeft="1px #777 solid",a.style.borderRight="1px #777 solid",this.mnuBttns.push(o),this.mnuBttnContainers.push(r),this.mnuBttnOptContainers.push(a),this.mnuBttnOptContainersTgl.push({active:!1});var n=[];if(i)for(var l=0;l<i.length;l++){var h=i[l],c=document.createElement("a");c.innerHTML=h.display,c.style.padding="12px 16px",c.style.display="block",c.style.font=this.font,c.dataset.action=h.opt,h.data&&(c.dataset.data=JSON.stringify(h.data)),n.push(c),a.appendChild(c)}this.mnuLinks.push(n),r.style.display="inline-block",r.style.position="relative",t.appendChild(r)}doAction(t,e){this.showMenu(!0),this.handlers.doExposedAction(t,e)}statusItem(t,e){var s=document.createElement("div");return s.innerText=e,""==e?s.style.width="10px":" "==e&&(s.style.width="50px"),s.style.marginTop=this.statusTopMargin,s.style.color=this.statusColor,s.style.backgroundColor=this.statusBgColor,s.style.font=this.statusFont,t.appendChild(s),this.statusWidgets.list.push(s),s}statusItems(t){this.statusWidgets.list=[],this.statusItem(t," "),this.statusWidgets.displayMode=this.statusItem(t,"MODE: "+this.status.displayMode),this.statusItem(t,""),this.statusWidgets.fs=this.statusItem(t,"FS: "+this.sys.fs.getCurrent()),this.statusItem(t,""),this.statusWidgets.pgmLen=this.statusItem(t,"LINES: "+this.status.pgmLen),this.statusItem(t,""),this.statusWidgets.varLen=this.statusItem(t,"VARCOUNT: "+this.status.varLen),this.statusItem(t,""),this.statusWidgets.interpreterStatus=this.statusItem(t,"STATUS: "+this.status.status)}setStatus(t){this.statusWidgets.fs.innerText="FS: "+this.sys.fs.getCurrent(),t&&(this.status=t,this.statusWidgets.interpreterStatus.innerText="STATUS: "+this.status.status,this.statusWidgets.pgmLen.innerText="LINES: "+this.status.pgmLen,this.statusWidgets.varLen.innerText="VARCOUNT: "+this.status.varLen,this.statusWidgets.displayMode.innerText="MODE: "+this.status.displayMode)}buttons(t){for(var e=this.options.main,s=0;s<e.length;s++){var i=e[s];this.button(t,s,i.display,this.options[i.opt])}}onDeselect(){"none"!=this.element.style.display&&this.clearMenu()}styleButtons(t){t.style.backgroundColor="black",t.style.color="white",t.style.width="100%"}create(){this.element=document.createElement("div"),this.element.style.marginLeft="auto",this.element.style.marginRight="auto",this.element.style.display="none",this.element.style.backgroundColor=this.statusBgColor,this.element.style.paddingBottom="5px",this.element.style.paddingTop="5px",this.buttons(this.element),this.statusItems(this.element);var t=document.createElement("div");this.pastebox=t,t.style.display="none",t.style.width="100%";var e=document.createElement("textarea");this.pasteArea=e,e.style.width="100%",e.style.height="200px",this.element.appendChild(t),t.appendChild(e)}get(){return this.element}getClickLinkFunc(){var t=this;return function(){console.log(this.dataset.action);for(var e=0;e<t.mnuBttnOptContainers.length;e++){var s=t.mnuBttnOptContainers[e],i=t.mnuBttnOptContainersTgl[e];console.log("dsp["+e+"]",s),s.style.display="none",i.active=!1}var r=void 0;"string"==(typeof this.dataset.data).toLowerCase()&&(r=JSON.parse(this.dataset.data)),this.dataset.action.startsWith("@")?t.basic[this.dataset.action.substr(1)](r):t.handlers["handler_"+this.dataset.action](r)}}getOnOverLinkFunc(){var t=this;return function(){for(var e=t.mnuLinks[this.dataset.i],s=0;s<e.length;s++){var i=e[s];i.style.color=t.color,i.style.backgroundColor=t.bgColor}this.style.color=t.bgColor,this.style.backgroundColor=t.color}}getOnClickMenuButtonFunc(){var t=this;return function(){for(var e=this.dataset.i,s=t.mnuBttnOptContainersTgl[e].active,i=0;i<t.mnuBttnOptContainers.length;i++){var r=t.mnuBttnOptContainers[i],o=t.mnuBttnOptContainersTgl[i];console.log("dsp["+i+"]",r),r.style.display="none",o.active=!1}for(i=0;i<t.mnuBttnOptContainers.length;i++)r=t.mnuBttnOptContainers[i],console.log("dsp["+i+"]",r.style.display);for(var a=t.mnuLinks[e],n=0;n<a.length;n++){var l=a[n];l.style.color=t.color,l.style.backgroundColor=t.bgColor}var h=t.mnuBttnOptContainers[e];console.log(s),s?(t.mnuBttnOptContainersTgl[e].active=!1,h.style.display="none"):(t.mnuBttnOptContainersTgl[e].active=!0,h.style.display="block")}}enable(){for(var t=0;t<this.mnuBttns.length;t++){var e=this.mnuBttns[t];e.dataset.i=t,this.mnuBttnOptContainers[t];var s=this.getOnClickMenuButtonFunc();e.addEventListener("click",s);for(var i=this.mnuLinks[t],r=0;r<i.length;r++){var o=i[r];o.dataset.i=t,o.addEventListener("click",this.getClickLinkFunc()),o.addEventListener("mouseover",this.getOnOverLinkFunc())}}}setDimensions(t,e){this.element.style.width=t+"px",this.element.style.textAlign="left"}clearMenu(){for(var t=0;t<this.mnuBttnOptContainers.length;t++){var e=this.mnuBttnOptContainersTgl[t];e.active&&(this.mnuBttnOptContainers[t].style.display="none",e.active=!1)}}hideMenu(){for(var t=0;t<this.mnuBttnContainers.length;t++)this.mnuBttnContainers[t].style.display="none";var e=this.statusWidgets.list;for(t=0;t<e.length;t++)e[t].style.display="none"}unhideMenu(){for(var t=0;t<this.mnuBttnContainers.length;t++)this.mnuBttnContainers[t].style.display="block";var e=this.statusWidgets.list;for(t=0;t<e.length;t++)e[t].style.display="block"}},o.i.sfs=class{constructor(t){if(!t)throw"sys expected";this.initialized=!1,this.sys=t,this.prefix=t.SIG+t.SUBSYS+"__"}init(){this.initialize()}initialize(){this.currentDisk="SYS",this.initialized=!0,this.privacy=this.sys.m.priv}ready(){return this.initialized}getEmptyDirStructure(t){return{files:[],title:"temporary session"}}getDir(t,e){if(!this.initialized)return getEmptyDirStructure(null);var s=this.prefix+""+this.currentDisk+"_dir",i=sessionStorage.getItem(s);if(!i)return{files:[],title:"temporary session"};var r=JSON.parse(i);if(!r)return{files:[],title:"temporary session"};var o=r.title;r.title=o,r.free=32-r.files.length;for(var a=-1;;){for(var n=0;n<r.files.length;n++)if(null==r.files[n]){a=n;break}if(!(a>-1))break;r.files.splice(a,1),a=-1}if("*"!=t&&""!=t){var l=[];for(n=0;n<r.files.length;n++)e(t,r.files[n].fname)&&l.push(r.files[n]);r.files=l,r.free=32-r.files.length}return r}setDir(t){if(0!=this.privacy.confirmLocalStorage()&&this.initialized){var e=this.prefix+""+this.currentDisk+"_dir";sessionStorage.setItem(e,JSON.stringify(t))}}existsFile(t){if(!this.initialized)return!1;for(var e=this.getDir("",null),s=-1,i=0;i<e.files.length;i++)if(e.files[i].fname==t){s=i;break}return s>-1}removeFromDir(t){if(this.initialized){for(var e=this.getDir("",null),s=-1,i=0;i<e.files.length;i++)if(e.files[i].fname==t){s=i;break}s>-1&&e.files.splice(i,1),this.setDir(e)}}updateDir(t,e,s){if(this.initialized){for(var i=this.getDir("",null),r=-1,o=0;o<i.files.length;o++)if(i.files[o].fname==t){r=o;break}r>-1?(i.files[o].size=e,i.files[o].type=s):i.files.push({fname:t,size:e,type:s}),this.setDir(i)}}saveFile(t,e,s,i){if(!this.initialized)return!1;if(0==this.privacy.confirmLocalStorage())return!1;var r=t;t.length>32&&(r=t.substr(0,32));var o=this.prefix+""+this.currentDisk+"_"+r,a=JSON.stringify({type:s,data:e});return sessionStorage.setItem(o,a),this.updateDir(r,i,s),!0}makeError(t,e){return{success:!1,reason:t,details:e,fsErrorSignature:!0}}loadFile(t,e){if(!this.initialized)throw makeError("Filesystem not initialized");var s,i=this.prefix+""+this.currentDisk+"_"+t,r=sessionStorage.getItem(i);if(!r)throw makeError("File not found");try{s=JSON.parse(r).data}catch(t){throw makeError("File corrupt",t)}e.clazz[e.method](t,e,s)}deleteFile(t){if(!this.existsFile(t))return"no such file";try{this.removeFromDir(t),this._removeFile(t)}catch(t){return"unexpected"}return"ok"}_removeFile(t){var e=this.prefix+""+this.currentDisk+"_"+t;sessionStorage.removeItem(e)}formatDisk(){for(var t=this.getDir("",null),e=0;e<t.files.length;e++){var s=t.files[e].fname;this._removeFile(s)}t.files=[],t.title="Empty",this.setDir()}getFullDisk(){if(!this.initialized){var t={dir:e=this.getDir("",null),content:[]};return JSON.stringify(t)}for(var e=this.getDir("",null),s=[],i=0;i<e.files.length;i++){var r=e.files[i].fname,o=this.prefix+""+this.currentDisk+"_"+r,a=sessionStorage.getItem(o);s.push({fname:r,content:a})}t={dir:e,content:s};var n=JSON.stringify(t);return console.log(n),n}},o.i.cache=class{constructor(t){if(!t)throw"sys expected";this.initialized=!1,this.sys=t,this.prefix=t.SIG+"_"+t.SUBSYS+"__",console.log("FILESYSMODULE lfs: "+this.prefix)}makeDataContainer(t){return{success:!0,data:t}}init(){this.initialize()}initialize(){this.privacy=this.sys.m.priv,this.disks=[],this.currentDisk=null;var t=localStorage.getItem(this.prefix+"disks_list");if(null==t){var e="0001";this.disks=[e],this.currentDisk=e,this.lastDisk=1,this.disksNotInitialized=!0,1==this.privacy.confirmLocalStorage()&&(localStorage.setItem(this.prefix+"disks_list",JSON.stringify(this.disks)),localStorage.setItem(this.prefix+"0001_dir",JSON.stringify({files:[],title:"Default",readOnly:!1})),localStorage.setItem(this.prefix+"disk_current",e),this.formatDisk())}else{this.disks=JSON.parse(t),this.currentDisk=localStorage.getItem(this.prefix+"disk_current");for(var s=-1,i=0;i<this.disks.length;i++)parseInt(this.disks[i])>s&&(s=parseInt(this.disks[i]));this.lastDisk=s}this.initialized=!0}selectDisk(t){this.currentDisk=t,1==this.privacy.confirmLocalStorage()&&localStorage.setItem(this.prefix+"disk_current",t)}ready(){return this.initialized}getDisks(){if(!this.initialized)return[];var t=this.prefix+"disks_list",e=localStorage.getItem(t);return JSON.parse(e)}getEmptyDirStructure(t){return{files:[],title:"null"}}getDir(t,e){if(!this.initialized)return this.getEmptyDirStructure(null);var s=this.prefix+""+this.currentDisk+"_dir",i=localStorage.getItem(s),r=JSON.parse(i),o=r.title;if(!i)return{files:[],title:o};r.title=o,r.free=32-r.files.length;for(var a=-1;;){for(var n=0;n<r.files.length;n++)if(null==r.files[n]){a=n;break}if(!(a>-1))break;r.files.splice(a,1),a=-1}if("*"!=t&&""!=t){var l=[];for(n=0;n<r.files.length;n++)e(t,r.files[n].fname)&&l.push(r.files[n]);r.files=l,r.free=32-r.files.length}return r}setDir(t){if(this.initialized){var e=this.prefix+""+this.currentDisk+"_dir";1==this.privacy.confirmLocalStorage()&&localStorage.setItem(e,JSON.stringify(t))}}existsFile(t){if(!this.initialized)return!1;for(var e=this.getDir("",null),s=-1,i=0;i<e.files.length;i++)if(e.files[i].fname==t){s=i;break}return s>-1}removeFromDir(t){if(this.initialized){for(var e=this.getDir("",null),s=-1,i=0;i<e.files.length;i++)if(e.files[i].fname==t){s=i;break}s>-1&&e.files.splice(i,1),this.setDir(e)}}updateDir(t,e,s){if(this.initialized){for(var i=this.getDir("",null),r=-1,o=0;o<i.files.length;o++)if(i.files[o].fname==t){r=o;break}r>-1?(i.files[o].size=e,i.files[o].type=s):i.files.push({fname:t,size:e,type:s}),this.setDir(i)}}saveFile(t,e,s,i){if(this.initialized){var r=t;t.length>32&&(r=t.substr(0,32)),r.startsWith("$/")&&(r=r.substr(2));var o=this.prefix+""+this.currentDisk+"_"+r,a=JSON.stringify({type:s,data:e});return 1==this.privacy.confirmLocalStorage()&&(localStorage.setItem(o,a),this.updateDir(r,i,s),!0)}}makeError(t,e){return{success:!1,reason:t,details:e,fsErrorSignature:!0}}loadFile(t,e){var s=this.makeError;if(!this.initialized)throw s("Filesystem not initialized");var i=t;if("*"==i){var r=this.getDir("",null);r.files&&r.files.length>0&&r.files[0]&&(i=r.files[0].fname)}var o,a=this.prefix+""+this.currentDisk+"_"+i,n=localStorage.getItem(a);if(!n)throw s("File not found");try{o=JSON.parse(n).data}catch(t){throw s("File corrupt",t)}e.clazz[e.method](t,e,this.makeDataContainer(o))}deleteFile(t){if(!this.existsFile(t))throw"no such file";try{this.removeFromDir(t),this._removeFile(t)}catch(t){throw"unexpected ("+t.message+")"}return!0}_removeFile(t){var e=this.prefix+""+this.currentDisk+"_"+t;localStorage.removeItem(e)}formatDisk(){for(var t=this.getDir("",null),e=0;e<t.files.length;e++){var s=t.files[e].fname;this._removeFile(s)}t.files=[],t.title="Empty",this.setDir()}createDiskFromImage(t,e){this.createDiskFromImage2(t,e,!1)}createSysDiskFromImage(t){this.createDiskFromImage2("SYS",t,!0)}createDiskFromImage2(t,e,s){if(0!=this.privacy.confirmLocalStorage()){var i;s?i="1":(this.lastDisk++,i=""+this.lastDisk),i=i.padStart(4,"0");var r=e.dir,o=e.outtent,a=this.prefix+""+i+"_dir";localStorage.setItem(a,JSON.stringify(r));for(var n=0;n<o.length;n++){var l=o[n].fname;a=this.prefix+""+i+"_"+l,localStorage.setItem(a,o[n].outtent)}this.disks.push(i),localStorage.setItem(this.prefix+"disks_list",JSON.stringify(this.disks))}}createDisk(){if(0!=this.privacy.confirmLocalStorage()){this.getDisks(),this.lastDisk++;var t=""+this.lastDisk;t=t.padStart(4,"0");var e=this.getEmptyDirStructure("NEW DISK"),s=this.prefix+""+t+"_dir";localStorage.setItem(s,JSON.stringify(e)),this.disks.push(t),localStorage.setItem(this.prefix+"disks_list",JSON.stringify(this.disks))}}getFullDisk(){if(!this.initialized){var t={dir:e=this.getDir("",null),content:[]};return JSON.stringify(t)}for(var e=this.getDir("",null),s=[],i=0;i<e.files.length;i++){var r=e.files[i].fname,o=this.prefix+""+this.currentDisk+"_"+r,a=localStorage.getItem(o);s.push({fname:r,content:a})}t={dir:e,content:s};var n=JSON.stringify(t);return console.log(n),n}},o.i.ramfs=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.files=[],this.data={}}init(){}ready(){return!0}getDir(t,e){var s=this.files;if("*"!=t&&""!=t){for(var i=[],r=0;r<this.files.length;r++)e(t,this.files[r].fname)&&i.push(this.files[r]);s=i}return{title:"Ram Disk",files:s,free:0}}exists(t){for(var e=this.getDir("",null).files,s=-1,i=0;i<e.length;i++)if(e[i].fname==t){s=i;break}return s>-1}makeError(t,e){return{success:!1,reason:t,details:e,fsErrorSignature:!0}}saveFile(t,e,s,i){if(t.indexOf("/")>-1)throw{message:"saveFile: '"+t+"' - invalid path, RAMFS device only supports flatdir"};if(!this.exists(t)){var r={fname:t,type:s,size:i};this.data[t]={type:s,data:e},this.files.push(r)}}loadFile(t,e){if(!this.exists(t))throw makeError("File not found");e.clazz[e.method](t,e,this.data[t].data)}deleteFile(t){if(!this.existsFile(t))return!1;try{for(var e=this.files,s=0;s<e.length;s++)if(e[s].fname==t){e[s]=void 0;break}this.data[t]=void 0}catch(e){throw{message:"deleteFile: '"+t+"' - "+e.message}}return!0}formatDisk(){this.files=[],this.data={}}},o.i.script=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.files=[],this.data={}}init(){}ready(){return!0}exists(t){if(document.getElementById(t))return!0}saveFile(t,e,s,i){throw{message:"saveFile '"+t+"' - SCRIPTURL is readonly"}}makeDataContainer(t){return{success:!0,data:t}}loadTextFromURL(t,e){var s=new XMLHttpRequest,i=this;s.onreadystatechange=function(){4===s.readyState&&200===s.status&&i.loadedFile(t,e,i.makeDataContainer(s.responseText))},s.overrideMimeType("text/plain"),s.open("GET",t,!0),s.send(null)}makeError(t,e){return{success:!1,reason:t,details:e,fsErrorSignature:!0}}loadFile(t,e){if(!this.exists(t))throw makeError("File not found");var s=document.getElementById(t);if(""==s.innerText.trim()){var i=!1;if(s.src&&""!=s.src&&(i=!0),!i)return{type:"bas",data:'10 print "?program not found error"'};this.loadTextFromURL(s.src,e)}else{for(var r=s.innerText.split("\n"),o="",a=0;a<r.length;a++)""!=o&&(o+="\n"),o+=r[a].trim();e.clazz[e.method](t,e,this.makeDataContainer(o))}}loadedFile(t,e,s){e.clazz[e.method](t,e,s)}getDir(t,e){for(var s=document.getElementsByTagName("script"),i=[],r=0;r<s.length;r++){var o=s.item(r);console.log(o.attributes.id);var a=o.attributes.id.nodeValue;i.push({fname:a})}if("*"!=t&&""!=t){var n=[];for(r=0;r<i.length;r++)e(t,i[r].fname)&&n.push(i[r]);i=n}return{files:i,title:"page scripts",free:0}}deleteFile(t){throw{message:"SCRIPTURL is readonly"}}formatDisk(){throw{message:"formatDisk '"+fileName+"' - SCRIPTURL is readonly"}}},o.i.qfs=class{constructor(t,e){if(!t)throw"sys expected";if(!e)throw"dependencies expected";this.dependencies=e,this.initialized=!1,this.sys=t,this.defaultFS=t.bootCfg.fs.default,this.currentFS=this.defaultFS,this.validCharacters="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+-._"}init(){this.initialize()}initialize(){this.fsList=[];for(var t=this.dependencies,e=0;e<t.length;e++){var s=t[e],i={token:s,fs:this.sys.m[s],prefix:s+"://"};this.fsList.push(i)}this.initialized=!0}matcher(t,e){if(t.endsWith("*")){var s=t.substr(0,t.length-1);if(e.startsWith(s))return!0}else if(t.startsWith("*")&&(s=t.substr(1),e.endsWith(s)))return!0;return!1}getCurrent(){return this.currentFS}checkFS(t){var e=t,s=this.fsList;1==e.split("://").length&&(e=t+"://");for(var i=0;i<s.length;i++){var r=s[i];if(e.startsWith(r.prefix))return r}return null}setFS(t){var e=this.checkFS(t);return!!e&&(this.currentFS=e.token,!0)}listFS(){for(var t=[],e=this.fsList,s=0;s<e.length;s++){var i=e[s];t.push(i.prefix)}return t}ready(){return this.initialized}getFS(t){var e=this.fsList;if(1==t.split("://").length)for(var s=0;s<e.length;s++){var i=e[s];if(this.currentFS+"://"==i.prefix)return i}for(s=0;s<e.length;s++)if(i=e[s],t.startsWith(i.prefix))return i;return this.currentFS,null}getLPath(t){var e=t.split("://");return e.length<2?t:e[1]}getDir(t){if(!this.initialized)return{files:[],title:"null",free:-1,fs:"?"};var e=this.getFS(t);if(!e)return{files:[],title:"null",free:-1,fs:"?"};var s=e.fs.getDir(this.getLPath(t),this.matcher);return s.fs=e.prefix,s}existsFile(t){return this.initialized,!1}checkFileName(t){for(var e=0;e<t.length;e++){var s=t.charAt(e);if(this.validCharacters.indexOf(s)<0)return!1}return!0}doCallBack(t,e){t.clazz?(t.data&&(e.cbData=t.data),t.clazz[t.method](e)):t(e)}saveFile(t,e,s,i,r){if(!this.initialized)return null;var o=this.getFS(t);if(!o)throw{message:t+" has unknown file system"};var a=this.getLPath(t);if(!a)throw{message:"QPath '"+t+"' has no local path"};if(!this.checkFileName(a))throw{message:"path '"+a+"' has invalid characters"};var n=o.fs.saveFile(a,e,i,r),l={};l.qpath=t,l.type=i,l.length=r;var h={result:n,args:l,origCallBackRecord:s};return this.doCallBack(s,h),null}makeError(t,e){return{success:!1,reason:t,details:e,fsErrorSignature:!0}}loadFile(t,e){var s=e,i=this.makeError;if(this.initialized){var r=this.getFS(t);if(r){var o=this.getLPath(t);if(o){if(!this.checkFileName(o))throw{message:"path '"+o+"' has invalid characters"};var a={origCallBackRecord:e,qpath:t,clazz:this,method:"loadedFile"};try{r.fs.loadFile(o,a)}catch(e){return e.fsErrorSignature?void s.clazz[s.method](t,s,i(e.reason)):void s.clazz[s.method](t,s,i("Internal error",e))}}else s.clazz[s.method](t,s,i("QPath '"+t+"' has no local path"))}else s.clazz[s.method](t,s,i(t+" has unknown file system"))}else s.clazz[s.method](t,s,i("Not Initialized"))}loadedFile(t,e,s){var i=e.origCallBackRecord;i.clazz[i.method](e.qpath,i,s)}deleteFile(t,e){if(!this.initialized)return null;var s=this.getFS(t);if(!s)throw{message:t+" has unknown file system"};var i=this.getLPath(t);if(!i)throw{message:"QPath '"+t+"' has no local path"};if(!this.checkFileName(i))throw{message:"path '"+i+"' has invalid characters"};var r=s.fs.deleteFile(i),o={};o.qpath=t;var a={result:r,args:o,origCallBackRecord:e};return this.doCallBack(e,a),null}formatDisk(t){return this.existsFile(fileName)?"error":"no such file"}},o.dep.qfs=["ramfs","cache","sfs","script"],o.dep.basic=["canvas","tablecon","displaymodes","mrbeepaudio","qfs","htmlwrapper","basicmenu"],o.initSimpleLogging();for(var l=Object.getOwnPropertyNames(o.i),h=[],c=0;c<l.length;c++){var d=l[c];void 0!==l[c]&&n(d,h,0)}for(c=0;c<h.length;c++)console.log("construct "+h[c]),o.m[h[c]]=new o.i[h[c]](a,o.dep[h[c]]);for(a.audio=a.m.mrbeepaudio,a.init.queuedMessages=a.nulcon,a.init.conStyle=o.conStyle,a.init.displayMode=o.displayMode,a.m=o.m,a.fs=a.m.qfs,a.m.displaymodes.setMode(o.displayMode,a.m.basicmenu),o.out=a.out,c=0;c<h.length;c++)console.log("init "+h[c]),o.m[h[c]].init();try{var u=o.rootScript.dataset.script;null==u&&(u="autorun.bas"),o.onReady="script://"+u}catch(t){throw alert("HALT: Boot-Onready Handler not found!!"),"HALT - Neither root-script-attribute 'basScript' or constant 'BOOT_ONREADY' defined."}a.nulcon=void 0,o.input=o.m.domelinput,console.log("boot.basic=",o.basic),o.m.basic.setInput(o.input),o.m.basic.loadApp(o.onReady)})();
//# sourceMappingURL=basicloader.js.map