(()=>{var t={appName:"unknown",unique:0};console=t,function(){function e(t,e){postMessage({type:t,message:e})}t.post=e,t.log=function(){for(var t=Array.prototype.slice.call(arguments),r=[],s=0;s<t.length;s++)r.push(JSON.stringify(t[s]));e("syslog",r)},t.logerr=function(){var t=Array.prototype.slice.call(arguments);e("syserr",t)},t.load=function(t,r,s){e("load",{processId:t.processId,path:r,device:s})},t.loaddata=function(t,r,s,i){e("loaddata",{processId:t.processId,path:r,type:s,label:i})},t.save=function(t,r,s,i){e("save",{processId:t.processId,path:r,device:s,data:i})},t.delete=function(t,r,s){e("delete",{processId:t.processId,path:r,device:s})},t.dir=function(t,r,s){e("dir",{processId:t.processId,path:r,device:s})},t.setcfg=function(t){this.cfg=t},t.listfs=function(t){e("listfs",{processId:t.processId})},t.postsynchrequest=function(t){e("synch",{procId:t})},t.poststatus=function(t,r){e("status",{procId:t,status:r})},t.setfs=function(t,r){this.fs=r,e("setfs",{path:r,processId:t.processId})},t.setDisplayMode=function(t,r){e("displaymode",{processId:t.processId,m:r})},t.blinkMode=function(t){e("blinkMode",{m:t})},t.html={},t.html.executeFunction=function(){var t=Array.prototype.slice.call(arguments);e("htmldofun",t)},t.html.html=function(){var t=Array.prototype.slice.call(arguments);e("html",t)},t.html.htmlnode=function(){var t=Array.prototype.slice.call(arguments);e("htmlnode",t)},t.html.get=function(){return e("htmlget",args),{wait_for_result:!0}},t.export=function(t,r){e("export",{code:t,destination:r})},t.signalHideMenu=function(t){e("signalHideMenu",{hide:t})}}();class e{constructor(t,e,r){this.name=t,this.indices=e,this.buffer=null,this.defaultValue=r}getIndexCount(){return this.indices.length}_check(t){if(t.length!=this.indices.length)throw"BasicArray:00:index dimension mismatch:For array "+this.name;for(var e=0;e<t.length;e++){if(t[e]>this.indices[e]){var r='"'+this.name+"["+t[e]+']" does not exist';throw t.length>1&&(r='"'+this.name+'" with index '+t[e]+" does not exist",r+=" for index dimension "+e),"BasicArray:01:index out of bounds:"+r}if(t[e]<0)throw"BasicArray:02:index smaller then zero:For array "+this.name}}set(t,e){this._check(t),null==this.buffer&&(this.buffer=[]);for(var r=this.buffer,s=t.length-1,i=0;i<=s;i++)i==s?r[t[i]]=e:(void 0===r[t[i]]&&(r[t[i]]=[]),r=r[t[i]])}get(t){if(this._check(t),null==this.buffer)return this.defaultValue;for(var e=this.buffer,r=t.length-1,s=0;s<=r;s++){if(s==r)return e[t[s]];if(void 0===e[t[s]])return this.defaultValue;e=e[t[s]]}}}class r{newError(t,e,r,s){return{context:r,clazz:t,detail:e,lineNr:s}}throwError(t,e,r,s){throw this.newError(t,e,r,s)}fromSimpleExternalError(t,e,r){var s=r;void 0===s&&(s=-1);var i=t.split(":");if(3!=!i.length){var a=this.newError(i[2],i[3],e,s);return a.extCode0=i[0],a.extCode1=i[1],a}}fromSerializedError(t,e,r){var s=r;if(void 0===s&&(s=-1),!this.isSerializedError(t))return this.newError("unknown",null,e,s);var i=t.substr(1).split("@");return 1==i.length?this.newError(i[0],null,e,s):this.newError(i[0],i[1],e,s)}isSerializedError(t){return"string"==typeof t&&t.startsWith("@")}isError(t){if("[object Object]"===Object.prototype.toString.call(t)){t.context;var e=t.clazz;if(t.detail,void 0!==e)return!0}return!1}}class s{constructor(t){this.sys=t,this.output=t.out,this.keyMode="insert"}addRunTime(t){this.runTime=t}keyHandlerForCLE(e){if("Enter"!=e.keyLabel||e.shiftKey)"Enter"==e.keyLabel&&e.shiftKey?this.output.ScrollDownByCurrentLine():"Backspace"==e.keyLabel||"Delete"==e.keyLabel?"Delete"==e.keyLabel?this.output.delete():this.output.backspace():"ArrowUp"!=e.keyLabel||e.ctrlKey?"ArrowDown"!=e.keyLabel||e.ctrlKey?"ArrowUp"==e.keyLabel&&e.ctrlKey?(this.output.cursorMove("up"),this.output.cursorMove("up"),this.output.cursorMove("up"),this.output.cursorMove("up")):"ArrowDown"==e.keyLabel&&e.ctrlKey?(this.output.cursorMove("down"),this.output.cursorMove("down"),this.output.cursorMove("down"),this.output.cursorMove("down")):"ArrowLeft"!=e.keyLabel||e.ctrlKey?"ArrowRight"!=e.keyLabel||e.ctrlKey?"ArrowRight"==e.keyLabel&&e.ctrlKey?this.output.jumpTo("text-end"):"ArrowLeft"==e.keyLabel&&e.ctrlKey?this.output.jumpTo("text-start"):"Home"!=e.keyLabel||e.ctrlKey||e.shiftKey?"Home"==e.keyLabel&&e.shiftKey&&!e.ctrlKey?this.output.clear():"End"!=e.keyLabel||e.ctrlKey?"Home"==e.keyLabel&&e.ctrlKey&&!e.shiftKey?this.output.jumpTo("home"):"End"==e.keyLabel&&e.ctrlKey?this.output.jumpTo("end"):"Tab"==e.keyLabel?"insert"==this.keyMode?this.output.insert("        "):this.output.write("        "):"Insert"==e.keyLabel?("insert"==this.keyMode?this.keyMode="overwrite":this.keyMode="insert",this.output.setCursorMode(this.keyMode)):null!=e.key&&("insert"==this.keyMode?this.output.insert(e.key):this.output.write(e.key)):this.output.jumpTo("line-end"):this.output.jumpTo("line-start"):this.output.cursorMove("right"):this.output.cursorMove("left"):this.output.cursorMove("down"):this.output.cursorMove("up");else{var r=t.out.getCurrentLine();this.output.writeln(""),this.runTime.executeInteractiveLine(r)}}interactiveKeyHandler(t){this.keyHandlerForCLE(t)}}class i{constructor(t,e){this.debugFlag=!1,this.sys=t,this.editor=e,this.editor.addRunTime(this),this.listSpeed=15,this.output=t.out,this.bitmap=t.bout,this.playfields=t.pfields,this.input=t.input,this.audio=t.audio,this.input.setHandler(this),this.input.setInterActive(!1),this.html=t.html,this.menuEnable=!1,this.program=[],this.runFlag=!1,this.isWaitingFlag=!1,this.isSynchingFlag=!1,this.waitingTime=0,this.immediate=0,this.printWaitSynchCounter=0,this.waitForMessageFlag=!1,this.waitForMessageVariable=null,this.executeLineFlag=!1,this.goPlayExampleFlag=!1,this.inputFlag=!1,this.inputCommand=!1,this.listFlag=!1,this.immersiveFlag=!1,this.statusChanged=!1,this.gosubReturn=[],this.nullTime=(new Date).getTime(),this.turboMode=!1,this.cmdCountPerCycleDefault=2e4,this.cmdCountPerCycleTurbo=2e4,this.cmdCountPerCycle=this.cmdCountPerCycleDefault,this.output,this.commands=new o(this),this.extendedcommands=new a(this.commands,this),this.erh=new r,this.vars={},this.functions=[],this.data=[],this.loadedData={default:[]},this.loadedLabel=null,this.kbBuffer=[],this.yPos=-1,this.SHORTLINE=0,this.LONGLINESTART=1,this.LONGLINEEND=2,this.forContext={default:[]},this.outputCallBacksAll={lineOverFlow:{clazz:this,method:"cbLineOverFlow"},scroll:{clazz:this,method:"cbScroll"},clearScreen:{clazz:this,method:"cbClearScreen"}},this.outputCallBacksClScr={lineOverFlow:void 0,scroll:{clazz:this,method:"cbScroll"},clearScreen:{clazz:this,method:"cbClearScreen"}},this.synchClock(),this.exitMode="stay",this.code2colMap=[];var s=this.code2colMap;s[144]=0,s[5]=1,s[28]=2,s[159]=3,s[156]=4,s[30]=5,s[31]=6,s[158]=7,s[129]=8,s[149]=9,s[150]=10,s[151]=11,s[152]=12,s[153]=13,s[154]=14,s[155]=15,this.symbolTable={},this.symbolTable.up=145,this.symbolTable.down=17,this.symbolTable.left=157,this.symbolTable.right=29,this.symbolTable["reverse on"]=18,this.symbolTable["reverse off"]=146,this.symbolTable.clear=147,this.symbolTable.home=19,this.symbolTable.black=144,this.symbolTable.white=5,this.symbolTable.red=28,this.symbolTable.cyan=159,this.symbolTable.purple=156,this.symbolTable.green=30,this.symbolTable.blue=31,this.symbolTable.yellow=158,this.symbolTable.orange=129,this.symbolTable.brown=149,this.symbolTable.pink=150,this.symbolTable.grey1=151,this.symbolTable.grey2=152,this.symbolTable["light green"]=153,this.symbolTable["light blue"]=154,this.symbolTable.grey3=155;for(var i=[],n=Object.entries(this.symbolTable),h=0;h<n.length;h++)i[n[h][1]]=n[h][0];this.symbolTableBM=i}flagStatusChange(){this.statusChanged=!0}clearInputCommand(){this.inputCommand=!1}flagInputCommand(){this.inputCommand=!0}setWaiting(t){this.isWaitingFlag=!0,this.waitingTime=t}clearWaiting(){this.isWaitingFlag=!1}setImmediate(t){this.immediate=t,0==this.immediate&&(this.printWaitSynchCounter=0),this.output.setPokeFlush(0!=t)}synchPrint(){0==this.immediate&&(this.printWaitSynchCounter++,this.printWaitSynchCounter>100&&(this.enableSynching(),this.printWaitSynchCounter=0))}printNewLine(){this.output.nl(),0==this.immediate&&(this.enableSynching(),this.printWaitSynchCounter=0)}enableSynching(){this.isSynchingFlag=!0,this.synchingTime0=(new Date).getTime()}clearSynching(){this.isSynchingFlag=!1,this.synchingTime=(new Date).getTime()-this.synchingTime0}getScopeVars(t){return t.vars}getFullVarList(){for(var t=this.getFullScopes(),e=[],r=0;r<t.length;r++)for(var s=t[r],i=this.getScopeVars(s.scope),a=Object.getOwnPropertyNames(i),n=0;n<a.length;n++){var o=a[n],h=i[o],l=s.path;if(""==l?l="":l+="/",o.startsWith("@array_")){for(var u="",p=0;p<h.indices.length;p++)p>0&&(u+=","),u+=h.indices[p];e.push(o.substr(7)+" = array with dim("+u+")")}else o.endsWith("$")?e.push(l+o+' = "'+h+'"'):e.push(l+o+" = "+h)}return e}getFullScopes(){for(var t=[],e="",r=0;r<this.scopes.length;r++){var s=this.scopes[r].name;r>0&&(""!=e&&(e+="/"),e+=s),t.push({path:e,scope:this.scopes[r]})}return t}cpuNeeded(){return this.runFlag?1:this.listFlag?.8:.1}getStatus(){var t,e="";e=this.runFlag?"running["+(t=this.program[this.runPointer][0])+"]":"stopped",this.runFlag&&this.inputFlag?e="running["+t+"]/input":!this.runFlag&&this.listFlag&&(e="stopped/listing");var r=Object.getOwnPropertyNames(this.getVars()).length;return this.statusChanged=!1,{status:e,pgmLen:this.program.length,varLen:r,displayMode:this.sys.displayMode}}dir(t,e){this.sys.dir(this,t,e),this.startWaitForMessage("dir")}listfs(){this.sys.listfs(this),this.startWaitForMessage("listfs")}setfs(t){this.sys.setfs(this,t),this.startWaitForMessage("path")}load(t,e,r){this.sys.load(this,t,r),this.startWaitForMessage("load"),this.autoStartAfterLoad=e}loaddata(t,e,r){this.sys.loaddata(this,t,e,r),this.startWaitForMessage("loaddata")}save(t,e){var r=this.getProgramAsText(),s=t;null==t&&(s="default.bas"),this.sys.save(this,s,e,r),this.startWaitForMessage("save")}deleteFile(t,e){this.sys.delete(this,t,e),this.startWaitForMessage("delete")}startWaitForMessage(t){this.waitForMessageFlag=!0,this.waitForMessageVariable=t}keyInterrupt(t,e){this.interrupt(0,t,{})}interrupt(t,e,r){if(!(0==t&&this.interruptFlag0||1==t&&this.interruptFlag1)){var s,i;if(0==t){if(void 0===(s=this.handlers.interrupt0))return;this.interruptFlag0=!0,i=this.handlers.interrupt0ParamIsLabel}else{if(void 0===(s=this.handlers.interrupt1))return;this.interruptFlag1=!0,i=this.handlers.interrupt1ParamIsLabel}this.newScope("interrupt"+t,{runPointer:this.runPointer,runPointer2:this.runPointer2});var a=Object.entries(r);this.setVar("itr0$".toUpperCase(),e.toUpperCase());for(var n=0;n<a.length;n++)this.setVar(a[n][0].toUpperCase(),a[n][1]);var o=this.program,h=this.program.length,l=!1;if(i&&null==(s=this.labels[s]))throw"@undef'd label";for(n=0;n<h;n++)if(o[n][0]==s){this.runPointer=n,this.runPointer2=0,l=!0;break}if(!l)throw"@invalid interrupt handler"}}receiveMessage(e,r){if(this.vars[this.waitForMessageVariable]=e,this.waitForMessageFlag=!1,e.startsWith("displaymode:"))this.output.reInit(r.textW,r.textH),this.bitmap.reInit(r.bitmapW,r.bitmapH),this.sys.displayMode=r.mode,this.playfields.enable(r.pfEnabled),this.playfields.set(r.playfields);else if(e.startsWith("pfinit:current:"))this.output.set(r.textW,r.textH,r.cells),this.playfields.set(r.playfields);else if(e.startsWith("pfinit:other:"))this.playfields.set(r.playfields);else if(e.startsWith("pfselect:"))this.output.set(r.textW,r.textH,r.cells);else if("load:error"==e)0==this.runFlag&&this.printError("load",!1,void 0,r.reason);else if("load:completed"==e){t.log("Received 'load:completed' message. Loaded "+r.pgmData.length+" bytes..");var s=this.bootPGM(r.pgmData,r.path);t.log("Parsed program => RUN"),s&&this.autoStartAfterLoad?(this.output.control(24),this.runPGM(),t.log("Program started...")):this.stop()}else if("loaddata:completed"==e)t.log("Received 'loaddata:completed' message. Loaded "+r.data.length+" bytes.."),this.insertData(r.data,r.type,r.label);else if("loaddata:error"==e)t.log("Received 'loaddata:error' message. Error "+r.reason),this.printError("loaddata",!1,void 0,r.reason),this.stop();else if("delete:completed"==e)t.log("Received 'delete:completed' message.");else if("delete:error"==e)t.log("Received 'delete:error' message. Error "+r.reason),this.printError("delete",!1,void 0,r.reason),this.stop();else if("save:completed"==e)t.log("Received 'save:completed' message."),this.isRunning();else if("save:error"==e)t.log("Received 'save:error' message. Error "+r.reason),this.printError("save",!1,void 0,r.reason),this.stop();else if("dir:completed"==e){t.log("Received 'dir:completed' message.");for(var i=["",'Directory of: "'+r.title+'" on '+r.fs,""],a=0;a<r.files.length;a++)i.push(r.files[a].fname);i.push(r.files.length+" files"),this.enterListMode(i)}else if("dir:error"==e)t.log("Received 'dir:error' message. Error "+r.reason),this.printError("dir",!1,void 0,r.reason),this.stop();else if("listfs:completed"==e){for(t.log("Received 'listfs:completed' message."),i=["",'Default Filesystem: "'+r.currentFs+'"',"","Devices:",""],a=0;a<r.fs.length;a++){var n=r.fs[a],o='"'+n.name+'"',h=(n.device+"").length;o=o+"                  ".substr(0,18-o.length-h)+n.device,i.push("     "+o)}i.push(""),i.push(r.fs.length+" Filesystem Devices Found"),this.enterListMode(i)}else"setfs:completed"==e&&(this.isRunning()?"ok"!=r.status&&(this.printError("file system",!1,void 0,"Could not select file system"),this.stop()):"ok"==r.status||this.printError("file system",!1,void 0,"Could not select file system"));this.stopAfterMessage&&(this.stopAfterMessage=!1,this.runFlag=!1,this.HandleStopped(!1)),this.isRunning()||0!=this.listFlag||this.printReady()}stop(){this.runFlag&&this.runStop(),this.listFlag&&this.listStop()}interactiveKeyHandler(t){if(1==this.runFlag)if("Enter"==t.keyLabel){var e=this.output.getCursorPos(),r=this.output.getLineFrom(this.inputStartInputPosX,e[1]);this.output.writeln(""),this.handleLineInput(r,!0)}else if("Backspace"==t.keyLabel||"Delete"==t.keyLabel){var s=this.output.getCursorPos()[0];"Delete"==t.keyLabel?this.output.delete():s>this.inputStartInputPosX?this.output.backspace():this.output.delete()}else if("ArrowLeft"!=t.keyLabel||t.ctrlKey)if("ArrowRight"!=t.keyLabel||t.ctrlKey)if("Home"!=t.keyLabel||t.ctrlKey)"ArrowRight"==t.keyLabel&&t.ctrlKey?this.output.jumpTo("text-end"):"End"==t.keyLabel?this.output.jumpTo("text-end-all"):"ArrowLeft"==t.keyLabel&&t.ctrlKey?(this.output.jumpTo("text-start"),(i=this.output.getCursorPos())[0]<this.inputStartInputPosX&&this.output.setCursorPos(this.inputStartInputPosX,i[1])):null!=t.key&&this.output.write(t.key);else{var i=this.output.getCursorPos();this.output.setCursorPos(this.inputStartInputPosX,i[1])}else this.output.cursorMove("right");else this.output.getCursorPos()[0]>this.inputStartInputPosX&&this.output.cursorMove("left");else this.editor.interactiveKeyHandler(t)}toggleMenu(){this.menuEnable=!this.menuEnable,this.menuEnable?this.sys.signalHideMenu(!1):this.sys.signalHideMenu(!0)}HandleStopped(t){this.clearWaiting(),this.input.setInterActive(!0),this.input.flush(),!t&&this.menuEnable&&this.sys.signalHideMenu(!1),this.flagStatusChange()}importPGMHandler(t,e){var r=this.textLinesToBas(t.split("\n")).pgm;this.fileName=e,this.program=r,this.sys.log("imported program "+e+" with "+t.length+" bytes ")}bootPGM(t,e){try{var r=this.textLinesToBas(t.split("\n")).pgm;return this.fileName=e,this.program=r,this.setProgram(r),this.sys.log("imported program "+e+" with "+t.length+" bytes "),!0}catch(t){return r=this.textLinesToBas("").pgm,this.program=r,this.HandleStopped(!1),this.printError("parsing syntax",!1,t.lineNr,t.detail),this.printReady(),!1}}exitProgram(){this.closeWindow(this.windowId)}enterListMode(t){this.listFlag=!0,this.list=t,this.listPointer=0,this.printLine(""),this.listFlagBakInteractive=this.input.getInterActive(),this.input.setInterActive(!1),this.flagStatusChange()}setExitMode(t){this.exitMode=t}synchClock(){var t=new Date;t.setHours(0),t.setSeconds(0),t.setMinutes(0),t.setMilliseconds(0),this.nullTime=t}setTurbo(t){if(t)return this.cmdCountPerCycle=this.cmdCountPerCycleTurbo,void(this.turboMode=!0);this.cmdCountPerCycle=this.cmdCountPerCycleDefault,this.turboMode=!1}setProgram(t){this.program=t,this.runFlag=!1,this.HandleStopped(!0),this.inputFlag=!1,this.listFlag=!1,this.flagStatusChange()}appendProgram(t){for(var e=0;e<t.length;e++){for(var r=-1,s=0;s<this.program.length;s++)this.program[s][0]==t[e][0]&&(r=s);r>-1?this.program[r]=t[e]:this.program.push(t[e])}this.program.sort((function(t,e){return t[0]-e[0]})),this.runFlag=!1,this.HandleStopped(!1),this.inputFlag=!1,this.listFlag=!1}getProgram(){return this.program}getProgramState(){return{runFlag:this.runFlag,inputFlag:this.inputFlag,vars:this.vars,functions:this.functions,forContext:this.forContext,runPointer:this.runPointer,runPointer2:this.runPointer2}}setProgramState(t){this.runFlag=t.runFlag,this.HandleStopped(!1),this.inputFlag=t.inputFlag,this.vars=t.vars,this.functions=t.functions,this.forContext=t.forContext,this.runPointer=t.runPointer,this.runPointer2=t.runPointer2}_setByteBits(t){for(var e=0,r=0;r<8;r++)r>0&&(e>>=1),t[r]&&(e|=128);return e}_getByteBits(t){for(var e=[1,2,4,8,16,32,64,128],r=[!1,!1,!1,!1,!1,!1,!1,!1],s=0;s<8;s++)r[s]=(t&e[s])>0;return r}upperFirst(t){return t&&t.length>1?t.substr(0,1).toUpperCase()+t.substr(1):t}printError(t,e,r,s){var i="?"+this.upperFirst(t)+" error"+this.onLineStr();r&&(i="?"+this.upperFirst(t)+" error in "+r),e&&(i="?"+this.upperFirst(t)+" error"),this.output.writeln(i),s&&this.output.writeln(">> "+s)}printInfo(t){this.sys.log((t+this.onLineStr()).toUpperCase())}printHelp(){this.extendedcommands._stat_help([])}printLine(t){this.output.writeln(t),this.reverseOn=!1}print(t){this.output.writeln(t),this.reverseOn=!1}colorReset(t){this.output.setDefault(t.fg,t.bg),this.output.control(18,t.border),this.output.colorReset()}resetConsole(){this.output.getDimensions(),this.output.reset()}clearScreen(){this.output.clear(),this.output.setPos(0,0)}getMillis(){return(new Date).getTime()-this.nullTime}getJiffyTime(){var t=(new Date).getTime()-this.nullTime;return Math.floor(t/(1e3/60))%5184e3}getTime(){var t=(new Date).getTime()-this.nullTime;t%=864e5;var e=Math.floor(t/36e5);t-=36e5*e;var r=Math.floor(t/6e4);return t-=6e4*r,[e,r,Math.floor(t/1e3)]}reset(t,e){this.output.clearScreen(),this.output.writel("Ready."),this.inputFlag=!1,this.runFlag=!1,this.listFlag=!1,this.clrPGM(),this.setTurbo(!1)}compressPGMText(t){var e=new h(this.commands,this.extendedcommands);e.init();for(var r=e.getKeyWordCodes(),s=t,i=0;i<r.length;i++){var a=r[i];null!=a&&(s=s.replaceAll(a.toLowerCase(),String.fromCharCode(i)))}return s}getProgramAsTextNoPETSCII(){var t="";for(const e of this.program)""!=t&&(t+="\n"),t+=this.prepareLineForExportNoPETSCII(e[2].trim(),!0);return t}getProgramSize(){return this.program.length}getProgramAsText(){var t="";for(const e of this.program)""!=t&&(t+="\n"),"control"==e[1][0].type&&"sub"==e[1][0].controlKW&&(t+="\n"),t+=e[2].trim();return t}prepareLineForExport(t){var e;e=t.trim();for(var r="",s=0;s<e.length;s++){var i=e.charCodeAt(s);if(i<31||92==i||i>=126){var a=this.symbolTableBM[i];r+=void 0!==a?"{"+a+"}":"{"+i+"}"}else r+=e.charAt(s)}return r.toLowerCase()}replaceAll(t,e,r){for(var s=t;s.indexOf(e)>-1;)s=s.replace(e,r);return s}rebuildNoPETSCIILineString(t){var e=new h(this.commands,this.extendedcommands);e.init();var r=this.prepareLineForExportNoPETSCII(t,!1);return e.parseLine(r)}prepareLineForExportNoPETSCII(t,e){var r;r=t.trim();for(var s="",i="",a=0;a<r.length;a++){var n=r.charCodeAt(a),o=r.charAt(a);if(n<31||92==n||n>=94){var h=!1,l=!1;a+1<r.length&&'"'==r.charAt(a+1)&&(l=!0),'"'==i&&(h=!0),h&&!l?(s=s.substr(0,s.length-1),s+="CHR$("+n+');"'):h&&l?(s=s.substr(0,s.length-1),s+="CHR$("+n+")",a++):!h&&l?(s+='";CHR$('+n+")",a++):s+='";CHR$('+n+');"'}else s+=r.charAt(a);i=o}var u=this.replaceAll(s,';"";',";");return e?u.toLowerCase():u}ResolveStringSymbolToCode(t){return this.symbolTable[t]?this.symbolTable[t]:t}prepareLineForImport(t){var e;e=t.trim();for(var r="",s=0;s<e.length;){var i=e.charCodeAt(s);if(123==i){s++;for(var a="";s<e.length;){if(125==(i=e.charCodeAt(s))){s++;break}a+=String.fromCharCode(i),this.debugFlag&&(console.log("found ESC seq char "+String.fromCharCode(i)),console.log("found ESC seq char code "+i)),s++}this.debugFlag&&console.log("found ESC seq "+a),a=this.ResolveStringSymbolToCode(a.toLowerCase()),this.debugFlag&&console.log("found resolved ESC seq "+a),r+=String.fromCharCode(parseInt(a,10))}else 8221==i||8220==i?(r+='"',s++):(r+=e.charAt(s),s++)}return this.debugFlag&&console.log("dst:"+r),r}getProgramLines(){return this.program}padZeros2(t){for(var e=t+"",r=e.length;r<2;r++)e="0"+e;return e}evalExpressionPart(t){var e=0;if("num"==t.type)e="."==t.data?0:(""+t.data).indexOf(".")>=0?parseFloat(t.data):parseInt(t.data);else if("str"==t.type)e=t.data;else if("var"==t.type)t.data.startsWith("TI")&&(e=this.getMillis(),t.data.endsWith("$")&&(e=this.getTime(),e=""+this.padZeros2(e[0])+this.padZeros2(e[1])+this.padZeros2(e[2]))),t.data.startsWith("STI")?e=this.synchingTime:"CURRENTLINE"==t.data?-1!=(e=this.runPointer)&&(e=parseInt(this.program[e][0])):e="PI"==t.data?Math.PI:this.vars[t.data],null==e&&(e=0,this.scopes[0].vars[t.data]&&(e=this.scopes[0].vars[t.data]));else if("array"==t.type){var r="@array_"+t.data,s=this.vars[r];if(void 0===s&&(this.scopes[0].vars[r]&&(s=this.scopes[0].vars[r]),void 0===s))throw"@no such array@Array '"+r+"' does not exist";if(s.getIndexCount()!=t.indices.length)throw"@bad subscript@Array index dimensions do not match";for(var i=[],a=0;a<t.indices.length;a++)i[a]=this.evalExpression(t.indices[a]);void 0===(e=s.get(i))&&(e=0)}else if("expr"==t.type)e=this.evalExpression(t);else if("funCall"==t.type){for(var n=[],o=0;o<t.params.length;o++){var h=this.evalExpression(t.params[o]);n.push({value:h})}try{var l=this.commands,u=this.extendedcommands,p=this.commands,d="_fun_"+t.functionName.toLowerCase().replace("$","_DLR_"),c=l[d];if(void 0===c){if(void 0===(c=u[d]))throw c=u[d],this.printError("no such function: "+t.functionName),console.log("Cannot find functionName "+d),"@no such function "+t.functionName;p=u}e=p[d](n)}catch(t){throw t}}else if("defFnCall"==t.type)try{var g=t.functionName,f=this.evalExpression(t.params[0]),m=null;if(void 0===this.functions[g])throw"@undef'd function";var v=this.functions[g];void 0!==this.vars[v.par]&&(m=this.vars[v.par]),this.vars[v.par]=f,e=this.evalExpression(v.expr),null!=m?this.vars[m.name]=m:this.vars[v.par]=0}catch(t){throw t}return e}evalExpression(t){if(null==t)return null;if(0==t.parts.length)return null;for(var e=this.evalExpressionPart(t.parts[0]),r=1;r<t.parts.length;r++){var s=t.parts[r];if("+"==s.op)e+=this.evalExpressionPart(s);else if("^"==s.op)e=Math.pow(e,this.evalExpressionPart(s));else if("-"==s.op)e-=this.evalExpressionPart(s);else if("*"==s.op)e*=this.evalExpressionPart(s);else if("/"==s.op){if(0==this.evalExpressionPart(s))throw"@division by zero";e/=this.evalExpressionPart(s)}else if("%"==s.op)e%=this.evalExpressionPart(s);else if(";"==s.op)e+=""+this.evalExpressionPart(s);else if("OR"==s.op)e|=this.evalExpressionPart(s);else if("AND"==s.op)e&=this.evalExpressionPart(s);else if("<"==s.op)e=e<this.evalExpressionPart(s)?-1:0;else if(">"==s.op)e=e>this.evalExpressionPart(s)?-1:0;else if("="==s.op)e=e==this.evalExpressionPart(s)?-1:0;else if("<>"==s.op)e=e!=this.evalExpressionPart(s)?-1:0;else if("<="==s.op)e=e<=this.evalExpressionPart(s)?-1:0;else{if(">="!=s.op)throw"@syntax@unknown operator '"+s.op+"'";e=e>=this.evalExpressionPart(s)?-1:0}}return t.negate?-e:t.binaryNegate?0==e?-1:0:e}exitInputState(){this.output;var t=this.program;this.inputFlag=!1;var e=this.program[this.runPointer][1];this.input.setInterActive(!1),this.runPointer2++,this.runPointer2>=e.length&&(this.runPointer2=0,this.runPointer++,this.runPointer>=t.length&&(this.runFlag=!1,this.HandleStopped(!1),this.printLine(""),this.printReady()))}cycle(){this.output;var e=this.cmdCountPerCycle,r=-1;try{if(this.bitmap.isActive()&&this.bitmap.triggerFlush(),this.output.isActive()&&this.output.changeCount()>0&&this.output.triggerFlush(),!this.runFlag||this.inputFlag||this.listFlag){if(this.listFlag){for(var s=this.listSpeed;this.listPointer<this.list.length&&s-- >0;)this.listCodeLine(this.list[this.listPointer]),this.listPointer++;this.listPointer>=this.list.length&&(this.listStop(),this.flagStatusChange())}}else{this.debugFlag&&console.log("START CYCLE------------------------------");for(var i=this.program;!this.waitForMessageFlag;){this.debugFlag&&console.log("START CYCLE LOOP-------------");var a=i[this.runPointer];r=a[0];var n=this.runPointer2;this.debugFlag&&console.log(" this.runPointer = "+this.runPointer," this.runPointer2 = "+this.runPointer2),this.debugFlag&&console.log(" cmdCount = "+e);var o=this.runCommands(a[1],e);if(void 0!==this.traceVars)for(var h=0;h<this.traceVars.length;h++){var l=this.traceVars[h],u=this.vars[l],p=this.traceOldValues[l];void 0!==u&&p!=u&&(this.traceList.push("TRC("+r+") "+l+"="+u),this.traceOldValues[l]=u)}var d=o[1];20==o[0]&&(this.runPointer2=d);var c=o[2];if(this.debugFlag&&console.log(" bf = "+n," af = "+d),this.debugFlag&&console.log(" executedCount = "+c),this.debugFlag&&console.log(" rv = "+o),e-=c,o[0]<=0){this.debugFlag&&console.log(" PGM END!!!!"),this.runFlag=!1;var g=null;o.length>=4&&(g=o[3]),this.printLine(""),this.printReady(),this.HandleStopped(!1),0==o[0]&&(this.setVar("LINE",r),console.log("ERROR: ",g," LINE ",this.retreiveRuntimeLine()),console.log("PARAMETER DUMP:",this.vars),console.log("FUNCTION DUMP:",this.functions)),this.debugFlag&&console.log("CYCLE RETURN END");break}if(10==o[0]){if(this.runPointer++,this.runPointer2=0,this.debugFlag&&console.log(" new this.runPointer = "+this.runPointer," this.runPointer2 = "+this.runPointer2),this.runPointer>=i.length){this.debugFlag&&console.log("end program"),this.setVar("LINE",r),this.waitForMessageFlag?this.stopAfterMessage=!0:(this.runFlag=!1,this.HandleStopped(!1),this.printReady());break}}else if(30==o[0])this.debugFlag&&console.log(" jump to new this.runPointer = "+this.runPointer," this.runPointer2 = "+this.runPointer2);else{if(40==o[0]){this.runPointer2=d,this.debugFlag&&console.log("CYCLE PAUSE 4 INPUT"+this.runPointer+","+this.runPointer2);break}if(50==o[0]){this.runPointer2=d,this.debugFlag&&console.log("CYCLE PAUSE 4 SPECIFIC TIME"+this.runPointer+","+this.runPointer2);break}if(60==o[0]){this.runPointer2=d,this.debugFlag&&console.log("CYCLE PAUSE 4 SYNCH"+this.runPointer+","+this.runPointer2);break}}if(e<=0){this.debugFlag&&console.log("Breaking cmdCount="+e);break}}this.debugFlag&&console.log(" this.runPointer = "+this.runPointer," this.runPointer2 = "+this.runPointer2)}}catch(g){if(t.log("DEBUG: ",typeof g),this.setVar("LINE",r),this.erh.isError(g)){var f=g;this.setVar("ERR",f.clazz),this.setVar("ERRDETAIL",f.detail),this.printError(f.clazz,void 0,void 0,f.detail)}else this.erh.isSerializedError(g)?(f=this.erh.fromSerializedError(g),this.setVar("ERR",f.clazz),this.setVar("ERRDETAIL",f.detail),this.printError(f.clazz,void 0,void 0,f.detail)):(f=this.erh.fromSimpleExternalError(g,void 0,void 0),f?(this.setVar("ERR",f.clazz),this.setVar("ERRDETAIL",f.detail),this.printError(f.clazz,void 0,void 0,f.detail)):(this.setVar("ERR","unexpected"),this.setVar("ERRDETAIL","unexpected"),this.printError("unexpected",void 0,void 0,g)));this.printReady(),this.runFlag=!1,this.HandleStopped(!1),t.log("ERROR: ",g," LINE ",this.retreiveRuntimeLine()),t.log("PARAMETER DUMP:",this.vars),t.log("FUNCTION DUMP:",this.functions)}var m=this.procIf,v=m.STATE_CLI;return this.isWaitingFlag?v=m.STATE_WAITING:this.isSynchingFlag?(v=m.STATE_SYNCHING,t.log("RT:Synch")):this.inputFlag?v=m.STATE_INPUT:this.runFlag|this.listFlag&&(v=m.STATE_RUNNING),[this.statusChanged,v,this.waitingTime]}doReturn(){var t=this.gosubReturn.pop();if(void 0===t)throw"@return without gosub";this.runPointer2=t[1],this.runPointer=t[0]}doInterruptReturn(){"interrupt0"==this.scope.name?this.interruptFlag0=!1:this.interruptFlag1=!1,this.runPointer=this.scope.data.runPointer,this.runPointer2=this.scope.data.runPointer2,this.closeScope()}gosub(t,e){this.program;var r=this.program.length,s=null,i=null,a=t;if("string"==(typeof t).toLowerCase()&&null==(a=this.labels[t]))throw"@undef'd label";this.runPointer2=e,this.runPointer2+1<this.program[this.runPointer][1].length?(i=this.runPointer2+1,s=this.runPointer):this.runPointer+1<r?(i=0,s=this.runPointer+1):(i=9999,s=this.runPointer),this.gosubReturn.push([s,i]),this.goto(a)}goto(t){var e,r=this.program,s=this.program.length,i=!1;if(e=t,"string"==(typeof t).toLowerCase()&&null==(e=this.labels[t]))throw"@undef'd label";for(var a=0;a<s;a++)r[a][0]==e&&(this.runPointer=a,this.runPointer2=0,i=!0);if(!i)throw"@undef'd statement";this.runFlag||(this.startAsGoto=!0,this.runPGM())}listStop(){this.listFlag&&(this.runFlag?(this.listFlag=!1,this.input.setInterActive(this.listFlagBakInteractive)):(this.output,this.listFlag=!1,this.HandleStopped(!1),this.printLine(""),this.printReady()))}runStop(){this.runFlag&&(this.output,this.runFlag=!1,this.handlers.interrupt0=void 0,this.handlers.interrupt1=void 0,this.HandleStopped(!1),console.log("break in "+this.program[this.runPointer][0]),this.setVar("LINE",this.program[this.runPointer][0]),this.setVar("ERR","BREAK"),this.printLine(""),this.printLine("break in "+this.program[this.runPointer][0]),this.printReady())}isRunning(){return this.runFlag}isListing(){return this.listFlag}isInput(){return this.inputFlag}isReady(){return!this.runFlag&&!this.listFlag&&!this.executeLineFlag}getDataBlocks(){for(var t=[],e=Object.entries(this.loadedData),r=0;r<e.length;r++)e[r][1].length>0&&t.push(e[r][0]+": "+e[r][1].length);return t}readData(){if(!(this.dataPointer>=this.data.length)){var t=this.data[this.dataPointer];return this.dataPointer++,t}}getDataLength(){return this.data.length}setData(t){var e=t;e||(e="default"),this.data=this.loadedData[e],this.dataPointer=0}insertData(t,e,r){var s=r;s||(s="default"),this.loadedLabel=s,this.dataPointer=0;var i=[];this.loadedData[s]=i;var a=e.split(":");this["parseSimpleData"+a[0].toUpperCase()+"_"+a[1].toUpperCase()](t,i),this.data=i}parseSimpleDataI_CSV(t,e){var r=t.replaceAll(" ","").replaceAll("\t","").replaceAll("\r","").replaceAll("\n","");r=r.split(",");for(var s=0;s<r.length;s++)e.push(r[s])}parseSimpleDataS_CSV(t,e){var r=t.replaceAll(" ","").replaceAll("\t","").replaceAll("\r","").replaceAll("\n","");r=r.split(",");for(var s=0;s<r.length;s++)e.push(r[s])}parseSimpleDataS_LINES(t,e){var r;r=t.split("\n");for(var s=0;s<r.length;s++)e.push(r[s])}printChar(t){this.output.write(t)}listCodeLine(t){void 0!==t?this.printLine(t):this.printLine("???")}rebuildLineString(t,e,r,s,i,a){var n=new h(this.commands,this.extendedcommands);n.init();var o,l=n.getTokens(e,!1,!1);if(void 0!==s){var u=[];for(g=0;g<l.length;g++)"pad"!=l[g].type&&u.push(l[g]);var p=!1,d=-1;for(g=0;g<u.length;g++)if(g>1&&("num"==u[g].type&&"name"==u[g-1].type&&"THEN"==u[g-1].data?(p=!0,d=g):"num"!=u[g].type||"name"!=u[g-1].type||"GOTO"!=u[g-1].data&&"GOSUB"!=u[g-1].data||(p=!0,d=g)),"num"==u[g].type&&p&&g==d){var c=s["old_"+u[g].data];null==c&&(c=99999),u[g].data=c,p=!1}}l[0].data=t,o=t,r&&(o=t+" ");for(var g=1;g<l.length;g++)r&&"pad"==l[g].type||(a?"name"==l[g].type&&"PRINT"==l[g].data&&(l[g].data="?"):"name"==l[g].type&&"?"==l[g].data&&(l[g].data="PRINT"),"str"==l[g].type?o+='"'+l[g].data+'"':"name"==l[g].type&&1==i?o+=l[g].data+" ":"num"==l[g].type&&1==i&&1==l[g].data.length?o+=" "+l[g].data:o+=l[g].data);return n.parseLine(o)}lineIsData(t){return console.log(t),1==t[1].length&&void 0!==t[1][0].controlKW&&"DATA"==t[1][0].controlKW.toUpperCase()}lineIsRem(t){return console.log(t),1==t[1].length&&void 0!==t[1][0].controlKW&&"REM"==t[1][0].controlKW.toUpperCase()}lineIsSub(t){return console.log(t),1==t[1].length&&void 0!==t[1][0].controlKW&&"SUB"==t[1][0].controlKW.toUpperCase()}renumberProgram(t,e){for(var r=this.program,s=t,i={},a=[],n=0;n<r.length;n++){var o,h=r[n];this.lineIsSub(h)&&((o=1e3*Math.ceil(s/1e3))-s<100&&(o+=1e3),s=o),i["old_"+h[0]]=s,a.push(s),s+=e}for(n=0;n<r.length;n++){s=a[n],h=r[n];var l=this.rebuildLineString(s,h[2],!0,i,!0);h[0]=s,h[1]=l.commands,h[2]=l.raw.trim()}}PETSCIIreplace(t){for(var e=this.program,r=0;r<e.length;r++){var s=e[r],i=this.rebuildNoPETSCIILineString(s[2]);s[1]=i.commands,s[2]=i.raw}}compressProgram(t){for(var e=this.program,r=0;r<e.length;r++){var s=e[r],i=this.rebuildLineString(s[0],s[2],!0,void 0,!1,t);s[1]=i.commands,s[2]=i.raw}}normalizeProgram(){for(var t=this.program,e=0;e<t.length;e++){var r=t[e],s=this.rebuildLineString(r[0],r[2],!0,void 0,!0);r[1]=s.commands,r[2]=s.raw}}clrPGM(){this.vars={},this.functions=[],this.restoreDataPtr()}restoreDataPtr(){this.dataPointer=0,this.data=this.loadedData.default}normalizeData(t){var e=t.data;return"num"==t.type?"string"==(typeof e).toLowerCase()&&(e=parseInt(e)):"number"==(typeof e).toLowerCase()&&(e=""+e),e}runPGM(){if(this.executeLineFlag=!1,this.stopAfterMessage=!1,this.startAsGoto){this.startAsGoto=!1;var t=this.runPointer,e=this.runPointer2;return this.runPGM(),this.runPointer=t,void(this.runPointer2=e)}this.input.setInterActive(!1),this.input.flush(),this.output;var r=this.program;this.loadedData.default=[],this.restoreDataPtr(),this.gosubReturn=[],this.scopes=[],this.newScope("global",{}),this.functions=[],this.handlers={},this.labels={},this.traceList=[],this.traceOldValues={};for(var s=this.normalizeData,i=0;i<r.length;i++)for(var a=r[i],n=a[1],o=0;o<n.length;o++){var h=n[o];if("control"==h.type&&"data"==h.controlKW)for(var l=0;l<h.params.length;l++)this.loadedData.default.push(s(h.params[l]));else if("control"==h.type&&"on"==h.controlKW)"interrupt1"==h.params[0]?(this.handlers.interrupt1=h.params[1],this.handlers.interrupt1ParamIsLabel=h.label):"interrupt0"==h.params[0]&&(this.handlers.interrupt0=h.params[1],this.handlers.interrupt0ParamIsLabel=h.label);else if("control"==h.type&&"sub"==h.controlKW){var u=h.label;this.labels[u]=parseInt(a[0])}}this.debugFlag&&console.log("data dump:",this.data),this.program.length>0?(this.runFlag=!0,this.inputFlag=!1,this.waitingTime=0,this.isWaitingFlag=!1,this.isSynchingFlag=!1,this.runPointer=0,this.runPointer2=0,this.waitForMessageFlag=!1,this.interruptFlag0=!1,this.interruptFlag1=!1,this.setImmediate(0)):(this.runFlag=!1,this.inputFlag=!1,this.waitingTime=0,this.isWaitingFlag=!1,this.isSynchingFlag=!1,this.runPointer=0,this.runPointer2=0,this.waitForMessageFlag=!1,this.interruptFlag0=!1,this.interruptFlag1=!1,this.setImmediate(0),this.input.setInterActive(!0)),this.flagStatusChange()}getVars(){return this.vars}doForInit(t,e,r,s,i,a,n){var o=this.forContext;void 0===this.vars[s]&&(this.vars[s]=0),this.vars[s]=this.evalExpression(t),o.default.push(s),o[s]={};var h=o[s];if(h.to=this.evalExpression(e),h.step=null==r?1:this.evalExpression(r),h.jumpTo={line:this.runPointer,cmdPointer:i+1},h.jumpTo.cmdPointer>=a){if(-1==this.runPointer)throw"@syntax@Can't find command after 'FOR'";if(this.runPointer+1>=n)throw"@syntax@Can't find command after 'FOR', on next line";h.jumpTo.line++,h.jumpTo.cmdPointer=0}}doForNext(t){var e=this.forContext;if(0==e.default.length)throw"@syntax@Next without for";var r=e.default[e.default.length-1];null!=t&&(r=t);var s=e[r];if(this.vars[r]+=s.step,s.step>0){if(this.vars[r]<=s.to)return s.jumpTo}else{if(0==s.step)return s.jumpTo;if(this.vars[r]>=s.to)return s.jumpTo}return e.default.pop(),-1}onLineStr(){var t=this.retreiveLine();return-1==t||""==t?"":" in "+t}retreiveRuntimeLine(){return this.runPointer>-1?this.program[this.runPointer][0]:-1}retreiveLine(){return this.runFlag?this.retreiveRuntimeLine():void 0===this.parseLineNumber?-1:-1==this.parseLineNumber?"":this.parseLineNumber}commandToString(t){return"control"==t.type?t.controlKW.toUpperCase():"call"==t.type?t.statementName:"assignment"==t.type?"assign ->"+t.var:"????"}runCommands(t,r){var s=this.commands,i=this.extendedcommands,a=30,n=t.length,o=this.runPointer2,h=0;for(null!=r||(r=9999);o<n&&h<r;){var l=t[o],u=this.program[this.runPointer];if(u&&3155==parseInt(u[0])&&console.log("bump"),"control"==l.type){var p=l.controlKW;if("goto"==p)return this.goto(l.params[0]),[a,o+1,h+1];if("end"==p)return[-1,o+1,h+1];if("stop"==p)return this.printInfo("break"),[-1,o+1,h+1];if("gosub"==p)return this.gosub(l.params[0],o),[a,o+1,h+1];if("on"==p){var d=l.params[0];if("interrupt0"!=d&&"interrupt1"!=d){var c=l.params[1],g=l.params[2],f=this.evalExpression(c);if(f-1>=0&&f-1<g.length){if("goto"==d)return this.goto(g[f-1]),[a,o+1,h+1];if("gosub"==d)return this.gosub(g[f-1],o),[a,o+1,h+1]}}}else{if("return"==p)return this.interruptFlag0||this.interruptFlag1?this.doInterruptReturn():this.doReturn(),[a,o+1,h+1];if("if"==p){if(0==this.evalExpression(l.params[0]))return[10,o+1,h+1]}else if("data"==p);else{if("rem"==p)return[10,o+1,h+1];if("sub"==p)return[10,o+1,h+1];if("for:init"==p)this.doForInit(l.params[0],l.params[1],l.params[2],l.variable,o,t.length);else if("for:next"==p){var m=this.doForNext(l.nextVar);if(-1!==m){if(-1!=m.line){if(this.runPointer==m.line){o=m.cmdPointer,h++;continue}return this.runPointer=m.line,this.runPointer2=m.cmdPointer,[a,o+1,h+1]}o=m.cmdPointer,h++;continue}}else if("dim"==p){this.vars;for(var v=0;v<l.params.length;v++){for(var y=[],_=0;_<l.params[v].length;_++)y[_]=this.evalExpression(l.params[v][_]);var b=new e(l.arrayNames[v],y,0),x="@array_"+l.arrayNames[v];if(void 0!==this.vars[x])return this.printError("redim'd array"),[0,o+1,h+1];this.vars[x]=b}}else{if("def"!=p)return this.printError("illegal ctrl token '"+p+"'"),[0,o+1,h+1];this.functions[l.params[0]]={par:l.params[1],expr:l.params[2]}}}}}else if("call"==l.type){var w=[],E=[],C=s,P=C["_stat_"+l.statementName.toLowerCase()];if(void 0===P)if(void 0===(P=(C=i)["_stat_"+l.statementName.toLowerCase()]));else if(0==C.enabled&&"xon"!=l.statementName.toLowerCase())return this.printError("extended not enabled"),[0,o+1,h+1];if(void 0!==C["_if_"+l.statementName.toLowerCase()])E=C["_if_"+l.statementName.toLowerCase()]();else for(var T=0;T<l.params.length;T++)E[T]=0;for(T=0;T<l.params.length;T++)if(0==E[T]){var F=this.evalExpression(l.params[T]);null!=F&&w.push({type:"value",value:F})}else if(1==E[T]){var L=l.params[T].parts[0].data,S=l.params[T].parts[0].type;if("array"==S){var I="num";L.indexOf("$")>-1&&(I="str"),w.push({type:"var",value:L,varType:S+":"+I})}else I="num",L.indexOf("$")>-1&&(I="str"),w.push({type:"var",value:L,varType:I})}else w.push(l.params[T]);try{if(void 0===P)return this.printError("syntax"),[0,o+1,h+1];if(this.inputCommand=!1,C["_stat_"+l.statementName.toLowerCase()](w),this.inputFlag)return[40,o+1,h+1];if(this.isWaitingFlag)return[50,o+1,h+1];if(this.isSynchingFlag)return[60,o+1,h+1]}catch(t){if(console.log(t),this.erh.isSerializedError(t)){var k=this.erh.fromSerializedError(t);this.printError(k.clazz,!1,!1,k.detail)}else this.erh.isError(t)?(k=t,this.printError(k.clazz,!1,!1,k.detail)):this.printError("unexpected "+t);return[0,o+1,h]}}else if("assignment"==l.type)if(l.arrayAssignment){if(x="@array_"+l.var,void 0===this.vars[x])return this.printError("bad subscript",!1,!1,"No such Array"),[0,o+1,h];var R=this.vars[x];if(l.indices.length!=R.getIndexCount())return this.printError("bad subscript",!1,!1,"Wrong dimensions"),[0,o+1,h];for(y=[],_=0;_<l.indices.length;_++)y[_]=this.evalExpression(l.indices[_]);if(l.var.endsWith("%"))R.set(y,Math.floor(this.evalExpression(l.expression)));else if(l.var.endsWith("$"))R.set(y,this.evalExpression(l.expression));else{if("number"!=typeof this.evalExpression(l.expression))return this.printError("type mismatch",void 0,void 0,"value not a number"),[0,o+1,h];R.set(y,this.evalExpression(l.expression))}}else{if(void 0===this.vars[l.var]){if(l.var.startsWith("TI"))return this.printError("syntax"),[0,o+1,h+1];this.vars[l.var]=0}if(l.var.endsWith("%"))this.vars[l.var]=Math.floor(this.evalExpression(l.expression));else if(l.var.endsWith("$"))this.vars[l.var]=this.evalExpression(l.expression);else{if("number"!=typeof this.evalExpression(l.expression))return this.printError("type mismatch",void 0,void 0,"value not a number"),[0,o+1,h];this.vars[l.var]=this.evalExpression(l.expression)}}o++,h++}return o==t.length?[10,o,h]:[20,o,h]}newScope(t,e){var r={name:t,vars:{},data:e};this.scopes.push(r),this.vars=r.vars,this.scope=r}closeScope(){this.scopes.pop(),this.vars=this.scopes[this.scopes.length-1].vars}getArray(t){return this.vars["@array_"+t]}setVar(t,e){this.vars[t]=e}getTraceList(){return void 0===this.traceList?[]:this.traceList}setTraceVar(t){void 0===this.traceVars&&(this.traceVars=[]),this.traceVars.push(t.toUpperCase())}resetTraceVar(t){this.traceVars=void 0}old(){this.program=this.oldProgram}new(){this.oldProgram=this.program,this.program=[]}removePgmLine(t){for(var e=[],r=0;r<this.program.length;r++){var s=this.program[r];s[0]!=t&&e.push(s)}this.program=e}padSpaces6(t){for(var e=t+"",r=e.length;r<6;r++)e+=" ";return e}padSpaces8(t){for(var e=t+"",r=e.length;r<8;r++)e+=" ";return e}insertPgmLine(t,e,r,s){this.insertPgmLineLocal(t,e,r,s,this.program)}insertPgmLineLocal(t,e,r,s,i){for(var a=0;a<i.length;a++)if(i[a][0]==t)return void(i[a]=[t,e,s.trim()]);i.push([t,e,s.trim(),r]),i.sort((function(t,e){return t[0]-e[0]}))}textLinesToBas(t){var e=[],r=void 0;this.debugFlag&&console.log("textLinesToBas");for(var s=0;s<t.length;s++){var i=this.prepareLineForImport(t[s]),a=new h(this.commands,this.extendedcommands);a.init();var n=null;try{n=a.parseLine(i)}catch(t){void 0===r&&(r=t);try{n=a.parseErrorLine(i)}catch(t){this.printError("unexpected text (at "+s+")",!0),console.log("Illegal Line: ",i)}}if(null!=n){if(-1==n.lineNumber)throw"Error, command must start with number to be part of program";if(!(n.commands.length>0))throw"Error, no commands on line "+n.lineNumber;this.insertPgmLineLocal(n.lineNumber,n.commands,n.handlers,n.raw,e),this.debugFlag&&(console.log("program:",e),console.log("Line: ",n))}}return{pgm:e,exception:r}}printReady(){this.printLine("Ready.")}startConsoleDataInput(t){this.debugFlag&&console.log("inputvars=",t),this.inputFlag=!0,this.inputVars=t,this.input.setInterActive(!0),this.inputVarsPointer=0,this.output.write("? "),this.inputStartInputPosX=this.output.getCursorPos()[0],this.flagStatusChange()}executeInteractiveLine(t){this.handleLineInput(t,!1)}handleLineInput(t,e){if(this.debugFlag&&console.log("handleLineInput: start debug / isInputCommand="+e+" -------------"),e){for(var r=t,s=r.indexOf("?");s>-1;)s=(r=r.substr(s+2)).indexOf("?");if(this.debugFlag&&(console.log("handleLineInput: start debug / input, name -------------"),console.log("InputVarsPointer:",this.inputVarsPointer),console.log("InputVars:",this.inputVars),console.log("Input String:",r),console.log("Input Vars[current]:",this.inputVars[this.inputVarsPointer])),this.inputVars[this.inputVarsPointer].indexOf("$")>-1)this.setVar(this.inputVars[this.inputVarsPointer],r.trim());else{var i=parseFloat(r.trim());if(isNaN(i))return this.printLine("?redo from start"),void this.printChar("? ");this.setVar(this.inputVars[this.inputVarsPointer],i)}return this.inputVarsPointer++,this.inputVarsPointer>=this.inputVars.length?this.exitInputState():this.printChar("?? "),void(this.debugFlag&&console.log("handleLineInput: end debug -------------"))}this.executeLineFlag=!0,this.debugFlag&&console.log(t);var a=new h(this.commands,this.extendedcommands);a.init();try{var n=a.parseLine(t)}catch(t){this.parseLineNumber=-1,this.erh.isError(t)?(this.parseLineNumber=t.lineNr,this.printError(t.clazz,!0,void 0,t.detail)):this.printError("syntax",!0),this.printReady()}if(null==n)return this.debugFlag&&console.log("handleLineInput: end debug -------------"),void(this.executeLineFlag=!1);if(-1!=n.lineNumber)n.commands.length>0?this.insertPgmLine(n.lineNumber,n.commands,n.handlers,n.raw):this.removePgmLine(n.lineNumber);else{this.runPointer=-1,this.runPointer2=0;try{this.runCommands(n.commands)}catch(t){if(this.parseLineNumber=-1,this.erh.isSerializedError(t)){var o=this.erh.fromSerializedError(t);this.parseLineNumber=o.lineNr,this.printError(o.clazz,void 0,void 0,o.detail)}else this.erh.isError(t)?(o=t,this.printError(o.clazz),this.parseLineNumber=o.lineNr):this.printError("unexpected "+t);this.runFlag=!1}this.runFlag||this.listFlag||this.waitForMessageFlag||this.printReady()}this.executeLineFlag=!1,this.debugFlag&&(console.log("program:",this.program),console.log("Line: ",n),console.log("handleLineInput: end debug -------------"))}}class a{constructor(t,e){this.output=e.output,this.bitmap=e.bitmap,this.playfields=e.playfields,this.audio=e.audio,this.html=e.html,this.input=e.input,this.runtime=e,this.sys=e.sys,this.cmds={},this.func={},this.statementList=null,this.erh=new r,this.basicCmds=t}getStatements(t){for(var e=Object.getOwnPropertyNames(a.prototype),r=[],s=0;s<e.length;s++)if(e[s].startsWith("_stat_")){if(e[s].startsWith("_stat_info_"))continue;var i=e[s];t||(i=i.substr(6).toUpperCase()),r.push(i)}return r}getFunctions(t){for(var e=Object.getOwnPropertyNames(a.prototype),r=[],s=0;s<e.length;s++)if(e[s].startsWith("_fun_")){if(e[s].startsWith("_fun_info_"))continue;var i=e[s];t||(i=i.substr(5).toUpperCase().replace("_DLR_","$")),r.push(i)}return r}getAllCategories(){var t=this.basicCmds.getCategories(),e=this.getCategories(t);return(new p).getCategoriesNormalize(e)}getCategories(t){return(new p).getCategoriesIntermediate(t,this)}_stat_info_help(){return"general:Show help on commands:[<Help Category Index>]"}_stat_help(t){this.output.writeln("");var e=this.getAllCategories(),r=e[0],s=e[1],i=1e3;if(1==t.length&&(i=t[0].value),1e3==i){this.output.writeln("------------------------------"),this.output.writeln(" Help Categories:"),this.output.writeln("------------------------------");for(var a=0;a<r.length;a++)this.output.writeln(a+" "+r[a].toUpperCase())}else{var n=r[i];for(void 0===(r=s[n])&&this.erh.throwError("invalid help index"),this.output.writeln("------------------------------"),this.output.writeln(' Help on Category: "'+n.toUpperCase()+'"'),this.output.writeln("------------------------------"),a=0;a<r.length;a++){var o=r[a].attribs,h=11-r[a].name.length,l="               ".substr(0,h);if(o.description?this.output.writeln(" "+r[a].name+l+" ; "+o.description):this.output.writeln(" "+r[a].name),o.input){var u=o.input.split("\n");this.output.writeln("               input : "+u[0]);for(var p=1;p<u.length;p++){var d=u[p];this.output.writeln("                       "+d)}this.output.writeln("")}if(o.output){for(u=o.output.split("\n"),this.output.writeln("               output : "+u[0]),p=1;p<u.length;p++)d=u[p],this.output.writeln("                       "+d);this.output.writeln("")}}}this.output.writeln("")}_if_cls(){return[2]}_stat_info_cls(){return"general:Clears the screen:[<ResetScreenFlag>]"}_stat_cls(t){var e=!1;if(t.length>1)throw"parameters";if(1==t.length&&t[0].parts.length>1)throw"parameters";if(1==t.length&&1==t[0].parts.length){if("RESET"!=t[0].parts[0].data.toUpperCase())throw"parameters";e=!0}e?this.output.control(12):this.output.control(24)}_stat_info_reset(){return"general:Resets the audio and the terminal:[ <Mode> (0=screen, 1=audio, 2=all) ]"}_stat_reset(t){if(0==t.length)return this.output.reset(),this.audio.reset(),void this.runtime.resetTraceVar();var e=t[0].value;0==e||1==e||2==e?(0==e&&this.output.reset(),1==e||this.output.reset(),this.audio.reset()):this.erh.throwError("mode","only 0, 1, 2 supported")}_stat_info_menu(){return"general:Enable the programmers menu"}_stat_menu(t){0!=t.length||this.runtime.toggleMenu()}_stat_info_reverse(){return"print:Reverse the print output:<ReverseFlag>"}_stat_reverse(t){if(0!=t.length){var e=t[0].value;e<0||e>1||this.output.control(64+e)}else this.output.control(65)}_stat_info_beep(){return"sound:Make a short sound:<Channel>,<Frequency>,<Length>"}_stat_beep(t){0!=t.length?3==t.length?this.audio.playBeep(t[0].value,t[1].value,t[2].value):this.erh.throwError("parameter count","expected channel, freq, time"):this.audio.playBeep(0,440,100)}_stat_info_sound(){return"sound:Make a pre defined sound:<Channel>,<Frequency>,<Length>"}_stat_sound(t){0!=t.length?3==t.length?this.audio.playSound(t[0].value,t[1].value,t[2].value):this.erh.throwError("parameter count","expected channel, freq, time"):this.audio.playSound(0,440,100)}_stat_info_setadr(){return"sound:Define Attach,Decay and Release:<Channel>, <AttackT>, <decayT>, <releaseT>"}_stat_setadr(t){4==t.length?this.audio.attackDecayRelease(t[0].value,t[1].value,t[2].value,t[3].value):this.erh.throwError("parameter count","expected channel, attackT, decayT, releaseT")}_stat_info_volume(){return"sound:Change the audio volume:<Volume>"}_stat_volume(t){1==t.length?this.audio.volume(t[0].value):this.erh.throwError("parameter count","expected volume")}_stat_info_chfreq(){return"sound:Change the channel audio frequency:<Channel, Frequency>"}_stat_chfreq(t){2==t.length?this.audio.channelFrequency(t[0].value,t[1].value):this.erh.throwError("parameter count","expected channel, frequency")}_stat_info_chvolume(){return"sound:Change the channel audio volume:<Channel>, <Volume>"}_stat_chvolume(t){2==t.length?this.audio.channelVolume(t[0].value,t[1].value):this.erh.throwError("parameter count","expected channel, volume")}_stat_info_chsvolume(){return"sound:Change the channel sustain volume:<Channel>, <Volume>"}_stat_chsvolume(t){2==t.length?this.audio.channelSustainVolume(t[0].value,t[1].value):this.erh.throwError("parameter count","expected channel, volume")}_stat_info_addfx(){return"sound:Add a Sound FX part to the channel:<Channel>, <Type>, <Value>, <Time>"}_stat_addfx(t){4==t.length?this.audio.addEffect(t[0].value,t[1].value,t[2].value,t[3].value):this.erh.throwError("parameter count","expected channel, type, value and time(ms)")}_stat_info_clearfx(){return"sound:Clear a sound effect:<Channel>"}_stat_clearfx(t){1==t.length?this.audio.clearEffect(t[0].value):this.erh.throwError("parameter count","expected channel")}_stat_info_playfx(){return"sound:Change the channel sustain volume:<Channel> [,<Frequency> ]"}_stat_playfx(t){if(t.length<1||t.length>2)this.erh.throwError("parameter count","expected <Channel> [,<Frequency> ]");else{var e=0;t.length>1&&(e=t[1].value),this.audio.playEffect(t[0].value,e)}}_stat_info_textarea(){return"print:Limit text to certain area: <CollSize>,<RowSize>\n [,<xOffset>,<yOffset>]"}_stat_textarea(t){if(2==t.length||4==t.length){var e=Math.round(t[0].value),r=Math.round(t[1].value),s=this.output.getDimensions();if(i=-1,a=-1,4==t.length)var i=Math.round(t[2].value),a=Math.round(t[3].value);if(e>0&&r>0&&e<=s[0]&&r<=s[1]){var n=s[0]-e,o=s[1]-r;return i>0&&i>n&&this.erh.throwError("parameter","xo to big"),a>0&&a>o&&this.erh.throwError("parameter","yo to big"),void this.output.textArea(e,r,i,a)}}else this.erh.throwError("parameter count","expected cols, rows [, xoffset, yoffset ]")}_stat_info_gcolor(){return"graphics:Set graphics pen color index:<Color Index>"}_stat_gcolor(t){if(1==t.length)if(1!=t.length);else{var e=Math.round(t[0].value);e>0&&e<32&&this.bitmap.setLineColor(e)}else this.erh.throwError("parameter count","expected color")}_stat_info_fcolor(){return"graphics:Set graphics fill color index:<Color Index>"}_stat_fcolor(t){if(1==t.length)if(1!=t.length);else{var e=Math.round(t[0].value);e>0&&e<32&&this.bitmap.setFillColor(e)}else this.erh.throwError("parameter count","expected color")}_stat_info_origin(){return"graphics:Specify origin of graphics console:<X0>,<Y0>,<Dx>,<Dy>"}_stat_origin(t){4==t.length?this.bitmap.isActive()?1==t[2].value||-1==t[2].value?1==t[3].value||-1==t[3].value?this.bitmap.origin(t[0].value,t[1].value,t[2].value,t[3].value):this.erh.throwError("parameter","dy must be 1 or -1"):this.erh.throwError("parameter","dx must be 1 or -1"):this.erh.throwError("invalid display mode","current mode cannot show graphics"):this.erh.throwError("parameter count","expected 4 (x0,y0,dx,dy), not "+t.length)}_stat_info_line(){return"graphics:Draw a line:<X0>,<Y0>,<X1>,<Y1>"}_stat_line(t){4==t.length||2==t.length?this.bitmap.isActive()?2!=t.length?this.bitmap.line(t[0].value,t[1].value,t[2].value,t[3].value):this.bitmap.line(void 0,void 0,t[0].value,t[1].value):this.erh.throwError("invalid display mode","current mode cannot show graphics"):this.erh.throwError("parameter count","expected 2 or 4 ([x0,y0,] y1,y1), not "+t.length)}_stat_info_box(){return"graphics:Draw a filled rectangle:<X>,<Y>,<W>,<H>"}_stat_box(t){4==t.length?this.bitmap.isActive()?this.bitmap.fillRect(t[0].value,t[1].value,t[2].value,t[3].value):this.erh.throwError("invalid display mode","current mode cannot show graphics"):this.erh.throwError("parameter count","expected 4 (x,y,w,h), not "+t.length)}_stat_info_plot(){return"graphics:Plot a pixel:<X0>,<Y0>,<X1>,<Y1>"}_stat_plot(t){2==t.length?this.bitmap.isActive()?this.bitmap.plot(t[0].value,t[1].value):this.erh.throwError("invalid display mode","current mode cannot show graphics"):this.erh.throwError("parameter count","expected 2 (x,y), not "+t.length)}_if_center(){return[2]}isNumber(t){return"number"==typeof t&&isFinite(t)}normalizeIfNumber(t){return this.isNumber(t)&&t>=0?" "+t:""+t}_stat_info_center(){return"print:Print center text or values to the console:<Value>[;<Value>][;]"}_stat_center(t){var e=this.runtime,r=this.output;if(0!=t.length)if(1!=t.length||0!=t[0].parts.length)for(var s,i=!0,a=0;a<t.length;a++){i=!0,a<t.length-1&&(i=!1),a>0&&r.write("         ");for(var n=t[a],o={parts:[],binaryNegate:n.binaryNegate,negate:n.negate},h=0;h<n.parts.length;h++)"uniop"==n.parts[h].type&&";"==n.parts[h].op&&h==n.parts.length-1&&a==t.length-1?i=!1:o.parts.push(n.parts[h]);s=e.evalExpression(o),0==a?r.center(this.normalizeIfNumber(s),!0):r.center(""+s,!0),i&&(r.nl(),e.setWaiting(1))}else r.nl();else r.nl()}_stat_info_gtext(){return"experimental:Write text at position x,y:<X>,<Y>,<Text>"}_stat_gtext(t){3==t.length?this.output.gtext(t[0].value,t[1].value,t[2].value):this.erh.throwError("parameters","expected x,y and text parameters, not "+t.length)}_stat_info_pokeccl(){return"poke:Put a character directly into the screen buffer:<Y>,<X>,<Code>,<FGColor>,<BGColor>"}_stat_pokeccl(t){if(t.length<3)this.erh.throwError("parameters","expected at least 3 parameters, not "+t.length);else{var e=void 0,r=void 0;t.length>=4&&(e=t[3].value),t.length>=5&&(r=t[4].value),this.output.pokeccl(t[0].value,t[1].value,t[2].value,e,r)}}_stat_info_pokec(){return"poke:Put a character directly into the screen buffer:<Y>,<X>,<Code>"}_stat_pokec(t){3==t.length?this.output.pokec(t[0].value,t[1].value,t[2].value):this.erh.throwError("parameters","expected 3 parameters, not "+t.length)}_stat_info_pokecl(){return"poke:Put color directly into the screen buffer:<X>,<Y>,<FGColor>[,<BGColor>]"}_stat_pokecl(t){var e=void 0;3==t.length||4==t.length?(4==t.length&&(e=t[3].value),this.output.pokecl(t[0].value,t[1].value,t[2].value,e)):this.erh.throwError("parameters","expected 3 or 4 parameters, not "+t.length)}_stat_info_pokebcl(){return"poke:Put background color directly into the screen buffer:<Y>,<X>,<BGColor>"}_stat_pokebcl(t){3==t.length?this.output.pokecl(t[0].value,t[1].value,void 0,t[2].value):this.erh.throwError("parameters","expected 3 parameters, not "+t.length)}_int_checkPlayfieldNo(t){0==t||1==t||2==t||3==t||4==t||5==t||this.erh.throwError("parameters","Value must be 0,1,2,3,4 or 5")}_stat_info_pfinit(){return"playfield:(re)Initialize of playfield buffer: <pfIndex>, <Cols>, <Rows>"}_stat_pfinit(t){this.playfields.enabled()?3==t.length?(this._int_checkPlayfieldNo(t[0].value),this.playfields.init(this.runtime.processId,t[0].value,0,0,t[1].value,t[2].value,t[1].value,t[2].value),this.runtime.startWaitForMessage("pfinit")):this.erh.throwError("parameters","expected 3 parameters, not "+t.length):this.erh.throwError("invalid display mode","current mode does not have playfields")}_stat_info_playfield(){return"playfield:Select current playfield:<Nr> ; 0 to 3"}_stat_playfield(t){this.playfields.enabled()?1==t.length?(this._int_checkPlayfieldNo(t[0].value),this.playfields.select(this.runtime.processId,t[0].value),this.runtime.startWaitForMessage("pfselect")):this.erh.throwError("parameters","expected 1 parameter, not "+t.length):this.erh.throwError("invalid display mode","current mode does not have playfields")}_stat_info_pfscroll(){return"playfield:Set scroll pos of playfield view: <pfIndex>, <sX>, <sY>"}_stat_pfscroll(t){this.playfields.enabled()?3==t.length?(this._int_checkPlayfieldNo(t[0].value),this.playfields.scrollpos(this.runtime.processId,t[0].value,t[1].value,t[2].value)):this.erh.throwError("parameters","expected 3 parameters, not "+t.length):this.erh.throwError("invalid display mode","current mode does not have playfields")}_stat_info_pfview(){return"playfield:Initialize size of playfield view: <pfIndex>, <X>, <Y>, <W>, <H>"}_stat_pfview(t){this.playfields.enabled()?5==t.length?(this._int_checkPlayfieldNo(t[0].value),this.playfields.viewdefine(this.runtime.processId,t[0].value,t[1].value,t[2].value,t[3].value,t[4].value)):this.erh.throwError("parameters","expected 5 parameters, not "+t.length):this.erh.throwError("invalid display mode","current mode does not have playfields")}_stat_info_pfenable(){return"playfield:Enable  a playfield to be visible: <pfIndex>, <OnOfFlag>"}_stat_pfenable(t){this.playfields.enabled()?2==t.length?(this._int_checkPlayfieldNo(t[0].value),this.playfields.setEnable(this.runtime.processId,t[0].value,t[1].value)):this.erh.throwError("parameters","expected 2 parameters, not "+t.length):this.erh.throwError("invalid display mode","current mode does not have playfields")}_stat_info_locate(){return"print:Set the cursor position:<Y>,<X>"}_stat_locate(t){var e=void 0,r=void 0;t.length>2?this.erh.throwError("too many parameters","expected max 2, not "+t.length):0!=t.length&&(t.length>=1&&(e=t[0].value),t.length>=2&&(r=t[1].value),this.output.setCursorPos(r,e))}_stat_info_hide(){return"general:Hide the terminal"}_stat_hide(t){this.output.control(25)}_if_html(){return[2]}_stat_info_html(){return"html:Unsupported command"}_stat_html(t){if(this.html,0!=t.length){var e,r=-1,s=null,i="",a=!1;2==t.length&&(r=0);for(var n=0;n<t.length&&n<2;n++){for(var o=t[n],h={parts:[],binaryNegate:o.binaryNegate,negate:o.negate},l=0;l<o.parts.length;l++)"uniop"==o.parts[l].type&&"+"==o.parts[l].op&&l==o.parts.length-1&&n==t.length-1?a=!0:h.parts.push(o.parts[l]);e=this.runtime.evalExpression(h),n==r?s=e:i=e}this.html.html({htmlHandle:s,htmlValue:i,htmlAppend:a})}}_stat_info_htmlnode(){return"html:Unsupported command"}_stat_htmlnode(t){if(0!=t.length){var e=t[0];this.html.htmlnode(e)}}_stat_info_htmlbg(){return"html:Unsupported command"}_stat_htmlbg(t){if(0!=t.length){var e=t[0].value;this.html.executeFunction("body.style.backgroundImage",e)}}_stat_info_color(){return"print:Sets the console color index:<PenColor>[, <PaperColor>\n[, <BorderColor>]]"}_stat_color(t){if(0!=t.length)if(1!=t.length){var e=t[1].value;if(s=t[0].value,this.output.control(16,s),this.output.control(17,e),3!=t.length);else{var r=t[2].value;this.output.control(18,r)}}else{var s=t[0].value;this.output.control(16,s)}}_stat_info_display(){return"general:Set the console display mode:<DisplayModeNumber>"}_stat_display(t){var e=this.sys.screenModes;if(0!=t.length){t.length>1&&this.erh.throwError("too many variables","expected one parameter only");var r=t[0].value;void 0===e[r]&&this.erh.throwError("Invalid mode","No such display mode"),this.sys.setDisplayMode(this.runtime,r),this.sys.blinkMode(!this.runtime.isRunning()),this.runtime.flagStatusChange(),this.runtime.startWaitForMessage("displaysize")}else{for(var s=[],i=0;i<e.length;i++)e[i]&&s.push(i+":   "+e[i]);this.runtime.enterListMode(s)}}_stat_info_gfilter(){return"experimental:Add a html filter to the display:<FilterString>"}_stat_gfilter(t){1!=t.length&&this.erh.throwError("too many variables","expected one parameter only");var e=t[0].value;this.output.setFilter(e)}_stat_info_border(){return"general:Changes the border color:<ColorIndex>"}_stat_border(t){if(0!=t.length){t.length>1&&this.erh.throwError("too many parameters","expected one parameter only");var e=t[0].value;this.output.control(18,e)}}_stat_info_export(){return"program:Export program for download"}_stat_export(t){t.length>0&&this.erh.throwError("too many parameters","export needs no parameters");var e=this.runtime.getProgramAsText();this.sys.export(e,"disk")}_stat_info_copy(){return"program:Copy program to clipboard"}_stat_copy(t){t.length>0&&this.erh.throwError("too many parameters","copy needs no parameters");var e=this.runtime.getProgramAsText();this.sys.export(e,"clipboard"),this.runtime.printLine("Copied "+this.runtime.getProgramSize()+" program lines to the clipboard")}_stat_info_txtcopy(){return"experimental:Copy data to clipboard:<StringData$>"}_stat_txtcopy(t){1!=t.length&&this.erh.throwError("parameter count","dcopy needs 1 parameter"),this.sys.export(t[0].value+"","clipboard")}_fun_info_peekcl(){return"poke:Get color information directly from from screen buffer:<Y>,<X>[,<Mode]"}_fun_peekcl(t){var e=0;if(3==t.length||2==t.length)return 3==t.length&&(e=t[2].value),this.output.peekcl(t[0].value,t[1].value,e);this.erh.throwError("parameters","expected 2 or 3 parameters, not "+t.length)}_fun_info_peekc(){return"poke:Get a character directly into from screen buffer:<Y>,<X>"}_fun_peekc(t){if(2==t.length)return this.output.peekc(t[0].value,t[1].value);this.erh.throwError("parameters","expected 2 parameters, not "+t.length)}_fun_info_ucbase(){return"string:Return unicode-set base character code:<SetName$>"}_fun_ucbase(t){1!=t.length&&this.erh.throwError("parameters","UCBASE() needs one parameter");var e=t[0].value;return"box"==e.toLowerCase()?parseInt("2500",16):"blocks"==e.toLowerCase()?parseInt("2580",16):"symbol"==e.toLowerCase()?parseInt("2b00",16):"legacy"==e.toLowerCase()?parseInt("1fb00",16):0}_fun_info_uc_DLR_(){return"string:Create unicode character:<UnicodeHexCode$>"}_fun_uc_DLR_(t){return t[0].value?"string"==typeof t[0].value?String.fromCodePoint(parseInt(t[0].value,16)):String.fromCodePoint(t[0].value):"?"}_fun_info_dc_DLR_(){return"print:Return device control char. sequence:<Parameter1>, <Parameter2>"}_fun_dc_DLR_(t){return String.fromCodePoint(17)+String.fromCodePoint(t[0].value)+String.fromCodePoint(t[1].value)}_fun_info_html_DLR_(){return"html:Unsupported function"}_fun_html_DLR_(t){}_fun_info_width(){return"general:Return the console width in pixels"}_fun_width(t){return 0!=t.length&&this.erh.throwError("too many parameters","width() has no parameters"),this.bitmap.getDimensions()[0]}_fun_info_height(){return"general:Return the console height in pixels"}_fun_height(t){return 0!=t.length&&this.erh.throwError("too many parameters","width() has no parameters"),this.bitmap.getDimensions()[1]}_fun_info_cols(){return"print:Return the console width in columns"}_fun_cols(t){return 0!=t.length&&this.erh.throwError("too many parameters","cols() has no parameters"),this.output.getDimensions()[0]}_fun_info_columns(){return"print:Return the console width in columns"}_fun_columns(t){return 0!=t.length&&this.erh.throwError("too many parameters","columns() has no parameters"),this.output.getDimensions()[0]}_fun_info_rows(){return"print:Return the console height in rows"}_fun_rows(t){return 0!=t.length&&this.erh.throwError("too many parameters","rows() has no parameters"),this.output.getDimensions()[1]}}var n=new class{constructor(){this.rt=[]}addRuntime=function(t){this.rt.push(t)}};class o{constructor(t){this.output=t.output,this.bitmap=t.bitmap,this.input=t.input,this.runtime=t,this.sys=t.sys,this.cmds={},this.func={},this.statementList=null,this.erh=new r,this.keyLabelCodes={},this.randnrs=[];for(var e=0;e<1e4;e++)this.randnrs.push(Math.random());this.randIndex=0,this.randStep=1}getStatements(t){for(var e=Object.getOwnPropertyNames(o.prototype),r=[],s=0;s<e.length;s++)if(e[s].startsWith("_stat_")){if(e[s].startsWith("_stat_info_"))continue;var i=e[s];t||(i=i.substr(6).toUpperCase()),r.push(i)}return r}getFunctions(t){for(var e=Object.getOwnPropertyNames(o.prototype),r=[],s=0;s<e.length;s++)if(e[s].startsWith("_fun_")){if(e[s].startsWith("_fun_info_"))continue;var i=e[s];t||(i=i.substr(5).toUpperCase().replace("_DLR_","$")),r.push(i)}return r}getCategories(){return(new p).getCategoriesIntermediate([{},{}],this)}_stat_info_new(){return"program:Delete the current program from memory:"}_stat_new(t){this.runtime.new()}_stat_info_list(){return"program:List the basic program"}_stat_list(t){var e=0,r=999999,s=[];1==t.length&&(s=t[0].parts),1==s.length&&"num"==s[0].type&&s[0].data>=0?(e=s[0].data,r=s[0].data):1==s.length&&"num"==s[0].type&&s[0].data<0?r=-s[0].data:2==s.length&&"num"==s[0].type&&"num"==s[1].type&&"-"==s[1].op?(e=s[0].data,r=s[1].data):2==s.length&&"num"==s[0].type&&"uniop"==s[1].type&&"-"==s[1].op&&(e=s[0].data);var i=this.runtime,a=[];for(const t of i.program){var n=parseInt(t[0]);(null==t[0]||n>=e&&n<=r)&&("control"==t[1][0].type&&"sub"==t[1][0].controlKW&&a.push(""),a.push(t[2]))}this.runtime.enterListMode(a)}_if_get(){return[1]}_if_getkey(){return[1]}_if_read(){return[1]}_if_input(){return[2,2,2,2,2,2,2,2,2,2]}_if_list(){return[2]}_if_run(){return[2]}_stat_info_read(){return"io:Read a value from the data::<Data$ or Data>"}_stat_read(t){var e=t[0];"var"!=e.type&&this.erh.throwError("not a var","parameter 0");var r=this.runtime.readData();void 0===r&&this.erh.throwError("out of data"),"num"==e.varType&&"number"==(typeof r).toLowerCase()||"str"==e.varType&&"string"==(typeof r).toLowerCase()?this.runtime.setVar(e.value,r):"num"==e.varType&&"string"==(typeof r).toLowerCase()?(r=parseInt(r),isNaN(r)&&this.erh.throwError("expected number"),this.runtime.setVar(e.value,r)):"str"==e.varType&&"number"==(typeof r).toLowerCase()&&this.runtime.setVar(e.value,""+r)}_stat_info_get(){return"io:Retrieve the last key pressed::<Key$>"}_stat_get(t){var e=t[0];"var"!=e.type&&this.erh.throwError("not a var","parameter 0");var r=this.input.getKey();null==r?this.runtime.setVar(e.value,""):null!=r.key?this.runtime.setVar(e.value,r.key):this.runtime.setVar(e.value,"???"),this.runtime.flagInputCommand()}_stat_info_getkey(){return"io:Retrieve the last key pressed::<Key$>"}_stat_getkey(t){var e=t[0];"var"!=e.type&&this.erh.throwError("not a var","parameter 0");var r=this.input.getKey();null==r?this.runtime.setVar(e.value,""):null!=r.key?this.runtime.setVar(e.value,r.key):this.runtime.setVar(e.value,r.keyLabel),this.runtime.flagInputCommand()}_stat_info_input(){return"io:Waits for the user to type in a value::<Value>"}_stat_input(e){for(var r=[],s=this.output,i=0;i<e.length;i++)if(0==i){var a=e[0];2==a.parts.length?"str"==a.parts[0].type&&(s.write(a.parts[0].data),"var"==a.parts[1].type&&";"==a.parts[1].op&&r.push(a.parts[1].data)):1==a.parts.length&&r.push(a.parts[0].data)}else t.log("PARS["+i+"]",e[i]),"var"!=e[i].parts[0].type&&this.erh.throwError("not a var","parameter "+i),r.push(e[i].parts[0].data);this.runtime.startConsoleDataInput(r)}_stat_info_restore(){return"io:Set the READ-pointer, to the beginning:"}_stat_restore(t){this.runtime.restoreDataPtr()}_stat_info_waitms(){return"program:Wait a certain time:<MilliSeconds>"}_stat_waitms(t){this.runtime.setWaiting(t[0].value)}_stat_info_rsynch(){return"program:Synch with the renderer thread"}_stat_rsynch(t){this.runtime.enableSynching()}_stat_info_load(){return"program:Load a program in memory:<FileName>"}_stat_load(t){var e=this.runtime;e.printLine(""),0==t.length?e.printLine("searching"):e.printLine('searching for "'+t[0].value+'"'),0==t.length?e.load("*",!1,-1):1==t.length?e.load(t[0].value,!1,-1):2==t.length&&e.load(t[0].value,!1,t[1].value),this.aSync=!0}_stat_info_setdata(){return"experimental:Set data pointer:[<Label>]"}_stat_setdata(t){var e=this.runtime,r=null;t.length>1&&this.erh.throwError("parameters","Setdata takes one optional parameter"),1==t.length&&(r=t[0].value),e.setData(r)}_stat_info_datablocks(){return"experimental:Dump data blocks in memory"}_stat_datablocks(t){var e=this.runtime;0!=t.length&&this.erh.throwError("parameters","Listdata takes no parameterss");var r=e.getDataBlocks();e.enterListMode(r)}_stat_info_loaddata(){return"experimental:Load data in memory:<Filename> [, <Type>, <Label>]"}_stat_loaddata(t){var e=this.runtime,r=null,s="I:CSV";e.printLine(""),1!=t.length&&2!=t.length&&3!=t.length&&this.erh.throwError("parameters","loaddata takes one mandatory and two optional parameters"),t.length>=2&&(s=t[1].value),s.indexOf(":")<0&&this.erh.throwError("invalid type specification",'Expected <Type>:<FileSyntax>. Example: "I:CSV"'),3==t.length&&(r=t[2].value),e.loaddata(t[0].value,s,r),this.aSync=!0}_stat_info_dir(){return"program:List a files on the current file system:[<Path> [,<Device>]]"}_stat_dir(t){var e=this.runtime;e.printLine(""),0!=t.length?1!=t.length?2!=t.length?(this.erh.throwError("parameter","dir takes 0,1 or 2 parameter(s)"),this.aSync=!0):e.dir(t[0].value,t[1].value):e.dir(t[0].value,-1):e.dir("")}_stat_info_fs(){return"program:Set or List (the) filesystem(s):[<FileSystem$>]"}_stat_fs(t){var e=this.runtime;0==t.length?e.listfs():1==t.length&&e.setfs(t[0].value),this.aSync=!0}_stat_info_renumber(){return"program:Renumber the current program"}_stat_renumber(t){this.runtime.renumberProgram(10,10)}_stat_info_vars(){return"program:List all variables to the screen"}_stat_vars(t){var e=this.runtime.getFullVarList();this.runtime.enterListMode(e)}_stat_info_tracevar(){return"program:Trace variable changes:[<VariableName$>]"}_stat_tracevar(t){var e=this.runtime;if(0!=t.length)1!=t.length||e.setTraceVar(t[0].value);else{var r=e.getTraceList();this.runtime.enterListMode(r)}}_stat_info_clrtracevar(){return"program:Stop tracing variables"}_stat_clrtracevar(t){var e=this.runtime;0==t.length&&e.resetTraceVar()}_stat_info_boot(){return"program:Load and run a program:<FileName>"}_stat_boot(t){var e=this.runtime;e.printLine(""),0==t.length?e.printLine("searching"):e.printLine("searching for "+t[0].value),0==t.length?e.load("*",!0,-1):e.load(t[0].value,!0,-1),this.aSync=!0}_stat_info_save(){return"program:Save the current program:<FileName>"}_stat_save(t){var e=this.runtime;0==t.length?e.save(null):1==t.length?e.save(t[0].value,-1):2==t.length&&e.save(t[0].value,t[1].value)}_stat_info_delete(){return"program:Delete a file:<FileName>"}_stat_delete(t){var e=this.runtime;1!=t.length&&2!=t.length?this.erh.throwError("parameter","delete without filename"):1==t.length?e.deleteFile(t[0].value,-1):2==t.length&&e.deleteFile(t[0].value,t[1].value)}_stat_info_run(){return"program:Run the current program"}_stat_run(t){this.runtime.runPGM()}_if_print(){return[2]}isNumber(t){return"number"==typeof t&&isFinite(t)}normalizeIfNumber(t){return this.isNumber(t)&&t>=0?" "+t:""+t}_stat_info_immediate(){return"program:Set flag to flush the render pipeline after each print or poke:<RenderImmediateFlag>"}_stat_immediate(t){1==t.length?this.runtime.setImmediate(t[0].value):this.erh.throwError("parameters","expected 1 parameters, not "+t.length)}_stat_info_print(){return"print:Print text or values to the console:<Value>[;<Value>][;]"}_stat_print(t){var e=this.runtime,r=this.output;if(0!=t.length)if(1!=t.length||0!=t[0].parts.length)for(var s,i=!0,a=0;a<t.length;a++){i=!0,a<t.length-1&&(i=!1),a>0&&r.write("         ");for(var n=t[a],o={parts:[],binaryNegate:n.binaryNegate,negate:n.negate},h=0;h<n.parts.length;h++)"uniop"==n.parts[h].type&&";"==n.parts[h].op&&h==n.parts.length-1&&a==t.length-1?i=!1:o.parts.push(n.parts[h]);if(s=e.evalExpression(o),0==a?r.write(this.normalizeIfNumber(s)):r.write(""+s),i)return void this.runtime.printNewLine();this.runtime.synchPrint()}else this.runtime.printNewLine();else this.runtime.printNewLine()}_stat_info_clr(){return"program:Clear all variables"}_stat_clr(t){return this.runtime.clrPGM()}_fun_info_datalen(){return"experimental:Return length of current datablock"}_fun_datalen(t){return this.runtime.getDataLength()}_fun_info_chr_DLR_(){return"string:Return ascii character:<Ascii Code>"}_fun_chr_DLR_(t){return String.fromCharCode(t[0].value)}_fun_info_str_DLR_(){return"string:Converts number to string: <Number>[,<Base>[,<Trim>]]"}_fun_str_DLR_(t){(t.length<1||t.length>3)&&this.erh.throwError("parameter","str$() takes 1,2 or 3 parameters");var e=t[0].value,r=10,s=!1;t.length>=2&&(r=t[1].value),3==t.length&&(s=t[1].value>0);var i=e.toString(r);return e>=0&&!s?" "+i:i}_fun_info_abs(){return"math:Absolute value"}_fun_abs(t){return t[0].value<0?-t[0].value:t[0].value}_fun_info_len(){return"string:Length of a string"}_fun_len(t){return t[0].value.length}_fun_info_asc(){return"string:ASCII value of a character"}_fun_asc(t){return"STRING"==(typeof t[0].value).toUpperCase()&&t[0].value.length>0?t[0].value.charCodeAt(0):0}_fun_info_val(){return"string:Retrieve number from string"}_fun_val(t){var e=10;2==t.length&&(e=t[1].value),(e<2||e>16)&&this.erh.throwError("base","base should be inbetween 2 and 16");var r=parseInt(t[0].value,e);return isNaN(r)&&this.erh.throwError("invalid number syntax","Could not parse "+t[0].value+" with base"+e),r}_fun_info_hex2dec(){return"string:Retrieve number from hexadecimal string"}_fun_hex2dec(t){1!=t.length&&this.erh.throwError("parameter","HEX2DEC() needs one parameter");var e=parseInt(t[0].value,16);return isNaN(e)&&this.erh.throwError("invalid number syntax","Could not parse "+t[0].value+" with base16"),e}_fun_info_hex_DLR_(){return"string:Format a number as a hexadecimal string"}_fun_hex_DLR_(t){return 1!=t.length&&this.erh.throwError("parameter","HEX$() needs one parameter"),(1*t[0].value).toString(16)}_fun_info_exp(){return"math:Exponent"}_fun_exp(t){return Math.exp(t[0].value)}intGetNextRand(){return this.randIndex=(this.randIndex+this.randStep)%this.randnrs.length,this.randnrs[this.randIndex]}intSeedRand(t){if(t<0){var e=-t,r=Math.floor(11*e);this.randIndex=r%this.randnrs.length,this.randStep=1+r%7,this.randnrs=[];for(var s=0;s<1e4;s++)this.randnrs.push(Math.random())}else{const t=31536e6,i=new Date;let a=Math.round(i.getTime()/t);for(e=-e,r=Math.floor(11*a),this.randIndex=r%this.randnrs.length,this.randStep=1+r%7,this.randnrs=[],s=0;s<1e4;s++)this.randnrs.push(Math.random())}}_fun_info_pad_DLR_(){return"string:Add string padding:<String>, <padChar>,<Length>[,<PadLeft>]"}_fun_pad_DLR_(t){(t.length<3||t.length>4)&&this.erh.throwError("syntax","pad$() takes 3 or 4 parameters");var e=t[0].value,r=t[1].value,s=t[2].value,i=!0;4==t.length&&(i=0!==(i=t[3].value));for(var a="",n=s-e.length,o=0;o<n;o++)a+=r;return i?a+=e:a=e+a,a}_fun_info_rnd(){return"math:Random number between 0 and 1:<SeedOrMode> (0=JS, 1=Seed, NoValue=Default)"}_fun_rnd(t){if(t.length>1&&this.erh.throwError("syntax","rnd takes one parameter"),1==t.length){if(0==t[0].value)return Math.random();this.intSeedRand(t[0].value)}return this.intGetNextRand()}_fun_info_sqr(){return"math:Square Root"}_fun_sqr(t){return Math.sqrt(t[0].value)}_fun_info_log(){return"math:Logaritm"}_fun_log(t){return Math.log(t[0].value)}_fun_info_pos(){return"print:Position"}_fun_pos(t){return this.runtime.getLinePos()}_fun_info_left_DLR_(){return"string:Left part of the string"}_fun_left_DLR_(t){var e=t[0].value;if("string"!=typeof e)throw"@type mismatch";return e.substr(0,t[1].value)}_fun_info_right_DLR_(){return"string:Right part of the string"}_fun_right_DLR_(t){var e=t[0].value;if("string"!=typeof e)throw"@type mismatch";return e.substr(e.length-t[1].value)}_fun_info_mid_DLR_(){return"string:A substring"}_fun_mid_DLR_(t){var e=t[0].value;if("string"!=typeof e)throw"@type mismatch";return 3==t.length?e.substr(t[1].value-1,t[2].value):2==t.length?e.substr(t[1].value-1):void 0}_fun_info_sin(){return"math:Sinus"}_fun_sin(t){return Math.sin(t[0].value)}_fun_info_tri(){return"math+:Triangle"}_fun_tri(t){var e=Math.abs(t[0].value)%1;return e<=.5?2*e:e<=1?1-2*(e-.5):void 0}_fun_info_saw(){return"math+:Saw Tooth"}_fun_saw(t){return Math.abs(t[0].value)%1}_fun_info_tan(){return"math:Tangent"}_fun_tan(t){return Math.tan(t[0].value)}_fun_info_atn(){return"math:ATan function"}_fun_atn(t){return Math.atan(t[0].value)}_fun_info_cos(){return"math:Cosinus"}_fun_cos(t){return Math.cos(t[0].value)}_fun_info_spc(){return"string:Spaces for padding:<SizeOfPadding>"}_fun_spc(t){for(var e="",r=0;r<t[0].value;r++)e+=" ";return e}_max(t,e){return t<e?t:e}_fun_info_int(){return"math:Convert to Integer"}_fun_int(t){return Math.floor(t[0].value)}_fun_info_range(){return"math+:Keep in range:<V>,<MIN>,<MAX>"}_fun_range(t){t.length<3&&this.erh.throwError("parameter","expected 3 parameters");var e=t[0].value,r=t[1].value,s=t[2].value;return e<r?r:e>s?s:e}_fun_info_tab(){return"print:Tab cursor Xpos to the right:<NumberOfTabs>"}_fun_tab(t){this.runtime,t.length<1&&this.erh.throwError("syntax","missing parameter 0");var e=t[0].value;(e<0||e>255)&&this.erh.throwError("illegal quantity","value must be in-between 0 and 255");for(var r=0;r<t[0].value;r++)this.output.write(" ");return""}_fun_info_sgn(){return"math:Sign of number"}_fun_sgn(t){var e=t[0].value;return e<0?-1:e>0?1:0}_fun_info_millis(){return"time:Current time in milliseconds"}_fun_millis(t){return this.runtime.getMillis()}_fun_info_jiffies(){return"time:Current time in 'jiffies'"}_fun_jiffies(t){return this.runtime.getJiffyTime()}}class h{constructor(t,e){this.commands=t,this.extendedcommands=e,this.erh=new r,this.debugFlag=!1}init(){this.CTRL_KW=["IF","THEN","GOTO","AND","NOT","OR","GOSUB","RETURN","FOR","TO","NEXT","STEP","DATA","REM","GOSUB","DIM","END","LET","STOP","DEF","FN","ON","SUB","INTERRUPT0","INTERRUPT1"],this.SHORTCUT_KW=["?"],this.KEYWORDS=this.commands.getStatements();for(var t=this.extendedcommands.getStatements(),e=0;e<t.length;e++)this.KEYWORDS.push(t[e]);for(t=this.commands.getFunctions(),e=0;e<t.length;e++)this.KEYWORDS.push(t[e]);for(t=this.extendedcommands.getFunctions(),e=0;e<t.length;e++)this.KEYWORDS.push(t[e]);for(e=0;e<this.CTRL_KW.length;e++)this.KEYWORDS.push(this.CTRL_KW[e]);for(e=0;e<this.SHORTCUT_KW.length;e++)this.KEYWORDS.push(this.SHORTCUT_KW[e]);this.debugFlag&&console.log("KEYWORDS:",this.KEYWORDS),this.screenCodes2CTRLTable=[];var r=this.screenCodes2CTRLTable;r[""]="",r[""]=""}getKeyWordCodes(){return this.throwError(null,"(Extended) Keywords not yet supported","extended disabled"),this.KWCODES}padArray(t,e){for(var r=e-t.length;r>0;)t.push(null),r--}throwError(t,e,r){var s=r;void 0===s&&(s="syntax"),t&&console.log(" Exception "+r+" at line "+t.lineNumber+" "+e),t&&null!=t.lineNumber&&this.erh.throwError(s,e,t,t.lineNumber),this.erh.throwError(s,e,void 0,-1)}upperCaseNameTokens(t){for(var e=0;e<t.length;e++){var r=t[e];r&&"name"==r.type&&(r.data=r.data.toUpperCase())}return t}removePadding(t){for(var e=[],r=0;r<t.length;r++){var s=t[r];s&&"pad"!=s.type&&e.push(s)}return e}mergeCompTokens(t){for(var e=[],r=0;r<t.length;r++){var s=t[r];if(r>0){var i=t[r-1];"comp"!=s.type&&"eq"!=s.type||"comp"!=i.type&&"eq"!=i.type||(i.type="@@removeme",s.data=i.data+s.data,s.type="comp","><"==s.data?s.data="<>":"=<"==s.data?s.data="<=":"=>"==s.data&&(s.data=">="))}("name"==s.type&&"OR"==s.data||"name"==s.type&&"AND"==s.data||"name"==s.type&&"NOT"==s.data)&&(s.type="bop")}for(r=0;r<t.length;r++)"@@removeme"!=t[r].type&&e.push(t[r]);return e}mergeBrokenUpTokens(t){var e=[];e.push({p1:"REST",p2:"OR",p3:"E",whole:"RESTORE"}),e.push({p1:"S",p2:"TO",p3:"P",whole:"STOP"}),e.push({p1:"IMP",p2:"OR",p3:"T",whole:"IMPORT"}),e.push({p1:"EXP",p2:"OR",p3:"T",whole:"EXPORT"}),e.push({p1:"L",p2:"GET",p3:"URL",whole:"LGETURL"}),e.push({p1:"L",p2:"GET",p3:"NAME",whole:"LGETNAME"}),e.push({p1:"L",p2:"GET",p3:"ID",whole:"LGETID"}),e.push({p1:"GO",p2:"TO",p3:null,whole:"GOTO"}),e.push({p1:"GO",p2:"SUB",p3:null,whole:"GOSUB"}),e.push({p1:"GO",p2:"LINK",p3:null,whole:"GOLINK"}),e.push({p1:"WINDOW",p2:"S",p3:null,whole:"WINDOWS"}),e.push({p1:"UN",p2:"TAG",p3:null,whole:"UNTAG"}),e.push({p1:"LINK",p2:"S",p3:null,whole:"LINKS"}),e.push({p1:"DE",p2:"LET",p3:"E",whole:"DELETE"}),e.push({p1:"LDE",p2:"LET",p3:"E",whole:"LDELETE"}),e.push({p1:"TDE",p2:"LET",p3:"E",whole:"TDELETE"}),e.push({p1:"B",p2:"OR",p3:"DER",whole:"BORDER"}),e.push({p1:"G",p2:"COLOR",p3:"S",whole:"GCOLORS"}),e.push({p1:"CHAR",p2:"COL",p3:null,whole:"CHARCOL"}),e.push({p1:"SFRAME",p2:"CP",p3:null,whole:"SFRAMECP"}),e.push({p1:"SFRAME",p2:"FLIPX",p3:null,whole:"SFRAMEFLIPX"}),e.push({p1:"SFRAME",p2:"FLIPY",p3:null,whole:"SFRAMEFLIPY"}),e.push({p1:"SFRAME",p2:"FX",p3:null,whole:"SFRAMEFX"}),e.push({p1:"TAG",p2:"S",p3:null,whole:"TAGS"}),e.push({p1:"X",p2:"ON",p3:null,whole:"XON"}),e.push({p1:"S",p2:"POS",p3:null,whole:"SPOS"}),e.push({p1:"S",p2:"POKE",p3:null,whole:"SPOKE"}),e.push({p1:"WJ",p2:"IF",p3:"FY",whole:"WJIFFY"}),e.push({p1:"REF",p2:"OR",p3:"MAT",whole:"REFORMAT"});for(var r=[],s=0;s<t.length;s++)r.push(t[s]);for(s=0;s<e.length;s++){var i=e[s];r=this.mergeTokenRange(r,i)}return this.debugFlag&&console.log(r),r}mergeTokenRange(t,e){for(var r=[],s=[],i=0;i<t.length;i++)r[i]=t[i];for(i=1;i<r.length;i++)if(null==e.p3)"name"!=r[i-1].type&&"bop"!=r[i-1].type||"name"!=r[i-0].type&&"bop"!=r[i-0].type||r[i-1].data==e.p1&&r[i-0].data==e.p2&&(r[i-1].data=e.whole,r[i-0].type="removeme");else{if(i<2)continue;"name"!=r[i-2].type&&"bop"!=r[i-2].type||"name"!=r[i-1].type&&"bop"!=r[i-1].type||"name"!=r[i-0].type&&"bop"!=r[i-0].type||r[i-2].data==e.p1&&r[i-1].data==e.p2&&r[i-0].data==e.p3&&(r[i-2].data=e.whole,r[i-1].type="removeme",r[i-0].type="removeme")}var a=0;for(i=0;i<r.length;i++)"removeme"!=r[i].type&&(s[a]=r[i],a++);return s}parseFunParList(t){var e=t.tokens,r=[],s=!0,i=[];for(i.push({type:"sep",data:"@@@all"}),i.push({type:"bracket",data:")"}),i.push();;){var a;if(e.length>0&&"bracket"==e[0].type&&")"==e[0].data)break;if(s){var n=this.parseBoolExpression(t,i);n.type="expr",r.push(n)}else"sep"==(a=e.shift()).type||this.throwError(t,"Expected ',' or ')', got '"+a.data+"'");s=!s}return r}peekIfNextIsOpenBracket(t){var e=t.tokens;return e.length>0&&"bracket"==e[0].type&&"("==e[0].data}parseSubExpression(t){var e=t.tokens.shift();"bracket"==e.type&&"("==e.data||this.throwError(t,'parsing subexpression, expected "bracket", not \''+e.data+"'");var r=[];r.push({type:"bracket",data:")"});var s=this.parseBoolExpression(t,r);return t.tokens.shift(),s.type="expr",s}tokensToString(t){var e="";return"@@@all"==t.data?e+"'"+t.type+"'":e+"'"+t.data+"'"}endTokensToString(t){for(var e="",r=0;r<t.length;r++){var s=t[r];""!=e&&(e+=" "),e+=this.tokensToString(s)}return e}isEndToken(t,e){for(var r=0;r<e.length;r++){var s=e[r];if(t.type==s.type&&t.data==s.data)return!0;if(t.type==s.type&&"@@@all"==s.data)return!0}return!1}parseSimpleExpression(t,e){var r,s=t.tokens;if(0!=s.length){var i,a=void 0;if((i=s.shift())||this.throwError(t,"empty simple expression"),(r=this.isEndToken(i,e))&&this.throwError(t,"empty simple expression"),"op"==i.type&&"-"==i.data){var n=this.parseSimpleExpression(t,e);return n[0].data=-n[0].data,n}return"num"==i.type?a={type:"num",data:i.data}:"str"==i.type&&(a={type:"str",data:i.data}),(i=s.shift())&&((r=this.isEndToken(i,e))||(r=0==t.tokens.length),r||this.throwError(t,"Empty simple expression end expected")),[a,i]}}parseBoolExpression(t,e){for(var r=[],s=t.tokens,i=0;i<e.length;i++)r.push(e[i]);r.push({type:"bop",data:"OR"}),r.push({type:"bop",data:"AND"});for(var a=!0,n=[],o=null;;){var h=this.parseExpression(t,r);if(a&&0==s.length)return h;a=!1;var l=null;if(null!=o&&(l=o.data),h.op=l,h.type="expr",h.dbg="1",n.push(h),!(s.length>0&&"bop"==s[0].type))break;o=s.shift()}if(1==n.length)return n[0].dbg2="len=1",n[0];var u={negate:!1,binaryNegate:!1,type:"expr",parts:[],op:null};for(i=0;i<n.length;i++)u.parts.push(n[i]);return u}parseExpression(t,e){var r=t.tokens;if(0==r.length)return null;for(var s,i={parts:[],negate:!1,binaryNegate:!1},a=!0,n=null,o=i.parts,h=!0,l=!1,u=!1;;){var p,d;if(!(p=r.shift()))break;if(this.isEndToken(p,e)){r.unshift(p);break}if(a){if("num"==p.type)d={type:"num",data:p.data,op:n},l&&(d.data=-d.data),o.push(d),h=!1,l=!1;else if("str"==p.type)d={type:"str",data:p.data,op:n},o.push(d),l&&this.throwError(t,"found negation on a string","type mismatch"),h=!1;else if("bracket"==p.type&&"("==p.data){r.unshift(p);var c=[];c.push({type:"bracket",data:")"});var g=this.parseSubExpression(t,c);g.op=n,g.negate=l,g.binaryNegate=u,o.push(g),h=!1,l=!1}else if("name"==p.type){var f=p.data,m="FN"==f;if(this.peekIfNextIsOpenBracket(t)){p=r.shift();var v=this.parseFunParList(t);if(r.shift(),d={type:"funCall",params:v,op:n,functionName:f},-1==this.KEYWORDS.indexOf(f)&&(d={type:"array",data:f,op:n,indices:v}),null==n&&l){var y={parts:[d],negate:!0,binaryNegate:!1,type:"expr"};o.push(y)}else o.push(d)}else m?(f=(p=r.shift()).data,p=r.shift(),v=this.parseFunParList(t),r.shift(),d={type:"defFnCall",params:v,op:n,functionName:f},null==n&&l?(y={parts:[d],negate:!0,binaryNegate:!1,type:"expr"},o.push(y)):o.push(d)):(d={type:"var",data:p.data,op:n},null==n&&l?(y={parts:[d],negate:!0,binaryNegate:!1,type:"expr"},o.push(y)):o.push(d));l=!1,h=!1}else{if("op"==p.type&&"-"==p.data){l=!l;continue}if("bop"==p.type&&"NOT"==p.data&&h){u=!u,i.binaryNegate=u,this.debugFlag&&console.log("NOT");continue}this.throwError(t,'Expected "number", "string", "symbol" or "bracket", not '+p.data)}n=null}else"op"==p.type||"comp"==p.type||"eq"==p.type||"bop"==p.type?n=p.data:this.throwError(t,'Expected "operator" or one of ('+this.endTokensToString(e)+"), not '"+p.data+"'");a=!a}if(null!=n&&(d={type:"uniop",data:null,op:n},o.push(d)),null==i.parts)return null;s=this.groupParts(i.parts,"^"),s=this.groupParts(s,"/"),s=this.groupParts(s,"*"),s=this.groupParts(s,"+");var _=i;return{parts:s=this.groupParts(s,"-"),negate:_.negate,binaryNegate:_.binaryNegate}}groupParts(t,e){for(var r=[],s=[],i=0;i<t.length;i++)r.push(t[i]);for(i=0;i<r.length;i++){var a=r[i];if(i>0&&a.op==e){var n=r[i-1],o={negate:!1,binaryNegate:!1,type:"expr",parts:[],op:n.op};o.parts[0]=n,o.parts[0].op=null,o.parts[1]=a,r[i-1]=null,r[i]=o}}for(i=0;i<r.length;i++)null!=(a=r[i])&&s.push(a);return s}normalizeStatementName(t){return"?"==t?"print":t}parseAssignment(t,e,r,s,i,a){t.tokens,s.type="assignment",s.var=i,s.arrayAssignment=!1;var n=[];n.push({type:"cmdsep",data:"@@@all"}),s.expression=this.parseBoolExpression(t,n),r.push(s)}parseArrayAssignment(t,e,r,s,i,a){var n=a,o=t.tokens;s.type="assignment",s.var=i,s.arrayAssignment=!0;var h=this.parseFunParList(t);s.indices=h,o.shift(),this.debugFlag&&console.log("tokens after:",o),void 0===(n=o.shift())&&(n={type:"@@@notoken"}),"eq"!=n.type&&this.throwError(t,"Expected =");var l=[];l.push({type:"cmdsep",data:"@@@all"}),s.expression=this.parseBoolExpression(t,l),r.push(s)}parseControlStructure(t,e,r,s,i,a,n){var o=n,h=t.tokens;s.type="control";var l=a;if(s.controlKW=a.toLowerCase(),"@@@notoken"!=o.type&&h.unshift(o),"LET"==l)"name"!=(o=h.shift()).type&&this.throwError(t,"LET expects var name"),a=o.data,void 0===(o=h.shift())&&(o={type:"@@@notoken"}),"eq"==o.type?this.parseAssignment(t,e,r,s,a,o):"bracket"==o.type&&"("==o.data?this.parseArrayAssignment(t,e,r,s,a,o):this.throwError(t,"Unexpected data after 'LET': '"+o.data+"'");else if("DIM"==l){var u=!0;for(s.params=[],s.arrayNames=[];;){if(o=h.shift(),!u){if(void 0===o)break;if("sep"!=o.type||","!=o.data){h.unshift(o);break}o=h.shift()}"name"!=o.type&&this.throwError(t,"DIM expects var name"),a=o.data,void 0===(o=h.shift())&&(o={type:"@@@notoken"}),"bracket"==o.type&&"("==o.data||this.throwError(t,"DIM expects (");var p=this.parseFunParList(t);void 0===(o=h.shift())&&(o={type:"@@@notoken"}),"bracket"==o.type&&")"==o.data||this.throwError(t,"DIM expects )"),s.params.push(p),s.arrayNames.push(a),u=!1}r.push(s)}else if("DEF"==l){"name"==(o=h.shift()).type&&"FN"==o.data||this.throwError(t,"DEF expects FN"),"name"!=(o=h.shift()).type&&this.throwError(t,"DEF FN expects function name");var d=o.data;"bracket"==(o=h.shift()).type&&"("==o.data||this.throwError(t,"DEF FN expects function name and ->( varname )"),"name"!=(o=h.shift()).type&&this.throwError(t,"DEF FN expects function name and ( ->varname )");var c=o.data;"bracket"==(o=h.shift()).type&&")"==o.data||this.throwError(t,"DEF FN expects function name and ( varname -> )"),"eq"==(o=h.shift()).type&&"="==o.data||this.throwError(t,"DEF FN expects function name and ( varname ) -> ="),T=[];var g=this.parseBoolExpression(t,T);this.debugFlag&&console.log("expr = "+g),s.params=[],s.params[0]=d,s.params[1]=c,s.params[2]=g,r.push(s)}else if("GOTO"==l||"GOSUB"==l){var f=-1;if(void 0===(o=h.shift())&&this.throwError(t,"GOTO/GOSUB expects linenumber or label","undef'd statement"),"num"!=o.type){"name"!=o.type&&this.throwError(t,"GOTO/GOSUB expects linenumber or label","undef'd statement");var m=o.data;return void 0!==(o=h.shift())&&"cmdsep"!=o.type&&this.throwError(t,'Expected "command separator", instead of \''+o.data+"'"),s.params=[],s.params[0]=m,s.label=!0,void r.push(s)}f=parseInt(o.data),void 0!==(o=h.shift())&&"cmdsep"!=o.type&&this.throwError(t,'Expected "command separator", instead of \''+o.data+"'"),s.params=[],s.params[0]=f,s.label=!1,r.push(s)}else if("ON"==l){var v=[],y=!1;(T=[]).push({type:"name",data:"GOTO"}),T.push({type:"name",data:"GOSUB"});var _=null;"name"!=(o=h.shift()).type||"INTERRUPT0"!=o.data&&"INTERRUPT1"!=o.data?(h.unshift(o),_=this.parseBoolExpression(t,T)):(y=!0,_={type:"control",data:o.data}),"name"!=(o=h.shift()).type&&this.throwError(t,"ON expects GOTO/GOSUB"),y?"GOTO"!=o.data&&this.throwError(t,"ON INTERRUPT expects GOTO"):"GOTO"!=o.data&&"GOSUB"!=o.data&&this.throwError(t,"ON expects GOTO/GOSUB");var b,x=o.data,w=!1;if(m="","num"!=(o=h.shift()).type?("name"!=o.type&&this.throwError(t,"GOTO/GOSUB expects linenumber or label","undef'd statement"),w=!0,m=o.data):b=parseInt(o.data),v.push(b),y)s.params=[],s.params[0]=_.data.toLowerCase(),s.params[1]=w?m:b,s.label=w,r.push(s);else{for(;null!=(o=h.shift())&&"cmdsep"!=o.type&&"cmdsep"!=o.type;)"sep"==o.type&&","==o.data||this.throwError(t,"ON GOTO/GOSUB expects numberlist"),"num"!=(o=h.shift()).type&&this.throwError(t,"GOTO/GOSUB expects number"),v.push(parseInt(o.data));v.length>1&&this.throwError(t,"ON INTERUPT GOTO expects only a single line number"),s.params=[],s.params[0]=x.toLowerCase(),s.params[1]=_,s.params[2]=v,r.push(s)}}else if("RETURN"==l)f=-1,s.params=[],r.push(s);else if("END"==l)f=-1,s.params=[],r.push(s);else if("STOP"==l)f=-1,s.params=[],r.push(s);else if("FOR"==l){var E,C,P,T=[];if("name"!=(o=h.shift()).type&&this.throwError(t,"For expects variable, no var found, found "+o.type+"/"+o.data),F=o.data,"eq"==(o=h.shift()).type&&"="==o.data||this.throwError(t,"For expects '=', not found, found "+o.type+"/"+o.data),(T=[]).push({type:"name",data:"TO"}),E=this.parseBoolExpression(t,T),"name"==(o=h.shift()).type&&"TO"==o.data||this.throwError(t,"For expects 'to', not found, found "+o.type+"/"+o.data),(T=[]).push({type:"cmdsep",data:":"}),T.push({type:"name",data:"STEP"}),C=this.parseBoolExpression(t,T),P={parts:[{data:"1",op:null,type:"num"}]},void 0!==(o=h.shift()))if("name"==o.type&&"STEP"==o.data)(T=[]).push({type:"cmdsep",data:":"}),P=this.parseBoolExpression(t,T);else if("cmdsep"!=o.type||":"!=o.data)throw"FOR: unexpected token '"+o.data+"'";s.controlKW="for:init",s.params=[],s.params[0]=E,s.params[1]=C,s.params[2]=P,s.variable=F,r.push(s),this.debugFlag&&console.log("command=",s)}else if("NEXT"==l){for(var F,L=!1;(o=h.shift())&&"cmdsep"!=o.type;){if("name"!=o.type)throw"Next expected variable, not '"+o.data+"'";var S={controlKW:"for:next",nextVar:o.data,lineNumber:s.lineNumber,type:s.type};if(r.push(S),L=!0,!(o=h.shift()))break;if("cmdsep"==o.type)break;if("sep"!=o.type||","!=o.data)throw"Expected comma, found '"+o.data+"'"}L||(s.controlKW="for:next",s.nextVar=null,r.push(s))}else if("IF"==l){(T=[]).push({type:"name",data:"THEN"}),T.push({type:"name",data:"GOTO"});var I=this.parseBoolExpression(t,T);if(s.params=[I],"name"==(o=h.shift()).type&&"GOTO"==o.data){var k={data:"GOTO",type:"name"};h.unshift(k)}else h.length>0&&"num"==h[0].type&&(k={data:"GOTO",type:"name"},h.unshift(k));var R=this.parseLineCommands(t).commands;this.debugFlag&&console.log(R),r.push(s);for(var N=0;N<R.length;N++)r.push(R[N])}else if("DATA"==l){var O=[];for((T=[]).push({type:"cmdsep",data:":"}),T.push({type:"sep",data:","});;){var M=this.parseSimpleExpression(t,T);if(void 0===(I=M[0]))throw"DATA: expected data";if(O.push(I),void 0===(o=M[1]))break;if("cmdsep"==o.type&&":"==o.data)break;"sep"==o.type&&","==o.data||this.throwError(t,"data unknown token found "+o.type+"/"+o.data)}s.params=O,r.push(s)}else if("SUB"==l){if(m="",null==(o=h.shift()))throw"SUB expected label";if("name"!=o.type)throw"SUB expected label not '"+o.data+"'";if(m=o.data.toUpperCase(),null!=(o=h.shift()))throw"SUB unexpected data after label";s.label=m,r.push(s)}else if("REM"==l){for(;null!=(o=h.shift()););r.push(s)}else this.throwError(t,s.controlKW+" not implemented")}parseStatementCall(t,e,r,s,i,a){var n=a,o=t.tokens;for(s.statementName=this.normalizeStatementName(i),s.type="call","@@@notoken"!=n.type&&o.unshift(n),s.params=[];;){var h=!1,l=[];l.push({type:"sep",data:"@@@all"}),l.push({type:"cmdsep",data:"@@@all"});var u=this.parseBoolExpression(t,l);if(this.debugFlag&&console.log(u),null!=u)if(s.params.push(u),null!=(n=o.shift()))if(void 0===n&&(h=!0),"cmdsep"==n.type)h=!0;else{if("sep"==n.type)continue;this.throwError(t,"Unexpected characters in statement call: '"+n.data+"'")}else h=!0;else h=!0;if(h){r.push(s);break}}}parseLineCommands(t,e){for(var r=t.tokens,s=[],i={};;){var a,n={},o=!1,h=!1;if(n.lineNumber=t.lineNumber,void 0===(a=r.shift()))break;if("cmdsep"!=a.type){"name"!=a.type&&("trash"!=a.type?this.throwError(t,"Unexpected token, expected symbolname, got '"+oken.data+"'"):this.throwError(t,'Unexpected character, expected "symbolname", got '+a.detail));var l=a.data;this.CTRL_KW.indexOf(a.data)>-1&&(h=!0),(this.KEYWORDS.indexOf(a.data)>-1||"XON"==a.data||this.SHORTCUT_KW.indexOf(a.data)>-1)&&(o=!0),void 0===(a=r.shift())&&(a={type:"@@@notoken"}),h?this.parseControlStructure(t,e,s,n,i,l,a):"eq"==a.type?this.parseAssignment(t,e,s,n,l,a):"bracket"!=a.type||"("!=a.data||o?(o||(console.log("Dump: ",t,e,s,n,l,a),this.throwError(t,"no such command: "+l)),this.parseStatementCall(t,e,s,n,l,a)):this.parseArrayAssignment(t,e,s,n,l,a)}}return{commands:s,handlers:i}}logTokens(t){if(this.debugFlag){for(var e="",r=0;r<t.length;r++)""!=e&&(e+=", "),e+=(s=t[r]).type+":"+s.data;for(console.log(e),r=0;r<t.length;r++){var s=t[r];console.log("token: ",s)}}}parseErrorLine(t){var e=-1,r=new u(new l(t),this.KEYWORDS).tokenize();if(this.debugFlag&&console.log("Tokens after tokenizer"),this.logTokens(r),r=this.upperCaseNameTokens(r),r=this.removePadding(r),r=this.mergeCompTokens(r),r=this.mergeBrokenUpTokens(r),this.debugFlag&&console.log("Tokens after merge"),this.logTokens(r),0==r.length)return null;if("num"==r[0].type){r[0].data,e=r[0].data;var s=t.substr(e.length);return this.parseLine(e+" REM[ERROR] "+s)}throw"Expected line number, when reparsing line with error"}parseLine(t){var e,r,s={lineNumber:-1,commands:[]},i=-1;try{e="tokenizer",r="init";var a=new u(new l(t),this.KEYWORDS);r="parsing tokens";var n=a.tokenize();if(this.debugFlag&&console.log("Tokens after tokenizer"),this.logTokens(n),r="internal",n=this.upperCaseNameTokens(n),n=this.removePadding(n),n=this.mergeCompTokens(n),n=this.mergeBrokenUpTokens(n),this.debugFlag&&console.log("Tokens after merge"),this.logTokens(n),0==n.length)return null;"num"==n[0].type&&(s.lineNumber=n[0].data,i=n[0].data,n.shift());var o={tokens:n,lineNumber:s.lineNumber};e="parser",r="parsing commands";var h=this.parseLineCommands(o),p=h.commands;return s.commands=p,s.raw=t,s.handlers=h.handlers,s}catch(t){if(this.erh.isError(t))throw-1==t.lineNr&&-1!=i&&(t.lineNr=i),t;this.throwError(null,e+" error ("+t+") while "+r)}}getTokens(t,e,r){try{var s=new u(new l(t),this.KEYWORDS).tokenize();return r&&(s=this.removePadding(s)),e&&(s=this.mergeCompTokens(s)),this.logTokens(s),s}catch(t){console.log(t),this.throwError(null,"getTokens error","internal")}}}class l{constructor(t){this.buffer=t,this.index=0,this.lineIndex=1,this.line=1}peek(){return this.buffer.substr(this.index,1)}peek2(){return this.buffer.substr(this.index,2)}unconsume(t){this.index-=t}consume(){var t=this.buffer.substr(this.index,1);this.index++,"\n"==t&&(this.line++,this.lineIndex=1)}EOF(){var t=this.buffer.length;return!(this.index<t)}}class u{constructor(t,e){this.tokens=[],this.reader=t,this.keywords=e,this.greedy=!1}isOpChar(t){return[null!=t.c.match("[+]|[-]|[*]|[/]|[\\%]|[\\^]|[;]"),0]}isCompChar(t){return["<"==t.c||">"==t.c,0]}isEqChar(t){return"="==t.c?[!0,0]:[!1,0]}isNameChar(t){if(t.endFound)return[!1,0];var e=null!=t.c.match("[a-zA-Z0-9$%?]");if("%"==t.c&&(e=!1,null!=t.prev&&null!=t.prev.match("[a-zA-Z0-9]")&&(t.endFound=!0,e=!0)),"$"==t.c&&(t.endFound=!0),this.greedy)if(this.keywords.indexOf(t.seq.toUpperCase())>-1)t.endFound=!0;else if(void 0!==t.seq)for(var r=0;r<this.keywords.length;r++){var s=this.keywords[r];if(t.seq.toUpperCase().indexOf(s)>0)return[e,s.length]}return[e,0]}isNumChar(t){return[null!=t.c.match("[0-9.~]"),0]}isPadChar(t){return" "==t.c||"\t"==t.c||"\n"==t.c||"\r"==t.c?[!0,0]:[!1,0]}isCommandSepChar(t){return":"==t.c?[!0,0]:[!1,0]}isSepChar(t){return","==t.c?[!0,0]:[!1,0]}isAnyChar(t){return[!0,0]}isBracket(t){return"("==t.c||")"==t.c||"["==t.c||"]"==t.c?[!0,0]:[!1,0]}isStrChar(t){return t.endFound?[!1,0]:0==t.index?'"'==t.c?(t.inString=!0,[!0,0]):[!1,0]:t.inString?(t.index>0&&'"'==t.c&&(t.endFound=!0),[!0,0]):[!1,0]}normalizeToken(t){var e=t;return e.type=t.type,"str"==e.type&&(e.data=t.data.substr(1,t.data.length-2)),e}readChars(t,e,r,s){for(var i={type:e,data:""},a={index:0,prev:null,seq:""};!t.EOF();){var n=t.peek();a.seq+=n,a.c=n;var o=this[r](a);if(o[1]>0){t.unconsume(o[1]-1),a.seq=a.seq.substr(0,a.seq.length-o[1]),i.data=a.seq;break}if(!o[0])return this.normalizeToken(i);if(i.data+=n,t.consume(),a.index++,a.prev=n,"chr"==s)break}return this.normalizeToken(i)}tokenize(){var t=this.reader,e=[],r=[];for(r.push(["pad","isPadChar","str"]),r.push(["str","isStrChar","str"]),r.push(["num","isNumChar","str"]),r.push(["name","isNameChar","str"]),r.push(["op","isOpChar","chr"]),r.push(["comp","isCompChar","chr"]),r.push(["eq","isEqChar","chr"]),r.push(["bracket","isBracket","chr"]),r.push(["sep","isSepChar","chr"]),r.push(["cmdsep","isCommandSepChar","chr"]),r.push(["trash","isAnyChar","chr"]);!t.EOF();){for(var s=t.peek(),i=!1,a=0;a<r.length;a++){var n=r[a],o={index:0,c:s};if(this[n[1]](o)[0]){var h=this.readChars(t,n[0],n[1],n[2]);"name"==h.type&&(h.data=h.data.toUpperCase()),"trash"==h.type&&(h.detail="'"+h.data+"' (ASCII-code="+h.data.charCodeAt(0)+")"),e.push(h),i=!0;break}}if(!i)throw"syntax error, unexpected character: '"+s+"' =>"+t.line+":"+t.lineIndex}return e}}class p{constructor(){}getCategoriesNormalize(t){return[Object.getOwnPropertyNames(t[0]),t[1]]}getCategoriesIntermediate(t,e){var r=e.getStatements(!0),s=e.getFunctions(!0),i=t[0],a=t[1];void 0===i.general&&(i.general=0,a.general=[]);for(var n=0;n<r.length;n++){var o={};(u=void 0!==e[l=(h=r[n]).replace("_stat_","_stat_info_")]?e[l]():"general").indexOf(":")>0&&(u.split(":").length,o.description=u.split(":")[1],o.input=u.split(":")[2],o.output=u.split(":")[3],u=u.split(":")[0]),h=h.replace("_stat_","").toUpperCase(),void 0===i[u]&&(i[u]=0,a[u]=[]),i[u]++,a[u].push({name:h,attribs:o})}for(n=0;n<s.length;n++){var h,l,u;o={},(u=void 0!==e[l=(h=s[n]).replace("_fun_","_fun_info_")]?e[l]():"general").indexOf(":")>0&&(u.split(":").length,o.description=u.split(":")[1],o.input=u.split(":")[2],o.output=u.split(":")[3],u=u.split(":")[0]),h=h.replace("_fun_","").replace("_DLR_","$").toUpperCase()+"()",void 0===i[u]&&(i[u]=0,a[u]=[]),i[u]++,a[u].push({name:h,attribs:o})}return[i,a]}}t.log("Starting"),t.log("Starting wsys"),t.processes=new class{constructor(t){const e=9660,r=9670,s=9671,i=9673,a=9674;this.STATE_NULL=e,this.STATE_LASTSTATE=9661,this.STATE_CLI=r,this.STATE_RUNNING=s,this.STATE_INPUT=9672,this.STATE_WAITING=i,this.STATE_SYNCHING=a,this.sys=t,this.processes=[];var n=this,o=n.processes;this.idlerInterval=null,this.runInterval=null,this.waitTimeOut=null;var h=e,l=e;this.avgIdlerTime=10;var u,p,d,c,g,f=function(t,e){9672==t?n.killRuntimeInterval():t==i?(n.killRuntimeInterval(),n.startWaitingTimeOut(e)):t==a?(n.killRuntimeInterval(),n.killWaitingTimeOut(),n.sys.postsynchrequest(0)):t==r?(n.killRuntimeInterval(),n.killWaitingTimeOut()):t==s&&(n.killWaitingTimeOut(),n.startRuntimeInterval(e)),h=l,l=t};this.idlerFunction=function(){var t=(new Date).getTime();if(l!=s&&l!=i&&l!=a){var e=(g=o[0]).cpuNeeded();if(e>.1){var r=g.getStatus();return n.sys.poststatus(0,r),void f(s,e)}u=g.cycle(),d=u[0],p=u[1],c=u[2],d&&(r=g.getStatus(),n.sys.poststatus(0,r)),p!=l&&f(p,c);var h=(new Date).getTime()-t;n.avgIdlerTime=(99*n.avgIdlerTime+h)/100}},this.runningFunction=function(){l==s&&(u=g.cycle(),p=u[1],c=u[2],p!=l&&f(p,c))},this.waitingFunction=function(){n.runInterval=null,g.clearWaiting(),f(h,0),l==s&&n.runningFunction()},this.synch=function(t){n.runInterval=null,g.clearSynching(),f(h,0),l==s&&n.runningFunction()},f(r)}startIdlerInterval(){null==this.idlerInterval&&(this.idlerInterval=setInterval(this.idlerFunction,200))}startRuntimeInterval(t){if(null==this.runInterval){var e=Math.floor(220-200*t);this.runInterval=setInterval(this.runningFunction,e)}}killRuntimeInterval(){null!=this.runInterval&&(clearInterval(this.runInterval),this.runInterval=null)}startWaitingTimeOut(t){null==this.waitTimeOut&&(this.waitTimeOut=setTimeout(this.waitingFunction,t,t))}killWaitingTimeOut(){null!=this.waitTimeOut&&(clearTimeout(this.waitTimeOut),this.waitTimeOut=null)}getTicks(){return this.count}get(t){return this.processes[t]}register(t){var e=this.processes.length;return this.processes.push(t),t.processId=e,t.procIf=this,this.startIdlerInterval(),e}getRoot(){return this.processes[0]}}(t),t.input=new class{constructor(t){this.keyPress=[],this.interactive=!1,this.sys=t}setHandler(t){this.handlerClazz=t}setInterActive(t){this.interactive=t,this.sys.blinkMode(t)}getInterActive(){return this.interactive}flush(){this.keyPress=[]}inputKeyHandler(t){var e=this.handlerClazz;"Escape"!=t.keyLabel?(e.keyInterrupt("keypress",t),this.interactive?e.interactiveKeyHandler(t):this.keyPress.push(t)):e.stop()}getKey(){return this.keyPress.shift()||null}}(t),t.out=new class{constructor(t){this.sys=t,this.cursorOn=!1,this.cols=80,this.rows=30,this.x=0,this.y=0,this.hidden=!1,this.dc=!1,this.dcCmd=!1,this.colors={},this.reverse=!1,this.defaultFG=5,this.defaultBG=0,this.colors.txtBgColor=this.defaultBG,this.colors.txtColor=this.defaultFG,this.initialized=!1,this.changes={all:!1,list:[]},this.pokeFlush=!0}isActive(){return this.initialized&&!this.hidden}reInit(t,e){this._int_initMode(t,e)}set(t,e,r){this._int_initMode(t,e),this._int_setCells(r)}destroy(){this.cellel=void 0,this.changes={all:!1,list:[]},this.initialized=!1}_int_addChangeAll(){this.changes.all=!0,this.changes.list=[]}changeCount(){return this.changes.all?65535:this.changes.list.length}_int_addChange(t){if(this.changes.all)this.changes.list.length>0&&(this.changes.list=[]);else{var e=this.changes.list;if(e.length>0){var r=e[e.length-1],s=t;if(r.y1==r.y2&&s.y1==s.y2&&r.y1==s.y1&&s.x1==r.x2+1){r.x2;for(var i=r.cells[0],a=0;a<t.cells[0].length;a++){var n=t.cells[0][a];i.push(n)}return void(r.x2=s.x2)}}this.changes.list.push(t)}}_int_flushAll(){this.changes.all=!0,this.changes.list=[],this._int_flush()}_int_getArea(t,e,r,s){for(var i=[],a=e;a<=s;a++){for(var n=[],o=t;o<=r;o++)n.push(this.cellel[a][o]);i.push(n)}return{cells:i,x1:t,y1:e,x2:r,y2:s}}_int_flush(){this.changes.all?(this.sys.post("textupdate-all",{fg:this.colors.txtColor,bg:this.colors.txtBgColor,cx:this.x,cy:this.y,cells:this.cellel,cursorMode:this.cursorMode}),this.changes.all=!1):this.changes.list.length>0?(this.sys.post("textupdate",{fg:this.colors.txtColor,bg:this.colors.txtBgColor,cx:this.x,cy:this.y,areasList:this.changes.list,cursorMode:this.cursorMode}),this.changes.list=[]):this.sys.post("textupdate",{fg:this.colors.txtColor,bg:this.colors.txtBgColor,cx:this.x,cy:this.y,areasList:[],cursorMode:this.cursorMode})}attach(t,e){this._int_initMode(t,e)}setPokeFlush(t){this.pokeFlush=t}peekc(t,e){return this.cellel[e][t].txt.codePointAt(0)}peekcl(t,e,r){var s=this.cellel[e][t];return 0==r?s.fg:1==r?s.bg:s.fg+16*s.bg}pokec(t,e,r){try{this.cellel[e][t].txt=String.fromCodePoint(r);var s=this._int_getArea(t,e,t,e);this._int_addChange(s),this.pokeFlush&&this._int_flush()}catch(r){throw"Cannot pokec to adress ("+t+","+e+")"}}pokecl(t,e,r,s){try{var i=this.cellel[e][t];void 0!==r&&(i.fg=r),void 0!==s&&(i.bg=s);var a=this._int_getArea(t,e,t,e);this._int_addChange(a),this.pokeFlush&&this._int_flush()}catch(r){throw"Cannot pokec to adress ("+t+","+e+")"}}pokeccl(t,e,r,s,i){try{var a=this.cellel[e][t];a.txt=String.fromCodePoint(r),void 0!==s&&(a.fg=s),void 0!==i&&(a.bg=i);var n=this._int_getArea(t,e,t,e);this._int_addChange(n),this.pokeFlush&&this._int_flush()}catch(r){throw"Cannot pokec to adress ("+t+","+e+")"}}triggerFlush(){this._int_flush()}_int_initMode(t,e){this.initialized&&this.destroy(),this.sys,this.x=0,this.y=0,this.rows=e,this.cols=t,this.textArea(this.cols,this.rows,-1,-1),this.colors.txtBgColor=this.defaultBG,this.colors.txtColor=this.defaultFG,this.cellel=[];for(var r=0;r<this.rows;r++){for(var s=[],i=0;i<this.cols;i++){var a={txt:" ",fg:this.colors.txtColor,bg:this.colors.txtBgColor};s.push(a)}this.cellel.push(s)}this.changes={all:!0,list:[]},this._int_flushAll(),this.sys.log("TEXTAREA w Ready."),this.initialized=!0,this.pokeFlush=!0}_int_setCells(t){this.cellel=[];for(var e=0;e<this.rows;e++){for(var r=[],s=0;s<this.cols;s++){var i={txt:t[e][s].txt,fg:t[e][s].fg,bg:t[e][s].bg};r.push(i)}this.cellel.push(r)}this.changes={all:!1,list:[]}}getDimensions(){return[this.cols,this.rows]}getCurrentLine(){for(var t=this.y,e="",r=0;r<this.acols;r++){var s=r+this.ax0;e+=this.cellel[t][s].txt}return e}getLineFrom(t,e){for(var r="",s=this.acols+this.ax0-1,i=t;i<s;i++)r+=this.cellel[this.ay0+e][i].txt;return r}setDefault(t,e){this.defaultBG=e,this.defaultFG=t}colorReset(){this.colors.txtBgColor=this.defaultBG,this.colors.txtColor=this.defaultFG;for(var t=this.defaultFG,e=this.defaultBG,r=0;r<this.rows;r++)for(var s=r,i=0;i<this.cols;i++){var a=i,n=this.cellel[s][a];n.fg=t,n.bg=e}this.changes={all:!0,list:[]},this._int_flushAll()}reset(){this.textArea(this.cols,this.rows,-1,-1),this.colors.txtBgColor=this.defaultBG,this.colors.txtColor=this.defaultFG,this.pokeFlush=!0,this.clear()}textArea(t,e,r,s){var i=this.cols-t,a=this.rows-e;this.ax0=r<0?Math.floor(i/2):r,this.ay0=s<0?Math.floor(a/2):s,this.acols=t,this.arows=e,this.x=this.ax0,this.y=this.ay0}clear(){for(var t=0;t<this.arows;t++)for(var e=this.ay0+t,r=0;r<this.acols;r++){var s=this.ax0+r,i={txt:" ",fg:this.colors.txtColor,bg:this.colors.txtBgColor};this.cellel[e][s]=i}this.changes={all:!0,list:[]},this.x=this.ax0,this.y=this.ay0,this._int_flushAll()}jumpTo(t){if("home"==t&&(this.y=this.ay0,this.x=this.ax0),"end"==t)this.y=this.ay0+this.arows-1,this.x=this.ax0+this.acols-1;else if("line-start"==t)this.x=this.ax0;else if("line-end"==t)this.x=this.ax0+this.acols-1;else if("text-end"==t){var e="DC",r=this.x;this.x=this.ax0+this.acols-1;for(var s=this.ax0+this.acols-1;this.x>=this.ax0;){if(" "!=(e=this.cellel[this.y][this.x].txt)){this.x++,this.x>s&&(this.x=s);break}this.x--}var i=this.x;for(this.x=r,e="DC";this.x<this.ax0+this.acols-1&&" "!=e;)this.x++,e=this.cellel[this.y][this.x].txt;this.x>i&&(this.x=i)}else if("text-end-all"==t)for(e="DC",this.x=this.ax0+this.acols-1,s=this.ax0+this.acols-1;this.x>=this.ax0;){if(" "!=(e=this.cellel[this.y][this.x].txt)){this.x++,this.x>s&&(this.x=s);break}this.x--}else if("text-start"==t)for(e="DC";this.x>this.ax0&&" "!=e;)this.x--,e=this.cellel[this.y][this.x].txt;this._int_flush()}cursorMove(t){"up"==t?this.y>this.ay0&&this.y--:"down"==t&&(this.y<this.ay0+this.arows-1?this.y++:this.y==this.ay0+this.arows-1&&(this.__int_scrollDown(),this._int_addChangeAll())),"left"==t?this.x>this.ax0&&this.x--:"right"==t&&this.x<this.ax0+this.acols-1&&this.x++,this._int_flush()}backspace(){this.x!=this.ax0&&this.x--,this.__int_scrollLineLeftFrom(this.x,this.y);var t=this._int_getArea(this.x,this.y,this.cols-1,this.y);this._int_addChange(t),this._int_flush()}delete(){this.__int_scrollLineLeftFrom(this.x,this.y);var t=this._int_getArea(this.x,this.y,this.cols-1,this.y);this._int_addChange(t),this._int_flush()}nl(){if(this.x=this.ax0,this.y++,this.y-this.ay0>=this.arows)return this.__int_scrollDown(),this.y=this.ay0+(this.arows-1),void this._int_flushAll();this._int_flush()}__int_nl(){return this.x=this.ax0,this.y++,this.y-this.ay0>=this.arows?(this.__int_scrollDown(),this.y=this.ay0+(this.arows-1),{scroll:!0}):{scroll:!1}}writeln(t){for(var e=0;e<t.length;e++){var r=t.substr(e,1);this.__int_write_direct_ch(r)}this.__int_nl().scroll&&this._int_addChangeAll(),this._int_flush()}_int_write(t,e){for(const r of t)this.__int_write_direct_ch(r,e)}write(t){this._int_write(t),this._int_flush()}insert(t){this._int_write(t,!0),this._int_flush()}__int_scrollLinesDownFrom(t){for(var e=this.rows-1;e>t;e--)for(var r=0;r<this.cols;r++){var s=this.cellel[e-1][r],i=this.cellel[e][r];i.fg=s.fg,i.bg=s.bg,i.txt=s.txt}for(r=0;r<this.cols;r++)(s=this.cellel[e][r]).txt=" ";this._int_addChangeAll()}ScrollDownByCurrentLine(){this.y<this.rows-1&&(this.__int_scrollLinesDownFrom(this.y),this._int_flush())}__int_scrollLineRightFrom(t,e){var r=this.ax0+this.acols-1;if(t!=r)for(var s=r;s>t;s--){var i=this.cellel[e][s-1],a=this.cellel[e][s];a.fg=i.fg,a.bg=i.bg,a.txt=i.txt}}__int_scrollLineLeftFrom(t,e){var r=this.ax0+this.acols-1;if(t!=r)for(var s=t;s<r;s++){var i=this.cellel[e][s+1],a=this.cellel[e][s];a.fg=i.fg,a.bg=i.bg,a.txt=i.txt}}__int_write_direct_ch(t,e){var r=t.codePointAt(0);if(this.dc&&this.dcCmd)return this.dc=!1,this.dcCmd=!1,void this._int_control(this.dcCmdCode,r);if(this.dc&&!this.dcCmd)return this.dcCmd=!0,void(this.dcCmdCode=r);if(17==r)return this.dc=!0,void(this.dcCmd=!1);var s=this.cellel[this.y][this.x];if(null!=s){var i;e&&(this.__int_scrollLineRightFrom(this.x,this.y),i=this._int_getArea(this.x,this.y,this.ax0+this.acols-1,this.y),this._int_addChange(i)),s.txt=t,this.reverse?(s.bg=this.colors.txtColor,s.fg=this.colors.txtBgColor):(s.fg=this.colors.txtColor,s.bg=this.colors.txtBgColor);var a=this.x,n=this.y;if(this.x++,this.x-this.ax0>this.acols-1&&(this.x=this.ax0,this.__int_nl().scroll))return void this._int_addChangeAll();i=this._int_getArea(a,n,a,n),this._int_addChange(i)}else console.log("cell at "+this.x+","+this.y+" == null ")}writec(t){"\n"!=t?(this.__int_write_direct_ch(t),this._int_flush()):this.__int_nl().scroll&&this._int_addChangeAll()}setFilter(t){this.sys.post("gfilter",{d:t})}_int_control(t,e){16==t?this.colors.txtColor=e:17==t?this.colors.txtBgColor=e:18==t?this.sys.post("border",{d:e}):24==t?this.clear():12==t?this.reset():25==t||(64==t?this.reverse=!1:65==t?this.reverse=!0:this.__int_write_direct_ch("?"))}setPos(t,e){this._int_setPos(t,e),this._int_flush()}setCursorMode(t){this.cursorMode=t,this._int_flush()}setCursorPos(t,e){if(t<0||e<0)throw"pos("+t+","+e+") < 0";if(t>=this.acols||e>=this.arows)throw"pos("+t+","+e+") > max";void 0!==t&&(this.x=t+this.ax0),void 0!==e&&(this.y=e+this.ay0),this._int_flush()}getCursorPos(){return[this.x-this.ax0,this.y-this.ay0]}control(t,e){this._int_control(t,e),this._int_flush()}_int_setPos(t,e){t>=0&&(this.x=t+this.ax0,this.x-this.ax0>=this.acols&&(this.x=this.acols-1)),e>=0&&(this.y=e+this.ay0,this.y-this.ay0>=this.arows&&(this.y=this.arows-1))}center(t,e){if(!(t.length>this.cols)){var r=t.length/2,s=[this.acols,this.arows],i=Math.floor(s[0]/2-r);if(this._int_setPos(i,-1),this._int_write(t),!e&&this.__int_nl().scroll)return void this._int_addChangeAll();var a=this._int_getArea(this.ax0,this.y,this.acols-1,this.y);this._int_addChange(a),this._int_flush()}}__int_scrollDown(){for(var t=this.ax0,e=this.ay0,r=0;r<this.acols;r++)for(var s=r+t,i=0;i<this.arows-1;i++){var a=i+e,n=this.cellel[a][s],o=this.cellel[a+1][s];n.txt=o.txt,n.fg=o.fg,n.bg=o.bg}var h=e+(this.arows-1);for(r=0;r<this.acols;r++)s=r+t,(n=this.cellel[h][s]).txt=" ",this.reverse?(n.fg=this.colors.txtBgColor,n.bg=this.colors.txtColor):(n.fg=this.colors.txtColor,n.bg=this.colors.txtBgColor)}}(t),t.bout=new class{constructor(t){this.sys=t,this.lineColor=1,this.changes={},this.changes.flag=!1,this.changes.pixels=[],this.origin(0,0,1,1)}origin(t,e,r,s){this.ox0=t,this.oy0=e,this.odx=r,this.ody=s;var i=["m",void 0,"p"],a="x"+i[r+1]+"y"+i[s+1];this._int_convertxy=this.getConvertFunc(a)}reInit(t,e){this.width=t,this.height=e}attach(t,e){this.reInit(t,e)}isActive(){return this.width>0}getDimensions(){return[this.width,this.height]}triggerFlush(){this.changes.flag&&(this.sys.post("gfxupdate",{pixels:this.changes.pixels}),this.changes.pixels=[],this.changes.flag=!1)}_int_flush(){this.changes.flag&&(this.sys.post("gfxupdate",{pixels:this.changes.pixels}),this.changes.pixels=[],this.changes.flag=!1)}setLineColor(t){this.lineColor=t,this.sys.post("nativeout",{action:"gcolor",params:{c:t}})}setFillColor(t){this.fillColor=t,this.sys.post("nativeout",{action:"fcolor",params:{c:t}})}getConvertFunc(t){var e=this;return"xpyp"==t?function(t,r){return[Math.floor(t+e.ox0),Math.floor(r+e.oy0)]}:"xpym"==t?function(t,e){return[Math.floor(t+this.ox0),Math.floor(this.oy0-e)]}:"xmyp"==t?function(t,r){return[Math.floor(e.ox0-t),Math.floor(r+e.oy0)]}:"xmym"==t?function(t,r){return[Math.floor(e.ox0-t),Math.floor(this.oy0-r)]}:void 0}plot(t,e){var r=this._int_convertxy(t,e),s={x:r[0],y:r[1],c:this.lineColor};this.changes.pixels.push(s),this.changes.flag=!0}line(t,e,r,s){var i=this._int_convertxy(t,e),a=this._int_convertxy(r,s);this.sys.post("nativeout",{action:"line",params:{x0:i[0],y0:i[1],x1:a[0],y1:a[1]}})}fillRect(t,e,r,s){var i=this._int_convertxy(t,e);this.sys.post("nativeout",{action:"fillRect",params:{x:i[0],y:i[1],w:r,h:s}})}destroy(){}}(t),t.pfields=new class{constructor(t){this.sys=t,this.current=0,this.enabledFlag=!1,this.list=null}enable(t){this.enabledFlag=t}set(t){this.list=t}enabled(){return this.enabledFlag}setEnable(t,e,r){this.sys.post("pfenable",{processId:t,ix:e,flag:r})}select(t,e){if(e>=this.list.length)throw"No such playfield "+e;if(null==this.list[e])throw"Playfield not active";this.sys.post("pfselect",{processId:t,ix:e}),this.current=e}scrollpos(t,e,r,s){if(e>=this.list.length)throw"No such playfield "+e;if(null==this.list[e])throw"Playfield not active";this.sys.post("pfscrollpos",{processId:t,ix:e,x:r,y:s})}viewdefine(t,e,r,s,i,a){if(e>=this.list.length)throw"No such playfield "+e;if(null==this.list[e])throw"Playfield not active";this.sys.post("pfviewsize",{processId:t,ix:e,x:r,y:s,w:i,h:a})}init(t,e,r,s){this.sys.post("pfinit",{processId:t,ix:e,bcwC:r,brhC:s,fgColor:1,bgColor:0})}old_init(t,e,r,s,i,a,n,o){this.sys.post("pfinit",{processId:t,ix:e,isCurrentIx:this.current==e,xo:r,yo:s,cC:i,rC:a,bcwC:n,brhC:o,fgColor:1,bgColor:0})}}(t),t.audio=new class{constructor(t){this.sys=t,this.userInput=!1}flagUserInput(){this.userInput=!0}playBeep(t,e,r){this.userInput&&this.sys.post("audio",{method:"playBeep",parCount:3,p1:t,p2:e,p3:r})}playSound(t,e,r){this.userInput&&this.sys.post("audio",{method:"playSound",parCount:3,p1:t,p2:e,p3:r})}volume(t){this.userInput&&this.sys.post("audio",{method:"setVolume",parCount:1,p1:t})}reset(){this.userInput&&this.sys.post("audio",{method:"reset",parCount:0})}attackDecayRelease(t,e,r,s){this.userInput&&this.sys.post("audio",{method:"channelSetAttackDecayRelease",parCount:4,p1:t,p2:e,p3:r,p4:s})}channelVolume(t,e){this.userInput&&this.sys.post("audio",{method:"channelVolume",parCount:2,p1:t,p2:e})}channelFrequency(t,e){this.userInput&&this.sys.post("audio",{method:"channelFrequency",parCount:2,p1:t,p2:e})}channelSustainVolume(t,e){this.userInput&&this.sys.post("audio",{method:"channelSetSustainLevel",parCount:2,p1:t,p2:e})}addEffect(t,e,r,s){this.userInput&&this.sys.post("audio",{method:"addEffect",parCount:4,p1:t,p2:e,p3:r,p4:s})}clearEffect(t){this.userInput&&this.sys.post("audio",{method:"clearEffect",parCount:1,p1:t})}playEffect(t,e){this.userInput&&this.sys.post("audio",{method:"playEffect",parCount:2,p1:t,p2:e})}}(t),t.rootProcId=-1,self.onmessage=function(e){try{var r=e.data;if("keydown"==r.type)t.input.inputKeyHandler(r),t.audio.flagUserInput();else if("message"==r.type){var a=r.processId;(h=t.processes.get(a)).receiveMessage(r.message,r.messageObject)}else if("synchreply"==r.type)a=t.processes.synch(r.processId);else if("interrupt"==r.type)(h=t.processes.get(t.rootProcId)).interrupt(0,r.sub,r.data);else if("loadpgm"==r.type){t.log("Received 'loadpgm' message. Loaded "+r.pgmData.length+" bytes..");var o=new s(t),h=new i(t,o);t.log("Context created, parsing program");var l=h.bootPGM(r.pgmData,r.QPath);t.log("Parsed program => RUN"),l?(h.runPGM(),t.log("Program started...")):h.stop(),a=t.processes.register(h),t.log("Basic program registered as process "+a+"."),-1==t.rootProcId&&(t.rootProcId=a),n.addRuntime(h)}else if("inittxtarea"==r.type)t.log("init with: "+JSON.stringify(r)),t.out.attach(r.w,r.h);else if("initcolors"==r.type)t.log("init colors with: "+JSON.stringify(r)),t.out.setDefault(r.colors.fg,r.colors.bg),t.out.control(18,r.colors.border),t.out.reset();else if("systeminfo"==r.type)t.log("systeminfo with: "+JSON.stringify(r).substr(0,50)+"..."),t.screenModes=r.modes,t.displayMode=r.mode,t.windowWidth=r.windowWidth,t.windowHeight=r.windowHeight;else if("setcfg"==r.type)t.log("init with: "+JSON.stringify(r)),t.setcfg(r.cfg);else if("initbitmap"==r.type)t.log("init with: "+JSON.stringify(r)),t.bout.attach(r.w,r.h);else if("clipboardCopy"==r.type){var u=(h=t.processes.get(t.rootProcId)).getProgramAsText();t.export(u,"clipboard"),h.isReady()&&(h.printLine("(!)Copied program to clipboard"),h.printReady()),t.log("clipboard copy")}else if("export"==r.type)u=(h=t.processes.get(t.rootProcId)).getProgramAsText(),t.export(u,"disk"),h.isReady()&&(h.printLine("(!)Export program to disk"),h.printReady()),t.log("Export to disk");else if("showList"==r.type){h=t.processes.get(t.rootProcId);var p=r.list;h.enterListMode(p)}else if("list"==r.type){h=t.processes.get(t.rootProcId),p=["LIST",""];for(const t of h.program)parseInt(t[0]),p.push(t[2]);h.enterListMode(p)}else if("renumber"==r.type)(h=t.processes.get(t.rootProcId)).renumberProgram(10,10),p=["RENUMBER"],h.enterListMode(p);else if("new"==r.type)(h=t.processes.get(t.rootProcId)).isRunning()||(h.new(),h.enterListMode(["NEW",""]));else if("pastpgm"==r.type){if(!(h=t.processes.get(t.rootProcId)).isRunning()){h.new(),h.resetConsole();var d=h.textLinesToBas(r.data.split("\n")),c=d.pgm;if(h.setProgram(c),d.exception)throw d.exception}}else if("vars"==r.type){var g=(h=t.processes.get(t.rootProcId)).getFullVarList();g.unshift(""),g.unshift("VARS"),h.enterListMode(g)}else if("datablocks"==r.type){p=(h=t.processes.get(t.rootProcId)).getDataBlocks();for(var f=["DATABLOCKS",""],m=0;m<p.length;m++)f.push(p[m]);h.enterListMode(f)}else if("stopMenu"==r.type)(h=t.processes.get(t.rootProcId)).isRunning()?(h.stop(),h.toggleMenu()):h.toggleMenu();else if("toggleMenu"==r.type)(h=t.processes.get(t.rootProcId)).toggleMenu();else if("help"==r.type)(h=t.processes.get(t.rootProcId)).isReady()&&(h.clearScreen(),h.printLine("HELP"),h.printHelp(),h.printLine(""),h.printLine("For more help type:"),h.printLine("HELP <option>"),h.printLine(""),h.printReady());else if("run"==r.type)(h=t.processes.get(t.rootProcId)).isReady()&&(h.clearScreen(),h.printLine("RUN"),h.runPGM());else if("stop"==r.type)(h=t.processes.get(t.rootProcId)).isRunning()&&h.stop();else if("resetConsole"==r.type)(h=t.processes.get(t.rootProcId)).isReady()&&h.resetConsole();else if("colorReset"==r.type)(h=t.processes.get(t.rootProcId)).isReady()&&h.colorReset(r.colors);else if("clearScreen"==r.type)(h=t.processes.get(t.rootProcId)).isReady()&&h.clearScreen();else{var v=e.data;v&&(v=v.type)||(v="????"),t.logerr("Ignored unclassified message type ("+v+") for 'APP://"+t.appName+"':  "+JSON.stringify(e.data))}}catch(e){e.message?t.logerr(e.message+" at "+e.fileName+":"+e.lineNumber):e.clazz&&(t.logerr(e.clazz+": "+e.detail+" at "+e.lineNr),t.out.writeln("?"+e.clazz+" error at "+e.lineNr)),t.logerr(JSON.stringify(e))}}})();
//# sourceMappingURL=basicworker.js.map