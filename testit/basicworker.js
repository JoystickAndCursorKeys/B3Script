(()=>{var t={appName:"unknown",unique:0};console=t,function(){function e(t,e){postMessage({type:t,message:e})}t.post=e,t.log=function(){for(var t=Array.prototype.slice.call(arguments),r=[],s=0;s<t.length;s++)r.push(JSON.stringify(t[s]));e("syslog",r)},t.logerr=function(){var t=Array.prototype.slice.call(arguments);e("syserr",t)},t.setDisplayMode=function(t,r){e("displaymode",{processId:t.processId,m:r})},t.blinkMode=function(t){e("blinkMode",{m:t})},t.html={},t.html.html=function(){var t=Array.prototype.slice.call(arguments);e("html",t)},t.html.htmlnode=function(){var t=Array.prototype.slice.call(arguments);e("htmlnode",t)},t.html.get=function(){return e("htmlget",args),{wait_for_result:!0}},t.export=function(t){e("export",{code:t})}}();class e{constructor(t,e,r){this.name=t,this.indices=e,this.buffer=null,this.defaultValue=r}getIndexCount(){return this.indices.length}_check(t){if(t.length!=this.indices.length)throw"00:index dimension mismatch for array "+this.name;for(var e=0;e<t.length;e++){if(t[e]>this.indices[e])throw"01:index "+t[e]+" out of bounds for array "+this.name+" for index "+e;if(t[e]<0)throw"02:index smaller then zero for array "+this.name}}set(t,e){this._check(t),null==this.buffer&&(this.buffer=[]);for(var r=this.buffer,s=t.length-1,i=0;i<=s;i++)i==s?r[t[i]]=e:(void 0===r[t[i]]&&(r[t[i]]=[]),r=r[t[i]])}get(t){if(this._check(t),null==this.buffer)return this.defaultValue;for(var e=this.buffer,r=t.length-1,s=0;s<=r;s++){if(s==r)return e[t[s]];if(void 0===e[t[s]])return this.defaultValue;e=e[t[s]]}}}class r{newError(t,e,r,s){return{context:r,clazz:t,detail:e,lineNr:s}}throwError(t,e,r,s){throw this.newError(t,e,r,s)}fromSerializedError(t,e,r){var s=r;if(void 0===s&&(s=-1),!this.isSerializedError(t))return this.newError("unknown",null,e,s);var i=t.substr(1).split("@");return 1==i.length?this.newError(i[0],null,e,s):this.newError(i[0],i[1],e,s)}isSerializedError(t){return"string"==typeof t&&t.startsWith("@")}isError(t){if("[object Object]"===Object.prototype.toString.call(t)){t.context;var e=t.clazz;if(t.detail,void 0!==e)return!0}return!1}}class s{constructor(t){this.sys=t,this.output=t.out}addRunTime(t){this.runTime=t}interactiveKeyHandler(e){if("Enter"==e.keyLabel){var r=t.out.getCurrentLine();this.output.writeln(""),this.runTime.executeInteractiveLine(r)}else"Backspace"==e.keyLabel||"Delete"==e.keyLabel?this.output.getCursorPos()[0]>0&&this.output.backspace():"ArrowUp"==e.keyLabel?this.output.cursorMove("up"):"ArrowDown"==e.keyLabel?this.output.cursorMove("down"):"ArrowLeft"==e.keyLabel?this.output.cursorMove("left"):"ArrowRight"==e.keyLabel?this.output.cursorMove("right"):null!=e.key&&this.output.write(e.key)}}class i{constructor(t,e){this.debugFlag=!1,this.sys=t,this.editor=e,this.editor.addRunTime(this),this.listSpeed=15,this.output=t.out,this.bitmap=t.bout,this.input=t.input,this.input.setHandler(this),this.input.setInterActive(!1),this.html=t.html,this.program=[],this.runFlag=!1,this.waitForMessageFlag=!1,this.waitForMessageVariable=null,this.executeLineFlag=!1,this.goPlayExampleFlag=!1,this.breakCycleFlag,this.inputFlag=!1,this.listFlag=!1,this.immersiveFlag=!1,this.gosubReturn=[],this.nullTime=(new Date).getTime(),this.turboMode=!1,this.cmdCountPerCycleDefault=1e4,this.cmdCountPerCycleTurbo=2e4,this.cmdCountPerCycle=this.cmdCountPerCycleDefault,this.output,this.commands=new o(this),this.extendedcommands=new a(this),this.erh=new r,this.vars=[],this.functions=[],this.data=[],this.kbBuffer=[],this.yPos=-1,this.lineMarkers=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.SHORTLINE=0,this.LONGLINESTART=1,this.LONGLINEEND=2,this.forContext={default:[]},this.outputCallBacksAll={lineOverFlow:{clazz:this,method:"cbLineOverFlow"},scroll:{clazz:this,method:"cbScroll"},clearScreen:{clazz:this,method:"cbClearScreen"}},this.outputCallBacksClScr={lineOverFlow:void 0,scroll:{clazz:this,method:"cbScroll"},clearScreen:{clazz:this,method:"cbClearScreen"}},this.synchClock(),this.exitMode="stay",this.code2colMap=[];var s=this.code2colMap;s[144]=0,s[5]=1,s[28]=2,s[159]=3,s[156]=4,s[30]=5,s[31]=6,s[158]=7,s[129]=8,s[149]=9,s[150]=10,s[151]=11,s[152]=12,s[153]=13,s[154]=14,s[155]=15,this.symbolTable={},this.symbolTable.up=145,this.symbolTable.down=17,this.symbolTable.left=157,this.symbolTable.right=29,this.symbolTable["reverse on"]=18,this.symbolTable["reverse off"]=146,this.symbolTable.clear=147,this.symbolTable.home=19,this.symbolTable.black=144,this.symbolTable.white=5,this.symbolTable.red=28,this.symbolTable.cyan=159,this.symbolTable.purple=156,this.symbolTable.green=30,this.symbolTable.blue=31,this.symbolTable.yellow=158,this.symbolTable.orange=129,this.symbolTable.brown=149,this.symbolTable.pink=150,this.symbolTable.grey1=151,this.symbolTable.grey2=152,this.symbolTable["light green"]=153,this.symbolTable["light blue"]=154,this.symbolTable.grey3=155;for(var i=[],n=Object.entries(this.symbolTable),h=0;h<n.length;h++)i[n[h][1]]=n[h][0];this.symbolTableBM=i}startWaitForMessage(t){this.waitForMessageFlag=!0,this.waitForMessageVariable=t}receiveMessage(t,e){this.vars[this.waitForMessageVariable]=t,this.waitForMessageFlag=!1,"displaysize"==t&&(this.output.reInit(e.textW,e.textH),this.output.reInit(e.bitmapW,e.bitmapH),0==this.runFlag&&this.printReady())}stop(){this.runFlag&&this.runStop(),this.listFlag&&this.listStop()}interactiveKeyHandler(t){1==this.runFlag?"Enter"==t.keyLabel?(this.output.writeln(""),this.handleLineInput(this.lineInput,!0),this.lineInput=""):"Backspace"==t.keyLabel||"Delete"==t.keyLabel?this.output.getCursorPos()[0]>0&&this.lineInput.length>0&&(this.output.backspace(),this.lineInput=this.lineInput.substr(0,this.lineInput.length-1)):"ArrowLeft"==t.keyLabel?this.output.cursorMove("left"):"ArrowRight"==t.keyLabel?this.output.cursorMove("right"):null!=t.key&&(this.lineInput+=t.key,this.output.write(t.key)):this.editor.interactiveKeyHandler(t)}HandleStopped(){this.input.setInterActive(!0)}importPGMHandler(t,e){var r=this.textLinesToBas(t.split("\n"));this.fileName=e,this.program=r,this.sys.log("imported program "+e+" with "+t.length+" bytes ")}bootPGM(t,e){try{var r=this.textLinesToBas(t.split("\n"));return this.fileName=e,this.program=r,this.setProgram(r),this.sys.log("imported program "+e+" with "+t.length+" bytes "),!0}catch(t){return r=this.textLinesToBas(""),this.program=r,this.HandleStopped(),this.printError("parsing syntax",!1,t.lineNr,t.detail),this.printReady(),!1}}exitProgram(){this.closeWindow(this.windowId)}enterListMode(t){this.listFlag=!0,this.list=t,this.listPointer=0,this.input.setInterActive(!1)}setExitMode(t){this.exitMode=t}synchClock(){var t=new Date;t.setHours(0),t.setSeconds(0),t.setMinutes(0),t.setMilliseconds(0),this.nullTime=t}setTurbo(t){if(t)return this.cmdCountPerCycle=this.cmdCountPerCycleTurbo,void(this.turboMode=!0);this.cmdCountPerCycle=this.cmdCountPerCycleDefault,this.turboMode=!1}setProgram(t){this.program=t,this.runFlag=!1,this.HandleStopped(),this.inputFlag=!1,this.listFlag=!1}appendProgram(t){for(var e=0;e<t.length;e++){for(var r=-1,s=0;s<this.program.length;s++)this.program[s][0]==t[e][0]&&(r=s);r>-1?this.program[r]=t[e]:this.program.push(t[e])}this.program.sort((function(t,e){return t[0]-e[0]})),this.runFlag=!1,this.HandleStopped(),this.inputFlag=!1,this.listFlag=!1}getProgram(){return this.program}getProgramState(){return{runFlag:this.runFlag,inputFlag:this.inputFlag,vars:this.vars,functions:this.functions,forContext:this.forContext,runPointer:this.runPointer,runPointer2:this.runPointer2}}setProgramState(t){this.runFlag=t.runFlag,this.HandleStopped(),this.inputFlag=t.inputFlag,this.vars=t.vars,this.functions=t.functions,this.forContext=t.forContext,this.runPointer=t.runPointer,this.runPointer2=t.runPointer2}updateEditMode(){this.runFlag||this.listFlag||this.executeLineFlag?this.listFlag||this.runFlag&&this.inputFlag?this.setEditModeCallBacks("edit"):(this.runFlag||this.executeLineFlag)&&this.setEditModeCallBacks("print"):this.setEditModeCallBacks("edit")}_setByteBits(t){for(var e=0,r=0;r<8;r++)r>0&&(e>>=1),t[r]&&(e|=128);return e}_getByteBits(t){for(var e=[1,2,4,8,16,32,64,128],r=[!1,!1,!1,!1,!1,!1,!1,!1],s=0;s<8;s++)r[s]=(t&e[s])>0;return r}printError(t,e,r,s){var i="?"+t+" error"+this.onLineStr();r&&(i="?"+t+" error in "+r),e&&(i="?"+t+" error"),this.output.writeln(i),s&&this.output.writeln(">> "+s)}printInfo(t){this.sys.log((t+this.onLineStr()).toUpperCase())}printLine(t){this.output.writeln(t.toUpperCase()),this.reverseOn=!1}print(t){this.output.writeln(t.toUpperCase()),this.reverseOn=!1}clearScreen(){this.output.clearScreen(),this.output.cursorHome()}getJiffyTime(){var t=(new Date).getTime()-this.nullTime;return Math.floor(t/(1e3/60))%5184e3}getTime(){var t=(new Date).getTime()-this.nullTime;t%=864e5;var e=Math.floor(t/36e5);t-=36e5*e;var r=Math.floor(t/6e4);return t-=6e4*r,[e,r,Math.floor(t/1e3)]}reset(t,e){this.output.clearScreen(),this.output.writel("ready."),this.inputFlag=!1,this.runFlag=!1,this.listFlag=!1,this.clrPGM(),this.setTurbo(!1)}compressPGMText(t){var e=new h(this.commands,this.extendedcommands);e.init();for(var r=e.getKeyWordCodes(),s=t,i=0;i<r.length;i++){var a=r[i];null!=a&&(s=s.replaceAll(a.toLowerCase(),String.fromCharCode(i)))}return s}getProgramAsTextNoPETSCII(){var t="";for(const e of this.program)""!=t&&(t+="\n"),t+=this.prepareLineForExportNoPETSCII(e[2].trim(),!0);return t}getProgramAsText(){var t="";for(const e of this.program)""!=t&&(t+="\n"),t+=this.prepareLineForExport(e[2].trim());return t}prepareLineForExport(t){var e;e=t.trim();for(var r="",s=0;s<e.length;s++){var i=e.charCodeAt(s);if(i<31||92==i||i>=94){var a=this.symbolTableBM[i];r+=void 0!==a?"{"+a+"}":"{"+i+"}"}else r+=e.charAt(s)}return r.toLowerCase()}replaceAll(t,e,r){for(var s=t;s.indexOf(e)>-1;)s=s.replace(e,r);return s}rebuildNoPETSCIILineString(t){var e=new h(this.commands,this.extendedcommands);e.init();var r=this.prepareLineForExportNoPETSCII(t,!1);return e.parseLine(r)}prepareLineForExportNoPETSCII(t,e){var r;r=t.trim();for(var s="",i="",a=0;a<r.length;a++){var n=r.charCodeAt(a),o=r.charAt(a);if(n<31||92==n||n>=94){var h=!1,l=!1;a+1<r.length&&'"'==r.charAt(a+1)&&(l=!0),'"'==i&&(h=!0),h&&!l?(s=s.substr(0,s.length-1),s+="CHR$("+n+');"'):h&&l?(s=s.substr(0,s.length-1),s+="CHR$("+n+")",a++):!h&&l?(s+='";CHR$('+n+")",a++):s+='";CHR$('+n+');"'}else s+=r.charAt(a);i=o}var p=this.replaceAll(s,';"";',";");return e?p.toLowerCase():p}ResolveStringSymbolToCode(t){return this.symbolTable[t]?this.symbolTable[t]:t}prepareLineForImport(t){var e;e=t.trim();for(var r="",s=0;s<e.length;){var i=e.charCodeAt(s);if(123==i){s++;for(var a="";s<e.length;){if(125==(i=e.charCodeAt(s))){s++;break}a+=String.fromCharCode(i),this.debugFlag&&(console.log("found ESC seq char "+String.fromCharCode(i)),console.log("found ESC seq char code "+i)),s++}this.debugFlag&&console.log("found ESC seq "+a),a=this.ResolveStringSymbolToCode(a.toLowerCase()),this.debugFlag&&console.log("found resolved ESC seq "+a),r+=String.fromCharCode(parseInt(a,10))}else 8221==i||8220==i?(r+='"',s++):(r+=e.charAt(s),s++)}return this.debugFlag&&console.log("dst:"+r),r}getProgramLines(){return this.program}padZeros2(t){for(var e=t+"",r=e.length;r<2;r++)e="0"+e;return e}evalExpressionPart(t){var e=0;if("num"==t.type)e="."==t.data?0:(""+t.data).indexOf(".")>=0?parseFloat(t.data):parseInt(t.data);else if("str"==t.type)e=t.data;else if("var"==t.type)t.data.startsWith("TI")?(e=this.getJiffyTime(),t.data.endsWith("$")&&(e=this.getTime(),e=""+this.padZeros2(e[0])+this.padZeros2(e[1])+this.padZeros2(e[2]))):"CURRENTLINE"==t.data?-1!=(e=this.runPointer)&&(e=parseInt(this.program[e][0])):e="PI"==t.data?Math.PI:this.vars[t.data],null==e&&(e=0);else if("array"==t.type){var r="@array_"+t.data,s=this.vars[r];if(void 0===s)throw"@no such array@Array '"+r+"' does not exist";if(s.getIndexCount()!=t.indices.length)throw"@bad subscript@Array index dimensions do not match";for(var i=[],a=0;a<t.indices.length;a++)i[a]=this.evalExpression(t.indices[a]);void 0===(e=s.get(i))&&(e=0)}else if("expr"==t.type)e=this.evalExpression(t);else if("funCall"==t.type){for(var n=[],o=0;o<t.params.length;o++){var h=this.evalExpression(t.params[o]);n.push({value:h})}try{var l=this.commands,p=this.extendedcommands,u=this.commands,d="_fun_"+t.functionName.toLowerCase().replace("$","_DLR_"),g=l[d];if(void 0===g){if(void 0===(g=p[d]))throw g=p[d],this.printError("no such function: "+t.functionName),console.log("Cannot find functionName "+d),"@no such function "+t.functionName;u=p}e=u[d](n)}catch(t){throw t}}else if("defFnCall"==t.type)try{var c=t.functionName,m=this.evalExpression(t.params[0]),f=null;if(void 0===this.functions[c])throw"@undef'd function";var v=this.functions[c];void 0!==this.vars[v.par]&&(f=this.vars[v.par]),this.vars[v.par]=m,e=this.evalExpression(v.expr),null!=f?this.vars[f.name]=f:this.vars[v.par]=0}catch(t){throw t}return e}evalExpression(t){if(null==t)return null;if(0==t.parts.length)return null;for(var e=this.evalExpressionPart(t.parts[0]),r=1;r<t.parts.length;r++){var s=t.parts[r];if("+"==s.op)e+=this.evalExpressionPart(s);else if("^"==s.op)e=Math.pow(e,this.evalExpressionPart(s));else if("-"==s.op)e-=this.evalExpressionPart(s);else if("*"==s.op)e*=this.evalExpressionPart(s);else if("/"==s.op){if(0==this.evalExpressionPart(s))throw"@division by zero";e/=this.evalExpressionPart(s)}else if(";"==s.op)e+=""+this.evalExpressionPart(s);else if("OR"==s.op)e|=this.evalExpressionPart(s);else if("AND"==s.op)e&=this.evalExpressionPart(s);else if("<"==s.op)e=e<this.evalExpressionPart(s)?-1:0;else if(">"==s.op)e=e>this.evalExpressionPart(s)?-1:0;else if("="==s.op)e=e==this.evalExpressionPart(s)?-1:0;else if("<>"==s.op)e=e!=this.evalExpressionPart(s)?-1:0;else if("<="==s.op)e=e<=this.evalExpressionPart(s)?-1:0;else{if(">="!=s.op)throw"@syntax@unknown operator '"+s.op+"'";e=e>=this.evalExpressionPart(s)?-1:0}}return t.negate?-e:t.binaryNegate?0==e?-1:0:e}exitInputState(){var t=this.output,e=this.program;this.inputFlag=!1;var r=this.program[this.runPointer][1];this.runPointer>-1&&this.program[this.runPointer],this.runPointer2++,this.runPointer>-1&&this.program[this.runPointer],this.runPointer2>=r.length&&(this.runPointer2=0,this.runPointer++,this.runPointer>-1&&this.program[this.runPointer],this.sys.blinkMode(!1),this.runPointer>=e.length&&(this.runPointer>-1&&this.program[this.runPointer],this.runFlag=!1,this.HandleStopped(),t.clearCursor(),this.printLine(""),this.printLine("ready.")))}breakCycle(){this.breakCycleFlag=!0}cycle(){this.output;var e=this.cmdCountPerCycle;try{if(this.bitmap.isActive()&&this.bitmap.triggerFlush(),!this.runFlag||this.inputFlag||this.listFlag){if(this.listFlag){for(var r=this.listSpeed;this.listPointer<this.list.length&&r-- >0;)this.listCodeLine(this.list[this.listPointer]),this.listPointer++;this.listPointer>=this.list.length&&this.listStop()}}else{if(this.debugFlag&&console.log("START CYCLE------------------------------"),this.waitForMessageFlag)return;for(var s=this.program;;){if(this.breakCycleFlag){this.breakCycleFlag=!1;break}this.debugFlag&&console.log("START CYCLE LOOP-------------");var i=s[this.runPointer],a=this.runPointer2;this.debugFlag&&console.log(" this.runPointer = "+this.runPointer," this.runPointer2 = "+this.runPointer2),this.debugFlag&&console.log(" cmdCount = "+e);var n=this.runCommands(i[1],e),o=n[1];20==n[0]&&(this.runPointer2=o);var h=n[2];if(this.debugFlag&&console.log(" bf = "+a," af = "+o),this.debugFlag&&console.log(" executedCount = "+h),this.debugFlag&&console.log(" rv = "+n),e-=h,n[0]<=0){this.debugFlag&&console.log(" PGM END!!!!"),this.runFlag=!1;var l=null;return n.length>=4&&(l=n[3]),this.printLine(""),this.printLine("ready."),this.HandleStopped(),0==n[0]&&(console.log("ERROR: ",l," LINE ",this.retreiveRuntimeLine()),console.log("PARAMETER DUMP:",this.vars),console.log("FUNCTION DUMP:",this.functions)),void(this.debugFlag&&console.log("CYCLE RETURN END"))}if(10==n[0]){if(this.runPointer++,this.runPointer2=0,this.debugFlag&&console.log(" new this.runPointer = "+this.runPointer," this.runPointer2 = "+this.runPointer2),this.runPointer>=s.length){this.debugFlag&&console.log("end program"),this.runFlag=!1,this.HandleStopped(),this.printLine("ready.");break}}else if(30==n[0])this.debugFlag&&console.log(" jump to new this.runPointer = "+this.runPointer," this.runPointer2 = "+this.runPointer2);else if(40==n[0]){this.runPointer2=o,this.debugFlag&&console.log("CYCLE PAUSE 4 INPUT"+this.runPointer+","+this.runPointer2);break}if(e<=0){this.debugFlag&&console.log("Breaking cmdCount="+e);break}}this.debugFlag&&console.log(" this.runPointer = "+this.runPointer," this.runPointer2 = "+this.runPointer2)}}catch(l){if(this.erh.isSerializedError(l)){var p=this.erh.fromSerializedError(l);this.printError(p.clazz,void 0,void 0,p.detail)}else this.printError("unexpected");this.printLine("ready."),this.runFlag=!1,t.log("ERROR: ",l," LINE ",this.retreiveRuntimeLine()),t.log("PARAMETER DUMP:",this.vars),t.log("FUNCTION DUMP:",this.functions)}}doReturn(){var t=this.gosubReturn.pop();if(void 0===t)throw"@return without gosub";this.runPointer2=t[1],this.runPointer=t[0]}gosub(t,e){this.program;var r=this.program.length,s=null,i=null;this.runPointer2=e,this.runPointer2+1<this.program[this.runPointer][1].length?(i=this.runPointer2+1,s=this.runPointer):this.runPointer+1<r?(i=0,s=this.runPointer+1):(i=9999,s=this.runPointer),this.gosubReturn.push([s,i]),this.goto(t)}goto(t){var e,r=this.program,s=this.program.length,i=!1;e="number"==typeof t?t:this.evalExpression(t);for(var a=0;a<s;a++)r[a][0]==e&&(this.runPointer=a,this.runPointer2=0,i=!0);if(!i)throw"@undef'd statement";this.runFlag||(this.startAsGoto=!0,this.runPGM())}listStop(){this.listFlag&&(this.output,this.listFlag=!1,this.HandleStopped(),this.printLine("ready."))}runStop(){this.runFlag&&(this.output,this.runFlag=!1,this.HandleStopped(),console.log("break in "+this.program[this.runPointer][0]),this.printLine("break in "+this.program[this.runPointer][0]),this.printLine("ready."))}isRunning(){return this.runFlag}isListing(){return this.listFlag}isInput(){return this.inputFlag}readData(){if(!(this.dataPointer>=this.data.length)){var t=this.data[this.dataPointer];return this.dataPointer++,t}}printChar(t){this.output.write(t)}listCodeLine(t){this.printLine(t)}rebuildLineString(t,e,r,s,i,a){var n=new h(this.commands,this.extendedcommands);n.init();var o,l=n.getTokens(e,!1,!1);if(void 0!==s){var p=!1;for(d=0;d<l.length;d++)if("name"!=l[d].type||"GOTO"!=l[d].data&&"GOSUB"!=l[d].data?d>1&&("num"==l[d].type&&"pad"==l[d-1].type&&"name"==l[d-2].type&&"THEN"==l[d-2].data||"num"==l[d].type&&"name"==l[d-1].type&&"THEN"==l[d-1].data)&&(p=!0):p=!0,"num"==l[d].type&&p){var u=s["old_"+l[d].data];null==u&&(u=99999),l[d].data=u,p=!1}}l[0].data=t,o=t,r&&(o=t+" ");for(var d=1;d<l.length;d++)r&&"pad"==l[d].type||(a?"name"==l[d].type&&"PRINT"==l[d].data&&(l[d].data="?"):"name"==l[d].type&&"?"==l[d].data&&(l[d].data="PRINT"),"str"==l[d].type?o+='"'+l[d].data+'"':"name"==l[d].type&&1==i?o+=l[d].data+" ":"num"==l[d].type&&1==i&&1==l[d].data.length?o+=" "+l[d].data:o+=l[d].data);return n.parseLine(o)}lineIsData(t){return console.log(t),1==t[1].length&&void 0!==t[1][0].controlKW&&"DATA"==t[1][0].controlKW.toUpperCase()}lineIsRem(t){return console.log(t),1==t[1].length&&void 0!==t[1][0].controlKW&&"REM"==t[1][0].controlKW.toUpperCase()}renumberProgram(t,e){for(var r=this.program,s=t,i={},a=[],n=0;n<r.length;n++){var o,h=r[n];this.lineIsRem(h)&&((o=1e3*Math.ceil(s/1e3))-s<100&&(o+=1e3),s=o),i["old_"+h[0]]=s,a.push(s),s+=e}for(n=0;n<r.length;n++){s=a[n],h=r[n];var l=this.rebuildLineString(s,h[2],!0,i,!0);h[0]=s,h[1]=l.commands,h[2]=l.raw.trim()}}PETSCIIreplace(t){for(var e=this.program,r=0;r<e.length;r++){var s=e[r],i=this.rebuildNoPETSCIILineString(s[2]);s[1]=i.commands,s[2]=i.raw}}compressProgram(t){for(var e=this.program,r=0;r<e.length;r++){var s=e[r],i=this.rebuildLineString(s[0],s[2],!0,void 0,!1,t);s[1]=i.commands,s[2]=i.raw}}normalizeProgram(){for(var t=this.program,e=0;e<t.length;e++){var r=t[e],s=this.rebuildLineString(r[0],r[2],!0,void 0,!0);r[1]=s.commands,r[2]=s.raw}}clrPGM(){this.vars=[],this.functions=[],this.restoreDataPtr()}restoreDataPtr(){this.dataPointer=0}runPGM(){if(this.executeLineFlag=!1,this.startAsGoto){this.startAsGoto=!1;var t=this.runPointer,e=this.runPointer2;return this.runPGM(),this.runPointer=t,void(this.runPointer2=e)}this.input.setInterActive(!1),this.output;var r=this.program;this.data=[],this.dataPointer=0,this.gosubReturn=[],this.vars=[],this.functions=[];for(var s=0;s<r.length;s++)for(var i=r[s][1],a=0;a<i.length;a++){var n=i[a];if("control"==n.type&&"data"==n.controlKW)for(var o=0;o<n.params.length;o++)this.data.push(n.params[o])}this.debugFlag&&console.log("data dump:",this.data),this.program.length>0?(this.runFlag=!0,this.inputFlag=!1,this.runPointer=0,this.runPointer2=0):(this.runFlag=!1,this.inputFlag=!1,this.runPointer=0,this.runPointer2=0,this.input.setInterActive(!0),this.printReady())}doForInit(t,e,r,s,i,a,n){var o=this.forContext;void 0===this.vars[s]&&(this.vars[s]=0),this.vars[s]=this.evalExpression(t),o.default.push(s),o[s]={};var h=o[s];if(h.to=this.evalExpression(e),h.step=null==r?1:this.evalExpression(r),h.jumpTo={line:this.runPointer,cmdPointer:i+1},h.jumpTo.cmdPointer>=a){if(-1==this.runPointer)throw"@syntax@Can't find command after 'FOR'";if(this.runPointer+1>=n)throw"@syntax@Can't find command after 'FOR', on next line";h.jumpTo.line++,h.jumpTo.cmdPointer=0}}doForNext(t){var e=this.forContext;if(0==e.default.length)throw"@syntax@Next without for";var r=e.default[e.default.length-1];null!=t&&(r=t);var s=e[r];if(this.vars[r]+=s.step,s.step>0){if(this.vars[r]<=s.to)return s.jumpTo}else{if(0==s.step)return s.jumpTo;if(this.vars[r]>=s.to)return s.jumpTo}return e.default.pop(),-1}onLineStr(){var t=this.retreiveLine();return-1==t||""==t?"":" in "+t}retreiveRuntimeLine(){return this.runPointer>-1?this.program[this.runPointer][0]:-1}retreiveLine(){return this.runFlag?this.retreiveRuntimeLine():void 0===this.parseLineNumber?-1:-1==this.parseLineNumber?"":this.parseLineNumber}commandToString(t){return"control"==t.type?t.controlKW.toUpperCase():"call"==t.type?t.statementName:"assignment"==t.type?"assign ->"+t.var:"????"}runCommands(t,r){var s=this.commands,i=this.extendedcommands,a=30,n=t.length,o=this.runPointer2,h=0;for(null!=r||(r=9999);o<n&&h<r;){if(this.breakCycleFlag&&null!=r){this.breakCycleFlag=!1;break}var l=t[o];if(this.program[this.runPointer],"control"==l.type){var p=l.controlKW;if("goto"==p)return this.goto(l.params[0]),[a,o+1,h+1];if("end"==p)return[-1,o+1,h+1];if("stop"==p)return this.printInfo("break"),[-1,o+1,h+1];if("gosub"==p)return this.gosub(l.params[0],o),[a,o+1,h+1];if("on"==p){var u=l.params[0],d=l.params[1],g=l.params[2],c=this.evalExpression(d);if(c-1>=0&&c-1<g.length){if("goto"==u)return this.goto(g[c-1]),[a,o+1,h+1];if("gosub"==u)return this.gosub(g[c-1],o),[a,o+1,h+1]}}else{if("return"==p)return this.doReturn(),[a,o+1,h+1];if("if"==p){if(0==this.evalExpression(l.params[0]))return[10,o+1,h+1]}else if("data"==p);else{if("rem"==p)return[10,o+1,h+1];if("for:init"==p)this.doForInit(l.params[0],l.params[1],l.params[2],l.variable,o,t.length);else if("for:next"==p){var m=this.doForNext(l.nextVar);if(-1!==m){if(-1!=m.line){if(this.runPointer==m.line){o=m.cmdPointer,h++;continue}return this.runPointer=m.line,this.runPointer2=m.cmdPointer,[a,o+1,h+1]}o=m.cmdPointer,h++;continue}}else if("dim"==p){this.vars;for(var f=0;f<l.params.length;f++){for(var v=[],y=0;y<l.params[f].length;y++)v[y]=this.evalExpression(l.params[f][y]);var b=new e(l.arrayNames[f],v,0),x="@array_"+l.arrayNames[f];if(void 0!==this.vars[x])return this.printError("redim'd array"),[0,o+1,h+1];this.vars[x]=b}}else{if("def"!=p)return this.printError("illegal ctrl token '"+p+"'"),[0,o+1,h+1];this.functions[l.params[0]]={par:l.params[1],expr:l.params[2]}}}}}else if("call"==l.type){var _=[],E=[],w=s,C=w["_stat_"+l.statementName.toLowerCase()];if(void 0===C)if(void 0===(C=(w=i)["_stat_"+l.statementName.toLowerCase()]));else if(0==w.enabled&&"xon"!=l.statementName.toLowerCase())return this.printError("extended not enabled"),[0,o+1,h+1];if(void 0!==w["_if_"+l.statementName.toLowerCase()])E=w["_if_"+l.statementName.toLowerCase()]();else for(var P=0;P<l.params.length;P++)E[P]=0;for(P=0;P<l.params.length;P++)if(0==E[P]){var T=this.evalExpression(l.params[P]);null!=T&&_.push({type:"value",value:T})}else if(1==E[P]){var F=l.params[P].parts[0].data,L="num";F.indexOf("$")>-1&&(L="str"),_.push({type:"var",value:F,varType:L})}else _.push(l.params[P]);try{if(void 0===C)return this.printError("syntax"),[0,o+1,h+1];if(w["_stat_"+l.statementName.toLowerCase()](_),this.inputFlag)return[40,o+1,h+1]}catch(t){if(console.log(t),this.erh.isSerializedError(t)){var S=this.erh.fromSerializedError(t);this.printError(S.clazz)}else this.erh.isError(t)?(S=t,this.printError(S.clazz)):this.printError("unexpected "+t);return[0,o+1,h]}}else if("assignment"==l.type)if(l.arrayAssignment){if(x="@array_"+l.var,void 0===this.vars[x])return this.printError("bad subscript"),[0,o+1,h];var k=this.vars[x];if(l.indices.length!=k.getIndexCount())return this.printError("bad subscript"),[0,o+1,h];for(v=[],y=0;y<l.indices.length;y++)v[y]=this.evalExpression(l.indices[y]);if(l.var.endsWith("%"))k.set(v,Math.floor(this.evalExpression(l.expression)));else if(l.var.endsWith("$"))k.set(v,this.evalExpression(l.expression));else{if("number"!=typeof this.evalExpression(l.expression))return this.printError("type mismatch",void 0,void 0,"value not a number"),[0,o+1,h];k.set(v,this.evalExpression(l.expression))}}else{if(void 0===this.vars[l.var]){if(l.var.startsWith("TI"))return this.printError("syntax"),[0,o+1,h+1];this.vars[l.var]=0}if(l.var.endsWith("%"))this.vars[l.var]=Math.floor(this.evalExpression(l.expression));else if(l.var.endsWith("$"))this.vars[l.var]=this.evalExpression(l.expression);else{if("number"!=typeof this.evalExpression(l.expression))return this.printError("type mismatch",void 0,void 0,"value not a number"),[0,o+1,h];this.vars[l.var]=this.evalExpression(l.expression)}}o++,h++}return o==t.length?[10,o,h]:[20,o,h]}setVar(t,e){this.vars[t]=e}old(t){this.program=this.oldProgram}new(t){this.oldProgram=this.program,this.program=[]}removePgmLine(t){for(var e=[],r=0;r<this.program.length;r++){var s=this.program[r];s[0]!=t&&e.push(s)}this.program=e}padSpaces6(t){for(var e=t+"",r=e.length;r<6;r++)e+=" ";return e}padSpaces8(t){for(var e=t+"",r=e.length;r<8;r++)e+=" ";return e}insertPgmLine(t,e,r){this.insertPgmLineLocal(t,e,r,this.program)}insertPgmLineLocal(t,e,r,s){for(var i=0;i<s.length;i++)if(s[i][0]==t)return void(s[i]=[t,e,r.trim()]);s.push([t,e,r.trim()]),s.sort((function(t,e){return t[0]-e[0]}))}textLinesToBas(t){var e=[];this.debugFlag&&console.log("textLinesToBas");for(var r=0;r<t.length;r++){var s=this.prepareLineForImport(t[r]),i=new h(this.commands,this.extendedcommands);i.init();var a=i.parseLine(s);if(null!=a){if(-1==a.lineNumber)throw"Error, command must start with number to be part of program";if(!(a.commands.length>0))throw"Error, no commands on line "+a.lineNumber;this.insertPgmLineLocal(a.lineNumber,a.commands,a.raw,e),this.debugFlag&&(console.log("program:",e),console.log("Line: ",a))}}return e}printReady(){this.printLine("ready.")}startConsoleDataInput(t){this.debugFlag&&console.log("inputvars=",t),this.inputFlag=!0,this.inputVars=t,this.input.setInterActive(!0),this.inputVarsPointer=0,this.output.write("? "),this.lineInput="",this.sys.blinkMode(!0)}executeInteractiveLine(t){this.handleLineInput(t,!1)}handleLineInput(t,e){if(this.debugFlag&&console.log("handleLineInput: start debug / isInputCommand="+e+" -------------"),e){for(var r=t,s=r.indexOf("?");s>-1;)s=(r=r.substr(s+2)).indexOf("?");if(this.debugFlag&&(console.log("handleLineInput: start debug / input, name -------------"),console.log("InputVarsPointer:",this.inputVarsPointer),console.log("InputVars:",this.inputVars),console.log("Input String:",r),console.log("Input Vars[current]:",this.inputVars[this.inputVarsPointer])),this.inputVars[this.inputVarsPointer].indexOf("$")>-1)this.setVar(this.inputVars[this.inputVarsPointer],r.trim());else{var i=parseFloat(r.trim());if(isNaN(i))return this.printLine("?redo from start"),void this.printChar("? ");this.setVar(this.inputVars[this.inputVarsPointer],i)}return this.inputVarsPointer++,this.inputVarsPointer>=this.inputVars.length?this.exitInputState():this.printChar("?? "),void(this.debugFlag&&console.log("handleLineInput: end debug -------------"))}this.executeLineFlag=!0,this.debugFlag&&console.log(t);var a=new h(this.commands,this.extendedcommands);a.init();try{var n=a.parseLine(t)}catch(t){this.parseLineNumber=-1,this.erh.isError(t)?(this.parseLineNumber=t.lineNr,this.printError(t.clazz,!0,void 0,t.detail)):this.printError("syntax",!0),this.printLine("ready.")}if(null==n)return this.debugFlag&&console.log("handleLineInput: end debug -------------"),void(this.executeLineFlag=!1);if(-1!=n.lineNumber)n.commands.length>0?this.insertPgmLine(n.lineNumber,n.commands,n.raw):this.removePgmLine(n.lineNumber);else{this.runPointer=-1,this.runPointer2=0;try{this.runCommands(n.commands)}catch(t){if(this.parseLineNumber=-1,this.erh.isSerializedError(t)){var o=this.erh.fromSerializedError(t);this.parseLineNumber=o.lineNr,this.printError(o.clazz,void 0,void 0,o.detail)}else this.erh.isError(t)?(o=t,this.printError(o.clazz),this.parseLineNumber=o.lineNr):this.printError("unexpected "+t);this.runFlag=!1}this.runFlag||this.listFlag||this.printLine("ready.")}this.executeLineFlag=!1,this.debugFlag&&(console.log("program:",this.program),console.log("Line: ",n),console.log("handleLineInput: end debug -------------"))}}class a{constructor(t){this.output=t.output,this.bitmap=t.bitmap,this.html=t.html,this.input=t.input,this.runtime=t,this.sys=t.sys,this.cmds={},this.func={},this.statementList=null,this.erh=new r}getStatements(){for(var t=Object.getOwnPropertyNames(a.prototype),e=[],r=0;r<t.length;r++)t[r].startsWith("_stat_")&&e.push(t[r].substr(6).toUpperCase());return e}getFunctions(){for(var t=Object.getOwnPropertyNames(a.prototype),e=[],r=0;r<t.length;r++)if(t[r].startsWith("_fun_")){var s=t[r].substr(5).toUpperCase().replace("_DLR_","$");e.push(s)}return e}_stat_cls(t){this.output.control(24)}_stat_reverse(t){if(0!=t.length){var e=t[0].value;e<0||e>1||this.output.control(64+e)}else this.output.control(65)}_stat_gcolor(t){if(1==t.length)if(1!=t.length);else{var e=t[0].value;this.bitmap.setLineColor(e)}else this.erh.throwError("parameter count","expected color")}_stat_line(t){4==t.length?this.bitmap.isActive()?this.bitmap.line(t[0].value,t[1].value,t[2].value,t[3].value):this.erh.throwError("invalid display mode","current mode cannot show graphics"):this.erh.throwError("parameter count","expected 2 (x0,y0,y1,y1), not "+t.length)}_stat_plot(t){2==t.length?this.bitmap.isActive()?this.bitmap.plot(t[0].value,t[1].value):this.erh.throwError("invalid display mode","current mode cannot show graphics"):this.erh.throwError("parameter count","expected 2 (x,y), not "+t.length)}_stat_center(t){var e;t.length>1?this.erh.throwError("too many parameters","expected max 2, not "+t.length):0!=t.length&&(e=t[0].value,this.output.center(e))}_stat_locate(t){var e=-1,r=-1;t.length>2?this.erh.throwError("too many parameters","expected max 2, not "+t.length):0!=t.length&&(t.length>=1&&(e=t[0].value),t.length>=2&&(r=t[1].value),this.output.setCursorPos(r,e))}_stat_hide(t){this.output.control(25)}_if_html(){return[2]}_stat_html(t){if(this.html,0!=t.length){var e,r=-1,s=null,i="",a=!1;2==t.length&&(r=0);for(var n=0;n<t.length&&n<2;n++){for(var o=t[n],h={parts:[],binaryNegate:o.binaryNegate,negate:o.negate},l=0;l<o.parts.length;l++)"uniop"==o.parts[l].type&&"+"==o.parts[l].op&&l==o.parts.length-1&&n==t.length-1?a=!0:h.parts.push(o.parts[l]);e=this.runtime.evalExpression(h),n==r?s=e:i=e}this.html.html({htmlHandle:s,htmlValue:i,htmlAppend:a})}}_stat_htmlnode(t){if(0!=t.length){var e=t[0];this.html.htmlnode(e)}}_stat_color(t){if(0!=t.length)if(1!=t.length){var e=t[1].value;if(s=t[0].value,this.output.control(16,s),this.output.control(17,e),3!=t.length);else{var r=t[2].value;this.output.control(18,r)}}else{var s=t[0].value;this.output.control(16,s)}}_stat_display(t){if(0!=t.length){t.length>1&&this.erh.throwError("too many variables","expected one parameter only");var e=t[0].value;this.sys.setDisplayMode(this.runtime,e),this.runtime.startWaitForMessage("displaysize")}}_stat_border(t){if(0!=t.length){t.length>1&&this.erh.throwError("too many parameters","expected one parameter only");var e=t[0].value;this.output.control(18,e)}}_stat_export(t){t.length>0&&this.erh.throwError("too many parameters","export needs no parameters");var e=this.runtime.getProgramAsText();this.sys.export(e)}_fun_uc_DLR_(t){return t[0].value?"string"==typeof t[0].value?String.fromCodePoint(parseInt(t[0].value,16)):String.fromCodePoint(t[0].value):"?"}_fun_dc_DLR_(t){return String.fromCodePoint(17)+String.fromCodePoint(t[0].value)+String.fromCodePoint(t[1].value)}_fun_html_DLR_(t){}_fun_width(t){return 0!=t.length&&this.erh.throwError("too many parameters","width() has no parameters"),this.bitmap.getDimensions()[0]}_fun_height(t){return 0!=t.length&&this.erh.throwError("too many parameters","width() has no parameters"),this.bitmap.getDimensions()[0]}_fun_cols(t){return 0!=t.length&&this.erh.throwError("too many parameters","cols() has no parameters"),this.output.getDimensions()[0]}_fun_columns(t){return 0!=t.length&&this.erh.throwError("too many parameters","columns() has no parameters"),this.output.getDimensions()[0]}_fun_rows(t){return 0!=t.length&&this.erh.throwError("too many parameters","rows() has no parameters"),this.output.getDimensions()[1]}}var n=new class{constructor(){this.rt=[]}addRuntime=function(t){this.rt.push(t)}};class o{constructor(t){this.output=t.output,this.bitmap=t.bitmap,this.input=t.input,this.runtime=t,this.sys=t.sys,this.cmds={},this.func={},this.statementList=null,this.erh=new r,this.randnrs=[];for(var e=0;e<1e4;e++)this.randnrs.push(Math.random());this.randIndex=0,this.randStep=1}getStatements(){for(var t=Object.getOwnPropertyNames(o.prototype),e=[],r=0;r<t.length;r++)t[r].startsWith("_stat_")&&e.push(t[r].substr(6).toUpperCase());return e}getFunctions(){for(var t=Object.getOwnPropertyNames(o.prototype),e=[],r=0;r<t.length;r++)if(t[r].startsWith("_fun_")){var s=t[r].substr(5).toUpperCase().replace("_DLR_","$");e.push(s)}return e}_stat_new(t){this.runtime.new()}_stat_list(t){var e=0,r=999999,s=[];1==t.length&&(s=t[0].parts),1==s.length&&"num"==s[0].type&&s[0].data>=0?(e=s[0].data,r=s[0].data):1==s.length&&"num"==s[0].type&&s[0].data<0?r=-s[0].data:2==s.length&&"num"==s[0].type&&"num"==s[1].type&&"-"==s[1].op?(e=s[0].data,r=s[1].data):2==s.length&&"num"==s[0].type&&"uniop"==s[1].type&&"-"==s[1].op&&(e=s[0].data);var i=this.runtime,a=[];for(const t of i.program){var n=parseInt(t[0]);(null==t[0]||n>=e&&n<=r)&&a.push(t[2])}this.runtime.enterListMode(a)}_if_get(){return[1]}_if_read(){return[1]}_if_input(){return[2,2,2,2,2,2,2,2,2,2]}_if_list(){return[2]}_if_run(){return[2]}_stat_read(t){var e=t[0];"var"!=e.type&&this.erh.throwError("not a var","parameter 0");var r=this.runtime.readData();void 0===r?this.erh.throwError("out of data"):"num"==r.type?this.runtime.setVar(e.value,parseInt(r.data)):this.runtime.setVar(e.value,r.data)}_stat_get(t){var e=t[0];"var"!=e.type&&this.erh.throwError("not a var","parameter 0");var r=this.input.getKey();null==r?this.runtime.setVar(e.value,""):this.runtime.setVar(e.value,r.key)}_stat_input(e){for(var r=[],s=this.output,i=0;i<e.length;i++)if(0==i){var a=e[0];2==a.parts.length?"str"==a.parts[0].type&&(s.write(a.parts[0].data),"var"==a.parts[1].type&&";"==a.parts[1].op&&r.push(a.parts[1].data)):1==a.parts.length&&r.push(a.parts[0].data)}else t.log("PARS["+i+"]",e[i]),"var"!=e[i].parts[0].type&&this.erh.throwError("not a var","parameter "+i),r.push(e[i].parts[0].data);this.runtime.startConsoleDataInput(r)}_stat_restore(t){this.runtime.restoreDataPtr()}_stat_load(t){var e,r=this.runtime;r.printLine(""),0==t.length?r.printLine("searching"):r.printLine("searching for "+t[0].value),(e=0==t.length?r.load(!1):r.load(t[0].value))?e[1]||(0==t.length?r.printLine("found default"):r.printLine("found "+t[0].value),r.printLine("loading")):r.printLine("?not found error")}_stat_save(t){var e=this.runtime;0==t.length?e.save(!1):e.save(t[0].value)}_stat_sys(t){this.erh.throwError("not supported")}_stat_wait(t){this.erh.throwError("not supported")}_stat_verify(t){this.erh.throwError("not supported")}_stat_run(t){this.runtime.runPGM()}_if_print(){return[2]}isNumber(t){return"number"==typeof t&&isFinite(t)}normalizeIfNumber(t){return this.isNumber(t)&&t>=0?" "+t:""+t}_stat_print(t){var e=this.runtime,r=this.output;if(0!=t.length)if(1!=t.length||0!=t[0].parts.length)for(var s,i=!0,a=0;a<t.length;a++){i=!0,a<t.length-1&&(i=!1),a>0&&r.write("         ");for(var n=t[a],o={parts:[],binaryNegate:n.binaryNegate,negate:n.negate},h=0;h<n.parts.length;h++)"uniop"==n.parts[h].type&&";"==n.parts[h].op&&h==n.parts.length-1&&a==t.length-1?i=!1:o.parts.push(n.parts[h]);s=e.evalExpression(o),0==a?r.write(this.normalizeIfNumber(s)):r.write(""+s),i&&r.nl()}else r.nl();else r.nl()}_stat_clr(t){return this.runtime.clrPGM()}_fun_chr_DLR_(t){return String.fromCharCode(t[0].value)}_fun_str_DLR_(t){return t[0].value>=0?" "+t[0].value:""+t[0].value}_fun_abs(t){return t[0].value<0?-t[0].value:t[0].value}_fun_len(t){return t[0].value.length}_fun_asc(t){return t[0].value.charCodeAt(0)}_fun_val(t){return parseInt(t[0].value)}_fun_exp(t){return Math.exp(t[0].value)}intGetNextRand(){return this.randIndex=(this.randIndex+this.randStep)%this.randnrs.length,this.randnrs[this.randIndex]}intSeedRand(t){if(t<0){var e=-t,r=Math.floor(11*e);this.randIndex=r%this.randnrs.length,this.randStep=1+r%7,this.randnrs=[];for(var s=0;s<1e4;s++)this.randnrs.push(Math.random())}else{const t=31536e6,i=new Date;let a=Math.round(i.getTime()/t);for(e=-e,r=Math.floor(11*a),this.randIndex=r%this.randnrs.length,this.randStep=1+r%7,this.randnrs=[],s=0;s<1e4;s++)this.randnrs.push(Math.random())}}_fun_rnd(t){if(t.length>1&&this.erh.throwError("syntax","rnd takes one parameter"),1==t.length){if(0==t[0].value)return Math.random();this.intSeedRand(t[0].value)}return this.intGetNextRand()}_fun_sqr(t){return Math.sqrt(t[0].value)}_fun_log(t){return Math.log(t[0].value)}_fun_pos(t){return this.runtime.getLinePos()}_fun_left_DLR_(t){var e=t[0].value;if("string"!=typeof e)throw"@type mismatch";return e.substr(0,t[1].value)}_fun_right_DLR_(t){var e=t[0].value;if("string"!=typeof e)throw"@type mismatch";return e.substr(e.length-t[1].value)}_fun_mid_DLR_(t){var e=t[0].value;if("string"!=typeof e)throw"@type mismatch";return 3==t.length?e.substr(t[1].value-1,t[2].value):2==t.length?e.substr(t[1].value-1):void 0}_fun_fre(t){return-26627}_fun_sin(t){return Math.sin(t[0].value)}_fun_tan(t){return Math.tan(t[0].value)}_fun_atn(t){return Math.atan(t[0].value)}_fun_cos(t){return Math.cos(t[0].value)}_fun_spc(t){for(var e="",r=0;r<t[0].value;r++)e+=" ";return e}_max(t,e){return t<e?t:e}_fun_usr(){return 0}_fun_int(t){return Math.floor(t[0].value)}_fun_tab(t){this.runtime,t.length<1&&this.erh.throwError("syntax","missing parameter 0");var e=t[0].value;(e<0||e>255)&&this.erh.throwError("illegal quantity","value must be in-between 0 and 255");for(var r=0;r<t[0].value;r++)this.output.write(" ");return""}_fun_sgn(t){var e=t[0].value;return e<0?-1:e>0?1:0}_fun_jiffies(t){return this.runtime.getJiffyTime()}}class h{constructor(t,e){this.commands=t,this.extendedcommands=e,this.erh=new r,this.debugFlag=!1}init(){this.CTRL_KW=["IF","THEN","GOTO","AND","NOT","OR","GOSUB","RETURN","FOR","TO","NEXT","STEP","DATA","REM","GOSUB","DIM","END","LET","STOP","DEF","FN","ON"],this.SHORTCUT_KW=["?"],this.KEYWORDS=this.commands.getStatements();for(var t=this.extendedcommands.getStatements(),e=0;e<t.length;e++)this.KEYWORDS.push(t[e]);for(t=this.commands.getFunctions(),e=0;e<t.length;e++)this.KEYWORDS.push(t[e]);for(t=this.extendedcommands.getFunctions(),e=0;e<t.length;e++)this.KEYWORDS.push(t[e]);for(e=0;e<this.CTRL_KW.length;e++)this.KEYWORDS.push(this.CTRL_KW[e]);for(e=0;e<this.SHORTCUT_KW.length;e++)this.KEYWORDS.push(this.SHORTCUT_KW[e]);this.debugFlag&&console.log("KEYWORDS:",this.KEYWORDS),this.screenCodes2CTRLTable=[];var r=this.screenCodes2CTRLTable;r[""]="",r["Ó"]=""}getKeyWordCodes(){return this.throwError(null,"(Extended) Keywords not yet supported","extended disabled"),this.KWCODES}padArray(t,e){for(var r=e-t.length;r>0;)t.push(null),r--}throwError(t,e,r){var s=r;void 0===s&&(s="syntax"),t&&console.log(" Exception "+r+" at line "+t.lineNumber+" "+e),t&&null!=t.lineNumber&&this.erh.throwError(s,e,t,t.lineNumber),this.erh.throwError(s,e,void 0,-1)}upperCaseNameTokens(t){for(var e=0;e<t.length;e++){var r=t[e];r&&"name"==r.type&&(r.data=r.data.toUpperCase())}return t}removePadding(t){for(var e=[],r=0;r<t.length;r++){var s=t[r];s&&"pad"!=s.type&&e.push(s)}return e}mergeCompTokens(t){for(var e=[],r=0;r<t.length;r++){var s=t[r];if(r>0){var i=t[r-1];"comp"!=s.type&&"eq"!=s.type||"comp"!=i.type&&"eq"!=i.type||(i.type="@@removeme",s.data=i.data+s.data,s.type="comp","><"==s.data?s.data="<>":"=<"==s.data?s.data="<=":"=>"==s.data&&(s.data=">="))}("name"==s.type&&"OR"==s.data||"name"==s.type&&"AND"==s.data||"name"==s.type&&"NOT"==s.data)&&(s.type="bop")}for(r=0;r<t.length;r++)"@@removeme"!=t[r].type&&e.push(t[r]);return e}mergeBrokenUpTokens(t){var e=[];e.push({p1:"REST",p2:"OR",p3:"E",whole:"RESTORE"}),e.push({p1:"S",p2:"TO",p3:"P",whole:"STOP"}),e.push({p1:"IMP",p2:"OR",p3:"T",whole:"IMPORT"}),e.push({p1:"EXP",p2:"OR",p3:"T",whole:"EXPORT"}),e.push({p1:"L",p2:"GET",p3:"URL",whole:"LGETURL"}),e.push({p1:"L",p2:"GET",p3:"NAME",whole:"LGETNAME"}),e.push({p1:"L",p2:"GET",p3:"ID",whole:"LGETID"}),e.push({p1:"GO",p2:"TO",p3:null,whole:"GOTO"}),e.push({p1:"GO",p2:"SUB",p3:null,whole:"GOSUB"}),e.push({p1:"GO",p2:"LINK",p3:null,whole:"GOLINK"}),e.push({p1:"WINDOW",p2:"S",p3:null,whole:"WINDOWS"}),e.push({p1:"UN",p2:"TAG",p3:null,whole:"UNTAG"}),e.push({p1:"LINK",p2:"S",p3:null,whole:"LINKS"}),e.push({p1:"DE",p2:"LET",p3:"E",whole:"DELETE"}),e.push({p1:"LDE",p2:"LET",p3:"E",whole:"LDELETE"}),e.push({p1:"TDE",p2:"LET",p3:"E",whole:"TDELETE"}),e.push({p1:"B",p2:"OR",p3:"DER",whole:"BORDER"}),e.push({p1:"G",p2:"COLOR",p3:"S",whole:"GCOLORS"}),e.push({p1:"CHAR",p2:"COL",p3:null,whole:"CHARCOL"}),e.push({p1:"SFRAME",p2:"CP",p3:null,whole:"SFRAMECP"}),e.push({p1:"SFRAME",p2:"FLIPX",p3:null,whole:"SFRAMEFLIPX"}),e.push({p1:"SFRAME",p2:"FLIPY",p3:null,whole:"SFRAMEFLIPY"}),e.push({p1:"SFRAME",p2:"FX",p3:null,whole:"SFRAMEFX"}),e.push({p1:"TAG",p2:"S",p3:null,whole:"TAGS"}),e.push({p1:"X",p2:"ON",p3:null,whole:"XON"}),e.push({p1:"S",p2:"POS",p3:null,whole:"SPOS"}),e.push({p1:"S",p2:"POKE",p3:null,whole:"SPOKE"}),e.push({p1:"WJ",p2:"IF",p3:"FY",whole:"WJIFFY"}),e.push({p1:"REF",p2:"OR",p3:"MAT",whole:"REFORMAT"});for(var r=[],s=0;s<t.length;s++)r.push(t[s]);for(s=0;s<e.length;s++){var i=e[s];r=this.mergeTokenRange(r,i)}return this.debugFlag&&console.log(r),r}mergeTokenRange(t,e){for(var r=[],s=[],i=0;i<t.length;i++)r[i]=t[i];for(i=1;i<r.length;i++)if(null==e.p3)"name"!=r[i-1].type&&"bop"!=r[i-1].type||"name"!=r[i-0].type&&"bop"!=r[i-0].type||r[i-1].data==e.p1&&r[i-0].data==e.p2&&(r[i-1].data=e.whole,r[i-0].type="removeme");else{if(i<2)continue;"name"!=r[i-2].type&&"bop"!=r[i-2].type||"name"!=r[i-1].type&&"bop"!=r[i-1].type||"name"!=r[i-0].type&&"bop"!=r[i-0].type||r[i-2].data==e.p1&&r[i-1].data==e.p2&&r[i-0].data==e.p3&&(r[i-2].data=e.whole,r[i-1].type="removeme",r[i-0].type="removeme")}var a=0;for(i=0;i<r.length;i++)"removeme"!=r[i].type&&(s[a]=r[i],a++);return s}parseFunParList(t){var e=t.tokens,r=[],s=!0,i=[];for(i.push({type:"sep",data:"@@@all"}),i.push({type:"bracket",data:")"}),i.push();;){var a;if(e.length>0&&"bracket"==e[0].type&&")"==e[0].data)break;if(s){var n=this.parseBoolExpression(t,i);n.type="expr",r.push(n)}else"sep"==(a=e.shift()).type||this.throwError(t,"Expected ',' or ')', got '"+a.data+"'");s=!s}return r}peekIfNextIsOpenBracket(t){var e=t.tokens;return e.length>0&&"bracket"==e[0].type&&"("==e[0].data}parseSubExpression(t){var e=t.tokens.shift();"bracket"==e.type&&"("==e.data||this.throwError(t,'parsing subexpression, expected "bracket", not \''+e.data+"'");var r=[];r.push({type:"bracket",data:")"});var s=this.parseBoolExpression(t,r);return t.tokens.shift(),s.type="expr",s}tokensToString(t){var e="";return"@@@all"==t.data?e+"'"+t.type+"'":e+"'"+t.data+"'"}endTokensToString(t){for(var e="",r=0;r<t.length;r++){var s=t[r];""!=e&&(e+=" "),e+=this.tokensToString(s)}return e}isEndToken(t,e){for(var r=0;r<e.length;r++){var s=e[r];if(t.type==s.type&&t.data==s.data)return!0;if(t.type==s.type&&"@@@all"==s.data)return!0}return!1}parseSimpleExpression(t,e){var r,s=t.tokens;if(0!=s.length){var i,a=void 0;if((i=s.shift())||this.throwError(t,"empty simple expression"),(r=this.isEndToken(i,e))&&this.throwError(t,"empty simple expression"),"op"==i.type&&"-"==i.data){var n=this.parseSimpleExpression(t,e);return n[0].data=-n[0].data,n}return"num"==i.type?a={type:"num",data:i.data}:"str"==i.type&&(a={type:"str",data:i.data}),(i=s.shift())&&((r=this.isEndToken(i,e))||(r=0==t.tokens.length),r||this.throwError(t,"Empty simple expression end expected")),[a,i]}}parseBoolExpression(t,e){for(var r=[],s=t.tokens,i=0;i<e.length;i++)r.push(e[i]);r.push({type:"bop",data:"OR"}),r.push({type:"bop",data:"AND"});for(var a=!0,n=[],o=null;;){var h=this.parseExpression(t,r);if(a&&0==s.length)return h;a=!1;var l=null;if(null!=o&&(l=o.data),h.op=l,h.type="expr",h.dbg="1",n.push(h),!(s.length>0&&"bop"==s[0].type))break;o=s.shift()}if(1==n.length)return n[0].dbg2="len=1",n[0];var p={negate:!1,binaryNegate:!1,type:"expr",parts:[],op:null};for(i=0;i<n.length;i++)p.parts.push(n[i]);return p}parseExpression(t,e){var r=t.tokens;if(0==r.length)return null;for(var s,i={parts:[],negate:!1,binaryNegate:!1},a=!0,n=null,o=i.parts,h=!0,l=!1,p=!1;;){var u,d;if(!(u=r.shift()))break;if(this.isEndToken(u,e)){r.unshift(u);break}if(a){if("num"==u.type)d={type:"num",data:u.data,op:n},l&&(d.data=-d.data),o.push(d),h=!1,l=!1;else if("str"==u.type)d={type:"str",data:u.data,op:n},o.push(d),l&&this.throwError(t,"found negation on a string","type mismatch"),h=!1;else if("bracket"==u.type&&"("==u.data){r.unshift(u);var g=[];g.push({type:"bracket",data:")"});var c=this.parseSubExpression(t,g);c.op=n,c.negate=l,c.binaryNegate=p,o.push(c),h=!1,l=!1}else if("name"==u.type){var m=u.data,f="FN"==m;if(this.peekIfNextIsOpenBracket(t)){u=r.shift();var v=this.parseFunParList(t);if(r.shift(),d={type:"funCall",params:v,op:n,functionName:m},-1==this.KEYWORDS.indexOf(m)&&(d={type:"array",data:m,op:n,indices:v}),null==n&&l){var y={parts:[d],negate:!0,binaryNegate:!1,type:"expr"};o.push(y)}else o.push(d)}else f?(m=(u=r.shift()).data,u=r.shift(),v=this.parseFunParList(t),r.shift(),d={type:"defFnCall",params:v,op:n,functionName:m},null==n&&l?(y={parts:[d],negate:!0,binaryNegate:!1,type:"expr"},o.push(y)):o.push(d)):(d={type:"var",data:u.data,op:n},null==n&&l?(y={parts:[d],negate:!0,binaryNegate:!1,type:"expr"},o.push(y)):o.push(d));l=!1,h=!1}else{if("op"==u.type&&"-"==u.data){l=!l;continue}if("bop"==u.type&&"NOT"==u.data&&h){p=!p,i.binaryNegate=p,this.debugFlag&&console.log("NOT");continue}this.throwError(t,'Expected "number", "string", "symbol" or "bracket", not '+u.data)}n=null}else"op"==u.type||"comp"==u.type||"eq"==u.type||"bop"==u.type?n=u.data:this.throwError(t,'Expected "operator" or one of ('+this.endTokensToString(e)+"), not '"+u.data+"'");a=!a}if(null!=n&&(d={type:"uniop",data:null,op:n},o.push(d)),null==i.parts)return null;s=this.groupParts(i.parts,"^"),s=this.groupParts(s,"/");var b=i;return{parts:s=this.groupParts(s,"*"),negate:b.negate,binaryNegate:b.binaryNegate}}groupParts(t,e){for(var r=[],s=[],i=0;i<t.length;i++)r.push(t[i]);for(i=0;i<r.length;i++){var a=r[i];if(i>0&&a.op==e){var n=r[i-1],o={negate:!1,binaryNegate:!1,type:"expr",parts:[],op:n.op};o.parts[0]=n,o.parts[0].op=null,o.parts[1]=a,r[i-1]=null,r[i]=o}}for(i=0;i<r.length;i++)null!=(a=r[i])&&s.push(a);return s}normalizeStatementName(t){return"?"==t?"print":t}parseAssignment(t,e,r,s,i,a){t.tokens,s.type="assignment",s.var=i,s.arrayAssignment=!1;var n=[];n.push({type:"cmdsep",data:"@@@all"}),s.expression=this.parseBoolExpression(t,n),r.push(s)}parseArrayAssignment(t,e,r,s,i,a){var n=a,o=t.tokens;s.type="assignment",s.var=i,s.arrayAssignment=!0;var h=this.parseFunParList(t);s.indices=h,o.shift(),this.debugFlag&&console.log("tokens after:",o),void 0===(n=o.shift())&&(n={type:"@@@notoken"}),"eq"!=n.type&&this.throwError(t,"Expected =");var l=[];l.push({type:"cmdsep",data:"@@@all"}),s.expression=this.parseBoolExpression(t,l),r.push(s)}parseControlStructure(t,e,r,s,i,a){var n=a,o=t.tokens;s.type="control";var h=i;if(s.controlKW=i.toLowerCase(),"@@@notoken"!=n.type&&o.unshift(n),"LET"==h)"name"!=(n=o.shift()).type&&this.throwError(t,"LET expects var name"),i=n.data,void 0===(n=o.shift())&&(n={type:"@@@notoken"}),"eq"==n.type?this.parseAssignment(t,e,r,s,i,n):"bracket"==n.type&&"("==n.data?this.parseArrayAssignment(t,e,r,s,i,n):this.throwError(t,"Unexpected data after 'LET': '"+n.data+"'");else if("DIM"==h){var l=!0;for(s.params=[],s.arrayNames=[];;){if(n=o.shift(),!l){if(void 0===n)break;if("sep"!=n.type||","!=n.data){o.unshift(n);break}n=o.shift()}"name"!=n.type&&this.throwError(t,"DIM expects var name"),i=n.data,void 0===(n=o.shift())&&(n={type:"@@@notoken"}),"bracket"==n.type&&"("==n.data||this.throwError(t,"DIM expects (");var p=this.parseFunParList(t);void 0===(n=o.shift())&&(n={type:"@@@notoken"}),"bracket"==n.type&&")"==n.data||this.throwError(t,"DIM expects )"),s.params.push(p),s.arrayNames.push(i),l=!1}r.push(s)}else if("DEF"==h){"name"==(n=o.shift()).type&&"FN"==n.data||this.throwError(t,"DEF expects FN"),"name"!=(n=o.shift()).type&&this.throwError(t,"DEF FN expects function name");var u=n.data;"bracket"==(n=o.shift()).type&&"("==n.data||this.throwError(t,"DEF FN expects function name and ->( varname )"),"name"!=(n=o.shift()).type&&this.throwError(t,"DEF FN expects function name and ( ->varname )");var d=n.data;"bracket"==(n=o.shift()).type&&")"==n.data||this.throwError(t,"DEF FN expects function name and ( varname -> )"),"eq"==(n=o.shift()).type&&"="==n.data||this.throwError(t,"DEF FN expects function name and ( varname ) -> ="),E=[];var g=this.parseBoolExpression(t,E);this.debugFlag&&console.log("expr = "+g),s.params=[],s.params[0]=u,s.params[1]=d,s.params[2]=g,r.push(s)}else if("GOTO"==h||"GOSUB"==h){var c=-1;if(void 0===(n=o.shift())&&this.throwError(t,"GOTO/GOSUB expects number","undef'd statement"),"num"!=n.type){o.unshift(n),(E=[]).push({type:"cmdsep",data:"@@@all"});var m=this.parseBoolExpression(t,E);return s.params=[],s.params[0]=m,void r.push(s)}c=parseInt(n.data),void 0!==(n=o.shift())&&"cmdsep"!=n.type&&this.throwError(t,'Expected "command separator", instead of \''+n.data+"'"),s.params=[],s.params[0]=c,r.push(s)}else if("ON"==h){var f=[];(E=[]).push({type:"name",data:"GOTO"}),E.push({type:"name",data:"GOSUB"});var v=this.parseBoolExpression(t,E);"name"!=(n=o.shift()).type&&this.throwError(t,"ON expects GOTO/GOSUB"),"GOTO"!=n.data&&"GOSUB"!=n.data&&this.throwError(t,"ON expects GOTO/GOSUB");var y=n.data;for("num"!=(n=o.shift()).type&&this.throwError(t,"ON GOTO/GOSUB expects number","undef'd statement"),"num"!=n.type&&this.throwError(t,"ON GOTO/GOSUB expects number","undef'd statement"),f.push(parseInt(n.data));null!=(n=o.shift())&&"cmdsep"!=n.type&&"cmdsep"!=n.type;)"sep"==n.type&&","==n.data||this.throwError(t,"ON GOTO/GOSUB expects numberlist"),"num"!=(n=o.shift()).type&&this.throwError(t,"GOTO/GOSUB expects number"),f.push(parseInt(n.data));s.params=[],s.params[0]=y.toLowerCase(),s.params[1]=v,s.params[2]=f,r.push(s)}else if("RETURN"==h)c=-1,s.params=[],r.push(s);else if("END"==h)c=-1,s.params=[],r.push(s);else if("STOP"==h)c=-1,s.params=[],r.push(s);else if("FOR"==h){var b,x,_,E=[];if("name"!=(n=o.shift()).type&&this.throwError(t,"For expects variable, no var found, found "+n.type+"/"+n.data),w=n.data,"eq"==(n=o.shift()).type&&"="==n.data||this.throwError(t,"For expects '=', not found, found "+n.type+"/"+n.data),(E=[]).push({type:"name",data:"TO"}),b=this.parseBoolExpression(t,E),"name"==(n=o.shift()).type&&"TO"==n.data||this.throwError(t,"For expects 'to', not found, found "+n.type+"/"+n.data),(E=[]).push({type:"cmdsep",data:":"}),E.push({type:"name",data:"STEP"}),x=this.parseBoolExpression(t,E),_={parts:[{data:"1",op:null,type:"num"}]},void 0!==(n=o.shift()))if("name"==n.type&&"STEP"==n.data)(E=[]).push({type:"cmdsep",data:":"}),_=this.parseBoolExpression(t,E);else if("cmdsep"!=n.type||":"!=n.data)throw"FOR: unexpected token '"+n.data+"'";s.controlKW="for:init",s.params=[],s.params[0]=b,s.params[1]=x,s.params[2]=_,s.variable=w,r.push(s),this.debugFlag&&console.log("command=",s)}else if("NEXT"==h){for(var w,C=!1;(n=o.shift())&&"cmdsep"!=n.type;){if("name"!=n.type)throw"Next expected variable, not '"+n.data+"'";var P={controlKW:"for:next",nextVar:n.data,lineNumber:s.lineNumber,type:s.type};if(r.push(P),C=!0,!(n=o.shift()))break;if("cmdsep"==n.type)break;if("sep"!=n.type||","!=n.data)throw"Expected comma, found '"+n.data+"'"}C||(s.controlKW="for:next",s.nextVar=null,r.push(s))}else if("IF"==h){(E=[]).push({type:"name",data:"THEN"}),E.push({type:"name",data:"GOTO"});var T=this.parseBoolExpression(t,E);if(s.params=[T],"name"==(n=o.shift()).type&&"GOTO"==n.data){var F={data:"GOTO",type:"name"};o.unshift(F)}else o.length>0&&"num"==o[0].type&&(F={data:"GOTO",type:"name"},o.unshift(F));var L=this.parseLineCommands(t);this.debugFlag&&console.log(L),r.push(s);for(var S=0;S<L.length;S++)r.push(L[S])}else if("DATA"==h){var k=[];for((E=[]).push({type:"cmdsep",data:":"}),E.push({type:"sep",data:","});;){var N=this.parseSimpleExpression(t,E);if(void 0===(T=N[0]))throw"DATA: expected data";if(k.push(T),void 0===(n=N[1]))break;if("cmdsep"==n.type&&":"==n.data)break;"sep"==n.type&&","==n.data||this.throwError(t,"data unknown token found "+n.type+"/"+n.data)}s.params=k,r.push(s)}else if("REM"==h){for(;null!=(n=o.shift()););r.push(s)}else this.throwError(t,s.controlKW+" not implemented")}parseStatementCall(t,e,r,s,i,a){var n=a,o=t.tokens;for(s.statementName=this.normalizeStatementName(i),s.type="call","@@@notoken"!=n.type&&o.unshift(n),s.params=[];;){var h=!1,l=[];l.push({type:"sep",data:"@@@all"}),l.push({type:"cmdsep",data:"@@@all"});var p=this.parseBoolExpression(t,l);if(this.debugFlag&&console.log(p),null!=p)if(s.params.push(p),null!=(n=o.shift()))if(void 0===n&&(h=!0),"cmdsep"==n.type)h=!0;else{if("sep"==n.type)continue;this.throwError(t,"Unexpected characters in statement call: '"+n.data+"'")}else h=!0;else h=!0;if(h){r.push(s);break}}}parseLineCommands(t,e){for(var r=t.tokens,s=[];;){var i,a={},n=!1,o=!1;if(a.lineNumber=t.lineNumber,void 0===(i=r.shift()))break;if("cmdsep"!=i.type){"name"!=i.type&&("trash"!=i.type?this.throwError(t,"Unexpected token, expected symbolname, got '"+oken.data+"'"):this.throwError(t,'Unexpected character, expected "symbolname", got '+i.detail));var h=i.data;this.CTRL_KW.indexOf(i.data)>-1&&(o=!0),(this.KEYWORDS.indexOf(i.data)>-1||"XON"==i.data||this.SHORTCUT_KW.indexOf(i.data)>-1)&&(n=!0),void 0===(i=r.shift())&&(i={type:"@@@notoken"}),o?this.parseControlStructure(t,e,s,a,h,i):"eq"==i.type?this.parseAssignment(t,e,s,a,h,i):"bracket"!=i.type||"("!=i.data||n?(n||(console.log("Dump: ",t,e,s,a,h,i),this.throwError(t,"no such statement: "+h)),this.parseStatementCall(t,e,s,a,h,i)):this.parseArrayAssignment(t,e,s,a,h,i)}}return s}logTokens(t){if(this.debugFlag){for(var e="",r=0;r<t.length;r++)""!=e&&(e+=", "),e+=(s=t[r]).type+":"+s.data;for(console.log(e),r=0;r<t.length;r++){var s=t[r];console.log("token: ",s)}}}parseLine(t){var e,r,s={lineNumber:-1,commands:[]},i=-1;try{e="tokenizer",r="init";var a=new p(new l(t),this.KEYWORDS);r="parsing tokens";var n=a.tokenize();if(this.debugFlag&&console.log("Tokens after tokenizer"),this.logTokens(n),r="internal",n=this.upperCaseNameTokens(n),n=this.removePadding(n),n=this.mergeCompTokens(n),n=this.mergeBrokenUpTokens(n),this.debugFlag&&console.log("Tokens after merge"),this.logTokens(n),0==n.length)return null;"num"==n[0].type&&(s.lineNumber=n[0].data,i=n[0].data,n.shift());var o={tokens:n,lineNumber:s.lineNumber};e="parser",r="parsing commands";var h=this.parseLineCommands(o);return s.commands=h,s.raw=t,s}catch(t){if(this.erh.isError(t))throw-1==t.lineNr&&-1!=i&&(t.lineNr=i),t;this.throwError(null,e+" error ("+t+") while "+r)}}getTokens(t,e,r){try{var s=new p(new l(t),this.KEYWORDS).tokenize();return r&&(s=this.removePadding(s)),e&&(s=this.mergeCompTokens(s)),this.logTokens(s),s}catch(t){console.log(t),this.throwError(null,"getTokens error","internal")}}}class l{constructor(t){this.buffer=t,this.index=0,this.lineIndex=1,this.line=1}peek(){return this.buffer.substr(this.index,1)}peek2(){return this.buffer.substr(this.index,2)}unconsume(t){this.index-=t}consume(){var t=this.buffer.substr(this.index,1);this.index++,"\n"==t&&(this.line++,this.lineIndex=1)}EOF(){var t=this.buffer.length;return!(this.index<t)}}class p{constructor(t,e){this.tokens=[],this.reader=t,this.keywords=e,this.greedy=!1}isOpChar(t){return[null!=t.c.match("[+]|[-]|[*]|[/]|[\\^]|[;]"),0]}isCompChar(t){return["<"==t.c||">"==t.c,0]}isEqChar(t){return"="==t.c?[!0,0]:[!1,0]}isNameChar(t){if(t.endFound)return[!1,0];var e=null!=t.c.match("[a-zA-Z0-9$%?]");if("$"!=t.c&&"%"!=t.c||(t.endFound=!0),this.greedy)if(this.keywords.indexOf(t.seq.toUpperCase())>-1)t.endFound=!0;else if(void 0!==t.seq)for(var r=0;r<this.keywords.length;r++){var s=this.keywords[r];if(t.seq.toUpperCase().indexOf(s)>0)return[e,s.length]}return[e,0]}isNumChar(t){return[null!=t.c.match("[0-9.~]"),0]}isPadChar(t){return" "==t.c||"\t"==t.c||"\n"==t.c||"\r"==t.c?[!0,0]:[!1,0]}isCommandSepChar(t){return":"==t.c?[!0,0]:[!1,0]}isSepChar(t){return","==t.c?[!0,0]:[!1,0]}isAnyChar(t){return[!0,0]}isBracket(t){return"("==t.c||")"==t.c||"["==t.c||"]"==t.c?[!0,0]:[!1,0]}isStrChar(t){return t.endFound?[!1,0]:0==t.index?'"'==t.c?(t.inString=!0,[!0,0]):[!1,0]:t.inString?(t.index>0&&'"'==t.c&&(t.endFound=!0),[!0,0]):[!1,0]}normalizeToken(t){var e=t;return e.type=t.type,"str"==e.type&&(e.data=t.data.substr(1,t.data.length-2)),e}readChars(t,e,r,s){for(var i={type:e,data:""},a={index:0,prev:null,seq:""};!t.EOF();){var n=t.peek();a.seq+=n,a.c=n;var o=this[r](a);if(o[1]>0){t.unconsume(o[1]-1),a.seq=a.seq.substr(0,a.seq.length-o[1]),i.data=a.seq;break}if(!o[0])return this.normalizeToken(i);if(i.data+=n,t.consume(),a.index++,a.prev=n,"chr"==s)break}return this.normalizeToken(i)}tokenize(){var t=this.reader,e=[],r=[];for(r.push(["pad","isPadChar","str"]),r.push(["str","isStrChar","str"]),r.push(["num","isNumChar","str"]),r.push(["name","isNameChar","str"]),r.push(["op","isOpChar","chr"]),r.push(["comp","isCompChar","chr"]),r.push(["eq","isEqChar","chr"]),r.push(["bracket","isBracket","chr"]),r.push(["sep","isSepChar","chr"]),r.push(["cmdsep","isCommandSepChar","chr"]),r.push(["trash","isAnyChar","chr"]);!t.EOF();){for(var s=t.peek(),i=!1,a=0;a<r.length;a++){var n=r[a],o={index:0,c:s};if(this[n[1]](o)[0]){var h=this.readChars(t,n[0],n[1],n[2]);"name"==h.type&&(h.data=h.data.toUpperCase()),"trash"==h.type&&(h.detail="'"+h.data+"' (ASCII-code="+h.data.charCodeAt(0)+")"),e.push(h),i=!0;break}}if(!i)throw"syntax error, unexpected character: '"+s+"' =>"+t.line+":"+t.lineIndex}return e}}t.log("Starting"),t.log("Starting wsys"),t.processes=new class{constructor(t){this.sys=t,this.processes=[],this.count=0;var e=this.processes;this.sys.log("Starting process interval"),setInterval((function(){for(var t=0;t<e.length;t++)e[t]&&e[t].cycle()}),100)}getTicks(){return this.count}register(t){var e=this.processes.length-1;return this.processes[e]=t,t.processId=e,e}get(t){return this.processes[t]}register(t){var e=this.processes.length;return this.processes.push(t),t.processId=e,e}getRoot(){return this.processes[0]}}(t),t.input=new class{constructor(t){this.keyPress=[],this.interactive=!1,this.sys=t}setHandler(t){this.handlerClazz=t}setInterActive(t){this.interactive=t,this.sys.blinkMode(t)}inputKeyHandler(t){var e=this.handlerClazz;this.interactive?e.interactiveKeyHandler(t):"Escape"==t.keyLabel?e.stop():this.keyPress.push(t)}getKey(){return this.keyPress.shift()||null}}(t),t.out=new class{constructor(t){this.sys=t,this.cursorOn=!1,this.cols=80,this.rows=30,this.x=0,this.y=0,this.hidden=!1,this.dc=!1,this.dcCmd=!1,this.colors={},this.reverse=!1,this.colors.txtBgColor=0,this.colors.txtColor=5,this.initialized=!1,this.changes={all:!1,list:[]}}reInit(t,e){this._int_initMode(t,e)}destroy(){this.cellel=void 0,this.changes={all:!1,list:[]},this.initialized=!1}_int_addChangeAll(){this.changes.all=!0,this.changes.list=[]}_int_addChange(t){if(this.changes.all)this.changes.list.length>0&&(this.changes.list=[]);else{var e=this.changes.list;if(e.length>0){var r=e[e.length-1],s=t;if(r.y1==r.y2&&s.y1==s.y2&&r.y1==s.y1&&s.x1==r.x2+1){r.x2;for(var i=r.cells[0],a=0;a<t.cells[0].length;a++){var n=t.cells[0][a];i.push(n)}return void(r.x2=s.x2)}}this.changes.list.push(t)}}_int_flushAll(){this.changes.all=!0,this.changes.list=[],this._int_flush()}_int_getArea(t,e,r,s){for(var i=[],a=e;a<=s;a++){for(var n=[],o=t;o<=r;o++)n.push(this.cellel[a][o]);i.push(n)}return{cells:i,x1:t,y1:e,x2:r,y2:s}}_int_flush(){this.changes.all?(this.sys.post("textupdate-all",{fg:this.colors.txtColor,bg:this.colors.txtBgColor,cx:this.x,cy:this.y,cells:this.cellel}),this.changes.all=!1):this.changes.list.length>0?(this.sys.post("textupdate",{fg:this.colors.txtColor,bg:this.colors.txtBgColor,cx:this.x,cy:this.y,areasList:this.changes.list}),this.changes.list=[]):this.sys.post("textupdate",{fg:this.colors.txtColor,bg:this.colors.txtBgColor,cx:this.x,cy:this.y,areasList:[]})}attach(t,e){this._int_initMode(t,e)}_int_initMode(t,e){this.initialized&&this.destroy(),this.sys,this.x=0,this.y=0,this.rows=e,this.cols=t,this.colors.txtBgColor=0,this.colors.txtColor=5,this.cellel=[];for(var r=0;r<this.rows;r++){for(var s=[],i=0;i<this.cols;i++){var a={txt:" ",fg:this.colors.txtColor,bg:this.colors.txtBgColor};s.push(a)}this.cellel.push(s)}this.changes={all:!0,list:[]},this._int_flushAll(),this.sys.log("TBCON w Ready."),this.initialized=!0}getDimensions(){return[this.cols,this.rows]}getCurrentLine(){for(var t=this.y,e="",r=0;r<this.cols;r++)e+=this.cellel[t][r].txt;return e}clear(){this.cellel=[];for(var t=0;t<this.rows;t++){for(var e=[],r=0;r<this.cols;r++){var s={txt:" ",fg:this.colors.txtColor,bg:this.colors.txtBgColor};e.push(s)}this.cellel.push(e)}this.changes={all:!0,list:[]},this.x=0,this.y=0,this._int_flushAll()}cursorMove(t){"up"==t?this.y>0&&this.y--:"down"==t&&this.y<this.rows-1&&this.y++,"left"==t?this.x>0&&this.x--:"right"==t&&this.x<this.cols-1&&this.x++,this._int_flush()}backspace(){if(0!=this.x){this.x--,this.cellel[this.y][this.x].txt=" ";var t=this._int_getArea(this.x,this.y,this.x,this.y);this._int_addChange(t),this._int_flush()}}nl(){if(this.x=0,this.y++,this.y>=this.rows)return this.__int_scrollDown(),this.y=this.rows-1,void this._int_flushAll();this._int_flush()}__int_nl(){return this.x=0,this.y++,this.y>=this.rows?(this.__int_scrollDown(),this.y=this.rows-1,{scroll:!0}):{scroll:!1}}writeln(t){for(var e=0;e<t.length;e++){var r=t.substr(e,1);this.__int_write_direct_ch(r)}this.__int_nl().scroll&&this._int_addChangeAll(),this._int_flush()}_int_write(t){for(const e of t)this.__int_write_direct_ch(e)}write(t){this._int_write(t),this._int_flush()}__int_write_direct_ch(t){var e=t.codePointAt(0);if(this.dc&&this.dcCmd)return this.dc=!1,this.dcCmd=!1,void this._int_control(this.dcCmdCode,e);if(this.dc&&!this.dcCmd)return this.dcCmd=!0,void(this.dcCmdCode=e);if(17==e)return this.dc=!0,void(this.dcCmd=!1);var r=this.cellel[this.y][this.x];if(null!=r){r.txt=t,this.reverse?(r.bg=this.colors.txtColor,r.fg=this.colors.txtBgColor):(r.fg=this.colors.txtColor,r.bg=this.colors.txtBgColor);var s=this.x,i=this.y;if(this.x++,this.x>=this.cols)return this.x=0,void(this.__int_nl().scroll&&this._int_addChangeAll());var a=this._int_getArea(s,i,s,i);this._int_addChange(a)}else console.log("cell at "+this.x+","+this.y+" == null ")}writec(t){"\n"!=t?(this.__int_write_direct_ch(t),this._int_flush()):this.__int_nl().scroll&&this._int_addChangeAll()}_int_setPos(t,e){t>=0&&(this.x=t),e>=0&&(this.y=e),this.x>=this.cols&&(this.x=this.cols-1),this.y>=this.rows&&(this.y=this.rows-1)}setPos(t,e){this._int_setPos(t,e),this._int_flush()}_int_control(t,e){16==t?this.colors.txtColor=e:17==t?this.colors.txtBgColor=e:18==t?document.body.style.backgroundColor=this.palette[e]:24==t?this.clear():25==t||(64==t?this.reverse=!1:65==t?this.reverse=!0:this.__int_write_direct_ch("?"))}setCursorPos(t,e){t<0||e<0||t>=this.cols||e>=this.rows||(this.x=t,this.y=e,this._int_flush())}getCursorPos(){return[this.x,this.y]}control(t,e){this._int_control(t,e),this._int_flush()}center(t){if(!(t.length>this.cols)){var e=t.length,r=Math.floor(e/2),s=this.getDimensions(),i=Math.floor(s[0]/2)-r;this._int_setPos(i,-1),this._int_write(t);var a=this._int_getArea(0,this.y,this.cols-1,this.y);this._int_addChange(a),this._int_flush()}}__int_scrollDown(){for(var t=0;t<this.cols;t++)for(var e=0;e<this.rows-1;e++){var r=this.cellel[e][t],s=this.cellel[e+1][t];r.txt=s.txt,r.fg=s.fg,r.bg=s.bg}var i=this.rows-1;for(t=0;t<this.cols;t++)(r=this.cellel[i][t]).txt=" ",this.reverse?(r.fg=this.colors.txtColor,r.bg="rgba(0,255,0,0.0)"):(r.fg=this.colors.txtColor,r.bg=void 0)}}(t),t.bout=new class{constructor(t){this.sys=t,this.lineColor=1,this.changes={},this.changes.flag=!1,this.changes.pixels=[]}reInit(t,e){this.width=t,this.height=e}attach(t,e){this.reInit(t,e)}isActive(){return this.width>0}getDimensions(){return[this.width,this.height]}line(t,e,r,s){this.sys.post("nativeout",{action:"line",params:{x0:t,y0:e,x1:r,y1:s}})}triggerFlush(){this._int_flush()}_int_flush(){this.changes.flag&&this.sys.post("gfxupdate",{pixels:this.changes.pixels}),this.changes.pixels=[],this.changes.flag=!1}plot(t,e){var r={x:Math.floor(t),y:Math.floor(e),c:this.lineColor};this.changes.pixels.push(r),this.changes.flag=!0}setLineColor(t){this.lineColor=t,this.sys.post("nativeout",{action:"gcolor",params:{c:t}})}destroy(){}}(t),self.onmessage=function(e){try{var r=e.data;if("keydown"==r.type)t.input.inputKeyHandler(r);else if("message"==r.type){var a=r.processId;(h=t.processes.get(a)).receiveMessage(r.message,r.messageObject)}else if("loadpgm"==r.type){t.log("Received 'loadpgm' message. Loaded "+r.pgmData.length+" bytes..");var o=new s(t),h=new i(t,o);t.log("Context created, parsing program");var l=h.bootPGM(r.pgmData,r.QPath);t.log("Parsed program => RUN"),l?(h.runPGM(),t.log("Program started...")):h.stop(),a=t.processes.register(h),t.log("Basic program registered as process "+a+"."),n.addRuntime(h)}else if("inittxtarea"==r.type)t.log("init with: "+JSON.stringify(r)),t.out.attach(r.w,r.h);else if("initbitmap"==r.type)t.log("init with: "+JSON.stringify(r)),t.bout.attach(r.w,r.h);else{var p=e.data;p&&(p=p.type)||(p="????"),t.logerr("Ignored unclassified message type ("+p+") for 'APP://"+t.appName+"':  "+JSON.stringify(e.data))}}catch(e){e.message?t.logerr(e.message+" at "+e.fileName+":"+e.lineNumber):e.clazz&&(t.logerr(e.clazz+": "+e.detail+" at "+e.lineNr),t.out.writeln("?"+e.clazz+" error at "+e.lineNr)),t.logerr(JSON.stringify(e))}}})();
//# sourceMappingURL=basicworker.js.map