(()=>{"use strict";var t=new class{constructor(t){var i={};this.m={},i.m=this.m,this.sys=i,i.init={},i.staticTarget=t,i.domContainer=document.createElement("div"),document.body.appendChild(i.domContainer),i.SIG="boss64",i.VERSION="0.1",i.CODENAME="Papa Smurf",i.nulcon=[],i.nulcon.push("Starting BOSS..."),i.nulcon.push("BOS version "+i.VERSION),i.nulcon.push("BOS signature "+i.SIG),i.nulcon.push('BOS release name "'+i.CODENAME+'"'),i.nulcon.push("Starting Boot Sequence...");var s=document.getElementById("boot");this.rootScript=s,this.displayMode=parseInt(s.dataset.mode),this.bootMode=s.dataset.boot,this.dynamicMinTarget=this.bootMode.indexOf("min")>=0,i.dynamicMinTarget=this.dynamicMinTarget,this.bootDebug=this.bootMode.indexOf("debug")>=0,this.bootDebug&&i.nulcon.push("Enabled debug mode"),this.dynamicMinTarget&&i.nulcon.push("Enabled minimal target settings for dynamic mode"),document.body.style.backgroundColor="#444444"}getSys(){return this.sys}initSimpleLogging(){var t=this.sys;t.out={buf:""};var i=t.out;t.out.getAll=function(){return i.buf},t.out.writeln=function(t){var s="$"+t+"\n";i.buf+=s,console.log(s)},i.writeln("$Init logging..."),t.rawlog=function(i,s){var e=s,r="";r+=i+": ";for(var o=0;o<e.length;o++){var l=" ";0==o&&(l=""),r+=l+e[o]}t.out.writeln(r)},t.rawlogcon=function(t,i){var s=i,e="";e+=t+": ";for(var r=0;r<s.length;r++){var o=" ";0==r&&(o=""),e+=o+s[r]}console.log(e)},t.log=function(){var i=Array.prototype.slice.call(arguments);t.rawlog("info",i),console.log.apply(console,i)},t.logwarn=function(){var i=Array.prototype.slice.call(arguments);t.rawlog("warn",i),console.warn(i)},t.logerr=function(){var i=Array.prototype.slice.call(arguments);t.rawlog("error",i),console.error.apply(console,i)},this.logerr=t.logerr,this.logwarn=t.logwarn,this.log=t.log,this.bootDebug||(t.rawlog=t.rawlogcon)}}(!0),i=t.getSys();t.dep={},t.i={},t.i.displaymodes=class{constructor(t){this.initialized=!1,this.default=100,this.sys=t,this.drivers=[]}init(){this.initialized||(this.drivers.text=this.sys.m.tablecon,this.drivers.canvas=this.sys.m.canvas,this.modes=[],this.modes[0]="text:80x30:font=14",this.modes[1]="text:80x30:font=16",this.modes[2]="text:80x30:font=18",this.modes[3]="text:80x30:font=22",this.modes[4]="text:80x50:font=14",this.modes[5]="text:80x50:font=16",this.modes[6]="text:80x50:font=18",this.modes[7]="text:80x50:font=22",this.modes[8]="text:120x50:font=14",this.modes[9]="text:120x50:font=16",this.modes[10]="text:120x50:font=18",this.modes[11]="text:120x50:font=22",this.modes[12]="text:80x150:font=14",this.modes[13]="text:80x150:font=16",this.modes[14]="text:80x150:font=18",this.modes[15]="text:80x150:font=22",this.modes[100]="canvas:1024x768",this.modes[200]="canvas:800x600",this.modes[201]="canvas:640x512",this.modes[202]="canvas:640x480",this.modes[203]="canvas:640x400",this.modes[204]="canvas:320x512",this.modes[205]="canvas:320x400",this.modes[206]="canvas:320x256",this.modes[207]="canvas:320x200")}getDriver(){return this.currentDriver}getMode(t){return this.init(),t?this.modes[t]:getMode(this.default)}setMode(t){this.init(),(null==t||-1===t||Number.isNaN(t))&&this.setMode(this.default);var i=this.getDeviceConfig(t);if(i){var s=this.currentMode;null==s||-1===s||Number.isNaN(t)||this.endMode(this.currentMode),i.device.initMode(i.config),this.currentMode=t,this.currentDriver=i.device}}endMode(){this.init(),this.currentDriver&&(this.currentDriver.destroy(),this.currentMode=void 0,this.currentDriver=void 0)}getDeviceConfig(t){if(null!=t&&-1!==t&&!Number.isNaN(t)&&this.modes[t]){var i=this.modes[t].split(":");if(!(i.length<2)){var s=i[0];if(this.drivers[s])return{device:this.drivers[s],config:i.splice(1)}}}}},t.i.tablecon=class{constructor(t){this.sys=t,this.cursorOn=!1,this.cols=80,this.rows=30,this.x=0,this.y=0,this.hidden=!1,this.blinking=!0,this.reverse=!1,this.outColors={},this.fontSizeInt=18,this.fontSizeCSS=this.fontSizeInt+"px",this.fontFamily="monospace",this.colors=["#000000","#ffffff","#ee2222","#22ee22","#2222ee","#eeee22","#22eeee","#ee22ee","#aaaaaa","#777777","#444444","#FFAC1C","#5C3317","#F88379","#79F883","#8379F8"],this.outColors.txtBgColor=this.colors[0],this.outColors.txtColor=this.colors[5]}destroy(){this.outDiv0.remove(),this.cvs=null,this.cvs2=null,this.ctx=null,this.ctx2=null,this.rowel=void 0,this.cellel=void 0,this.blinkInterval&&(clearInterval(this.blinkInterval),this.blinkInterval=void 0)}init(){}getColumCount(){return this.cols}getRowCount(){return this.rows}getDimensions(){return[this.cols,this.rows]}initMode(t){var i=this.sys,s=i.init.queuedMessages;i.init.inputElement=document.body,this.x=0,this.y=0,this.blinking=!0;var e=t[0].split("x");if(2==e.length&&(this.rows=parseInt(e[1]),this.cols=parseInt(e[0]),2==(e=t[1].split("=")).length)){this.fontSizeInt=parseInt(e[1]),this.fontSizeCSS=this.fontSizeInt+"px",this.colsPercentage=1/this.cols*100,this.outColors.txtBgColor=this.colors[4],this.outColors.txtColor=this.colors[1],this.outDiv0=document.createElement("div"),this.outDiv1=document.createElement("div"),this.outEl=document.createElement("table"),this.outEl.value="",this.outDiv0.addEventListener("copy",(t=>{var i=function(){if(document.selection&&document.selection.createRange)return document.selection.createRange().toString();if(window.getSelection){var t=window.getSelection();if(t.rangeCount>0){for(var i=t.getRangeAt(0).cloneContents().childNodes,s="",e=0;e<i.length;e++){""!=s&&(s+="\n");for(var r=i[e].childNodes,o=0;o<r.length;o++)s+=r[o].firstChild.data}return s}return""}return""}();t.clipboardData.setData("text/plain",i),t.preventDefault()})),this.table=this.outEl,this.table.style.borderCollapse="collapse",this.table.style.borderSpacing=0,this.table.style.backgroundColor=this.outColors.txtBgColor,this.table.style.resize="none",this.table.style.fontFamily=this.fontFamily,this.table.style.fontSize=this.fontSizeCSS,this.table.style.tableLayout="fixed",this.table.readOnly=!0,this.table.textAlign="center",this.rowel=[],this.cellel=[];for(var r=0;r<this.rows;r++){var o=document.createElement("tr");o.style.padding="0px",o.style.maxHeight=this.fontSizeInt,o.style.height=this.fontSizeInt,this.rowel.push(o),this.outEl.appendChild(o);for(var l=[],h=0;h<this.cols;h++){var n=document.createElement("td");n.style.padding="0px",n.style.color=this.outColors.txtColor,n.style.backgroundColor=void 0,n.style.textOverflow="",n.style.whiteSpace="nowrap",n.style.overflow="hidden",n.style.maxWidth=this.fontSizeInt,n.style.maxHeight=this.fontSizeInt,n.style.height=this.fontSizeInt,n.innerHTML="&nbsp;",l.push(n),o.appendChild(n)}this.cellel.push(l)}document.body.appendChild(this.outDiv0),this.outDiv0.style.display="table",this.outDiv0.style.width="99%",this.outDiv0.style.height="99%",this.outDiv0.style.position="absolute",this.outDiv0.style.zIndex="10000",this.outDiv1.style.display="table-cell",this.outDiv1.style.verticalAlign="middle",this.table.style.marginLeft="auto",this.table.style.marginRight="auto",this.outDiv0.appendChild(this.outDiv1),this.outDiv1.appendChild(this.outEl),this.outEl.focus(),this.dirty=!0,this.dirtyFlags={bg:!0,color:!0};var a=this;this.blinkInterval=setInterval((function(){a._int_blink()}),500);for(var c=0;c<s.length;c++)this.writeln(s[c]);this.sys.log("TBCON Ready.")}}native(t){throw"@Operation "+t.action+" not supported on TABLECON"}blinkMode(t){this.blinking=t}hasPixels(){return!1}_int_updateArea(t,i,s,e,r){for(var o=i;o<=e;o++)for(var l=s;l<=r;l++){var h=this.cellel[l][o],n=t[l-s][o-i];" "==n.txt?h.innerHTML="&nbsp;":h.textContent=n.txt,h.style.color=this.colors[n.fg],h.style.backgroundColor=this.colors[n.bg]}}update(t,i){this._int_blinkOff(),this.show(),this.x=t.cx,this.y=t.cy,(this.x<0||this.y<0||this.x>=this.cols||this.y>=this.rows)&&console.log("ouch"),this.outColors.txtBgColor=this.colors[t.bg],this.outColors.txtColor=this.colors[t.fg];for(var s=0;s<i.length;s++){var e=i[s];this._int_updateArea(e.cells,e.x1,e.y1,e.x2,e.y2)}}updateAll(t,i){this._int_blinkOff(),this.show(),this.x=t.cx,this.y=t.cy,(this.x<0||this.y<0||this.x>=this.cols||this.y>=this.rows)&&console.log("ouch"),this.outColors.txtBgColor=this.colors[t.bg],this.outColors.txtColor=this.colors[t.fg],this._int_updateArea(i,0,0,this.cols-1,this.rows-1)}hide(){this.hidden||(this.outDiv0.hidden=!0,this.hidden=!0)}show(){this.hidden&&(this.outDiv0.hidden=!1,this.hidden=!1)}getElement(){return null}_int_blinkOff(){if(this.cursorOn){this.cursorOn=!1;var t=this.cellel[this.y][this.x];null!=t?(t.style.color=this.outColors.txtColor,t.style.backgroundColor=this.outColors.txtBgColor):console.log("cell at "+this.x+","+this.y+" == null ")}}_int_blink(){if(this.blinking){var t;try{t=this.cellel[this.y][this.x]}catch{t=null}null!=t?(this.cursorOn=!this.cursorOn,this.cursorOn?(t.style.backgroundColor=this.outColors.txtColor,t.style.color=this.outColors.txtBgColor):(t.style.color=this.outColors.txtColor,t.style.backgroundColor=this.outColors.txtBgColor)):console.log("Blink exception: Cell at "+this.x+","+this.y+" == null ")}}clear(){this._int_blinkOff(),this.show();for(var t=0;t<this.cols;t++)for(var i=0;i<this.rows;i++){var s=this.cellel[i][t];s.innerHTML="&nbsp;",s.style.color=this.outColors.txtColor,s.style.backgroundColor=this.outColors.txtBgColor}this.x=0,this.y=0}__int_nl(){this.x=0,this.y++,this.y>=this.rows&&(this.__int_scrollDown(),this.y=this.rows-1)}writeln(t){this._int_blinkOff(),this.show();for(var i=0;i<t.length;i++){var s=t.substr(i,1);this.__int_write_direct_ch(s)}this.__int_nl()}__int_write_direct_ch(t){var i=this.cellel[this.y][this.x];null!=i?(i.innerHTML=" "==t?"&nbsp":t,this.reverse?(i.style.backgroundColor=this.outColors.txtColor,i.style.color=this.outColors.txtBgColor):(i.style.color=this.outColors.txtColor,i.style.backgroundColor=void 0),this.x++,this.x>=this.cols&&(this.x=0,this.__int_nl())):console.log("cell at "+this.x+","+this.y+" == null ")}__int_scrollDown(){for(var t=0;t<this.cols;t++)for(var i=0;i<this.rows-1;i++){var s=this.cellel[i][t],e=this.cellel[i+1][t];s.textContent=e.textContent,s.style.color=e.style.color,s.style.backgroundColor=e.style.backgroundColor}var r=this.rows-1;for(t=0;t<this.cols;t++)(s=this.cellel[r][t]).innerHTML="&nbsp;",this.reverse?(s.style.backgroundColor=this.outColors.txtColor,s.style.color="rgba(0,255,0,0.0)"):(s.style.color=this.outColors.txtColor,s.style.backgroundColor=void 0)}},t.i.canvas=class{constructor(t){this.sys=t,this.cursorOn=!1,this.hidden=!1,this.blinking=!0,this.reverse=!1,this.colors={},this.palette=["#000000","#ffffff","#ee2222","#22ee22","#2222ee","#eeee22","#22eeee","#ee22ee","#aaaaaa","#777777","#444444","#FFAC1C","#5C3317","#F88379","#79F883","#8379F8"],this.bmPalette=[];for(var i=0;i<this.palette.length;i++){var s=this.palette[i],e=parseInt(s.substr(1,2),16),r=parseInt(s.substr(3,2),16),o=parseInt(s.substr(5,2),16);this.bmPalette.push({r:e,g:r,b:o})}this.defaultTextMode()}destroy(){this.outDiv0.remove(),this.cvs=null,this.cvs2=null,this.cvs3=null,this.ctx=null,this.ctx2=null,this.ctx3=null,this.cache=null,this.cells=[],this.blinkInterval&&(clearInterval(this.blinkInterval),this.blinkInterval=void 0)}defaultTextMode(){this.cols=80,this.rows=30,this.x=0,this.y=0,this.fontSize="18",this.fontSizeCSS=this.fontSize+"px",this.fontSizeInt=parseInt(this.fontSize),this.fontFamily="monospace";var t=this.colors;t.bg=0,t.fg=5,this.colors.bgHTML=this.palette[t.bg],this.colors.fgHTML=this.palette[t.fg]}init(){}initMode(t){var i=this.sys,s=i.init.queuedMessages;this.cursorOn=!1,this.blinking=!0,this.reverse=!1,this.cursorMode=1;var e=t[0].split("x"),r=parseInt(e[0]),o=parseInt(e[1]);this.cols=Math.floor(r/this.fontSizeInt),this.rows=Math.floor(o/this.fontSizeInt),r=this.cols*this.fontSizeInt,o=this.rows*this.fontSizeInt,this.width=r,this.height=o,console.log("Reinit with ",r,o),console.log(" colsXrows ",this.cols,this.rows),this.x=0,this.y=0,this.blinking=!0;var l=this.colors;l.bg=0,l.fg=5,l.bgHTML=this.palette[l.bg],l.fgHTML=this.palette[l.fg],i.init.inputElement=document.body,this.outDiv0=document.createElement("div"),this.outDiv1=document.createElement("div"),this.center=document.createElement("center"),this.cvs=document.createElement("canvas"),this.ctx=this.cvs.getContext("2d",{alpha:!1}),this.ctx.strokeStyle="#ffffff",this.cX=0,this.cY=0,this.cvs2=document.createElement("canvas"),this.ctx2=this.cvs2.getContext("2d"),this.cvs3=document.createElement("canvas"),this.ctx3=this.cvs3.getContext("2d"),this.cache=[],this.updCtxImageData={synched:!1},this.cvs.width=r,this.cvs.height=o,this.cvs2.width=r,this.cvs2.height=o;var h=this.fontSizeInt;this.cvs3.width=h,this.cvs3.height=h,this.offsets=[];var n=this.ctx;n.font=this.fontSizeCSS+" "+this.fontFamily,n.textBaseline="bottom";var a=this.fontSizeInt/2;for(const t of"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890@+_!#%&/()=?*-:;,.'\""){var c=a-this.ctx.measureText(t).width/2;e=Math.floor(c),this.offsets[t]=e}this.cells=[];for(var d=this.colors,f=0;f<this.rows;f++){for(var u=[],g=0;g<this.cols;g++)u.push({txt:" ",fg:d.fg,bg:d.bg});this.cells.push(u)}document.body.appendChild(this.outDiv0),this.outDiv0.style.display="table",this.outDiv0.style.width="99%",this.outDiv0.style.height="99%",this.outDiv0.style.position="absolute",this.outDiv0.style.zIndex="10000",this.outDiv1.style.display="table-cell",this.outDiv1.style.verticalAlign="middle",this.cvs.style.marginLeft="auto",this.cvs.style.marginRight="auto",this.outDiv0.appendChild(this.outDiv1),this.outDiv1.appendChild(this.center),this.center.appendChild(this.cvs),this.cvs.focus();var v=this;this.blinkInterval=setInterval((function(){v._int_blink()}),300);for(var p=0;p<s.length;p++)this.writeln(s[p]);this.clear(),this.sys.log("CANVASCON Ready.")}hide(){this.init(),this.hidden||(this.outDiv0.hidden=!0,this.hidden=!0)}show(){this.init(),this.hidden&&(this.outDiv0.hidden=!1,this.hidden=!1)}getElement(){return null}blinkMode(t){this.blinking=t}_int_blinkOff(){if(this.cursorOn){var t=this.fontSizeInt,i=t*this.x,s=t*this.y;this.ctx,this.ctx.drawImage(this.cvs3,i,s),this.cursorOn=!1}}_int_storeset_color(t,i){this.oldfg=t,this.oldbg=i;var s=this.colors;s.fg=t,s.bg=i,s.fgHTML=this.palette[s.fg],s.bgHTML=this.palette[s.bg]}_int_restore_color(){var t=this.colors;t.fg=this.oldfg,t.bg=this.oldbg,t.fgHTML=this.palette[t.fg],t.bgHTML=this.palette[t.bg]}_int_blink(){if(this.blinking){this.cursorOn,this.cursorOn=!this.cursorOn;var t=this.fontSizeInt,i=t*this.x,s=t*this.y,e=(this.colors,this.ctx,this.cells[this.y][this.x]);if(this.cursorOn){this.ctx3.drawImage(this.cvs,i,s,t,t,0,0,t,t),this.colors.fgHTML;var r=this.colors.fg,o=this.colors.bg;return e.fg==e.bg?0==e.fg?(r=1,o=0):(r=0,o=1):(r=e.fg,o=e.bg),void this.paintCursor(i,s,e.txt,r,o,this.cursorMode)}this.ctx.drawImage(this.cvs3,i,s)}}_int_updateArea(t,i,s,e,r){this.ctx;var o,l,h=this.fontSizeInt,n=this.colors;try{for(o=i;o<=e;o++)for(l=s;l<=r;l++){var a=this.cells[l][o],c=t[l-s][o-i],d=c.txt;n.bg=c.bg,n.fg=c.fg,n.bgHTML=this.palette[c.bg],n.fgHTML=this.palette[c.fg],a.txt=d,a.fg=c.fg,a.bg=c.bg,this.paintchar(h*o,h*l,d)}}catch(t){console.log("x= "+o+" y= "+l),console.log("x0=",i,"y0=",s,"x1=",e,"y1=",r),console.log(t)}}paintCursor(t,i,s,e,r,o){this._int_storeset_color(r,e),this.paintchar(t,i,s),this._int_restore_color()}paintchar(t,i,s){this.updCtxImageData.synched=!1;var e=this.colors,r=s+":"+e.bg+":"+e.fg;this.reverse;var o=this.cache[r],l=this.fontSizeInt;if(!o){var h=document.createElement("canvas"),n=h.getContext("2d",{alpha:!1});h.width=l,h.height=l,n.font=this.fontSizeCSS+" "+this.fontFamily,n.textBaseline="top";var a=0;this.offsets[s]&&(a=this.offsets[s]),n.fillStyle=this.colors.bgHTML,n.fillRect(0,0,l,l),n.fillStyle=this.colors.fgHTML,n.fillText(s,a,0),this.cache[r]={ctx:n,cvs:h},o=this.cache[r]}this.ctx.drawImage(o.cvs,t,i)}op_gcolor(t){var i=this.palette[t.c];this.ctx.strokeStyle=i}op_line(t){this.updCtxImageData.synched=!1;var i=this.ctx,s=t.x0,e=t.y0;s<0&&(s=this.cX),e<0&&(e=this.cY),i.beginPath(),i.moveTo(s,e),i.lineTo(t.x1,t.y1),i.stroke(),this.cX=t.x1,this.cY=t.y1}native(t){this["op_"+t.action](t.params)}gfxUpdate__old(t){for(var i=t.pixels,s=this.ctx,e=[],r=[],o=(Math.ceil(this.width/100),Math.ceil(this.height/100),0);o<i.length;o++){var l,h,n=i[o],a=Math.floor(n.x/100),c=Math.floor(n.y/100),d=a+"_"+c;if(e[d])l=(y=e[d]).pdata,h=y.imd;else{var f=100*a,u=100*c,g=f+100-1,v=u+100-1;g>this.width-1&&(g=this.width-1),v>this.height-1&&(v=this.height-1);var p=g-f+1,m=v-u+1,y={x:f,y:u,w:p,h:m,imd:h=s.getImageData(f,u,p,m),pdata:l=h.data};e[d]=y,r.push(y)}var x=n.x-100*a,b=400*(n.y-100*c)+4*x,S=this.bmPalette[n.c];l[b+0]=S.r,l[b+1]=S.g,l[b+2]=S.b}for(o=0;o<r.length;o++){h=(y=r[o]).imd;var w=y.x,k=y.y;s.putImageData(h,w,k)}}gfxUpdate(t){var i=4*this.width,s=t.pixels,e=this.ctx,r=this.updCtxImageData;r.synched||(r.imd=e.getImageData(0,0,this.width,this.height),r.data=r.imd.data,r.synched=!0);for(var o=r.data,l=r.imd,h=0;h<s.length;h++){var n=s[h],a=n.x,c=n.y*i+4*a,d=this.bmPalette[n.c];o[c+0]=d.r,o[c+1]=d.g,o[c+2]=d.b}e.putImageData(l,0,0)}update(t,i){this._int_blinkOff(),this.show(),this.x=t.cx,this.y=t.cy,(this.x<0||this.y<0||this.x>=this.cols||this.y>=this.rows)&&console.log("ouch"),this.colors.bgHTML=this.palette[t.bg],this.colors.fgHTML=this.palette[t.fg];for(var s=0;s<i.length;s++){var e=i[s];this._int_updateArea(e.cells,e.x1,e.y1,e.x2,e.y2)}}updateAll(t,i){this._int_blinkOff(),this.show(),this.x=t.cx,this.y=t.cy,(this.x<0||this.y<0||this.x>=this.cols||this.y>=this.rows)&&console.log("ouch"),this.colors.bgHTML=this.palette[t.bg],this.colors.fgHTML=this.palette[t.fg],this.colors.bg=t.bg,this.colors.fg=t.fg,this._int_updateArea(i,0,0,this.cols-1,this.rows-1)}clear(){this._int_blinkOff(),this.show();for(var t=0,i=0;i<this.cols;i++){t=1-t;for(var s=0;s<this.rows;s++)this.cells[s][i].txt=" ",this.cells[s][i].fg=this.colors.fg,this.cells[s][i].bg=this.colors.bg}this.ctx.fillStyle=this.colors.bg,this.ctx.fillRect(0,0,this.cvs.width,this.cvs.height),this.x=0,this.y=0}__int_nl(){this.x=0,this.y++,this.y>=this.rows&&(this.__int_scrollDown(),this.y=this.rows-1)}writeln(t){this._int_blinkOff(),this.show();for(const i of t)this.__int_write_direct_ch(i);this.__int_nl()}__int_write_direct_ch(t){var i=this.cells[this.y][this.x];if(null!=i){i=t.txt;var s=this.ctx,e=this.fontSizeInt,r=0;this.offsets[t.txt]&&(r=this.offsets[t.txt]),this.ctx.fillStyle=this.colors.bgHTML,s.fillRect(e*this.x,e*this.y,e,e),s.fillStyle=this.colors.fgHTML,s.fillText(t.txt,r+e*this.x,e*(this.y+1)),this.x++,this.x>=this.cols&&(this.x=0,this.__int_nl())}else console.log("cell at "+this.x+","+this.y+" == null ")}getDimensions(){return[this.cols,this.rows]}hasPixels(){return!0}getBitmapDimensions(){return[this.width,this.height]}getColumCount(){return this.cols}getRowCount(){return this.rows}__int_scrollDown(){for(var t=0;t<this.cols;t++)for(var i=0;i<this.rows-1;i++)this.cells[i][t],this.cells[i+1][t];var s=this.rows-1;for(t=0;t<this.cols;t++)this.cells[s][t].txt=" ";var e=this.fontSizeInt;this.ctx2.drawImage(this.cvs,0,0);var r=this.cvs2.width,o=this.cvs2.height-e;this.ctx.fillStyle=this.colors.bg,this.ctx.fillRect(0,0,this.cvs.width,this.cvs.height),this.ctx.drawImage(this.cvs2,0,e,r,o-e,0,0,r,o-e)}},t.i.simplewarning=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.key=t.SIG+"__LSConfirmed",this.warningOngoing=!1,console.log("simplewarning initialized"),t.notify=this}init(){}simpleWarning(){if(!this.warningOngoing){this.oldBGColor=document.body.style.backgroundColor,document.body.style.backgroundColor="#ffffff";var t=this;setTimeout((function(){document.body.style.backgroundColor=t.oldBGColor,t.warningOngoing=!1}),200)}}},t.i.priv=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.key=t.SIG+"__LSConfirmed",this.verified=!1,this.denied=!1,console.log("PrivWarning initialized")}init(){}confirmLocalStorage(){return!(this.denied||"true"!=localStorage.getItem(this.key)&&(confirm("!! Do you allow "+this.sys.SIG+" to write to local browser storage !!\nThis is needed to simulate a local harddisk.\n If you do not agree, you can still use the system,\n but you won't be able to save any files, or session information.\n\nAll information will only be stored on the local storage,\n and will not be shared with any server, unless you will give explicit permission.\n\nThank you!")?(localStorage.setItem(this.key,"true"),0):(this.denied=!0,1)))}},t.i.mutedinput=class{constructor(t){}init(){}getKey(){return null}setInputHandler(t,i){}},t.i.domelinput=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.evtQueueKeyPress=[],this.handler=null,this.prefix=""}init(){this.init.inputElement,this.target=document.body}getKey(){return this.handler||0==this.evtQueueKeyPress.length?null:this.evtQueueKeyPress.shift()}setInputHandler(t,i){this.handler=t,this.prefix=i;var s=this.evtQueueKeyPress,e=(this.sys.out,this.handler);i=this.prefix,this.target.inputMode="text",this.target.addEventListener("keydown",(t=>{var r={type:"keydown",key:t.key,keyLabel:t.key};t.key.length>1&&(r.key=null,r.keyLabel=t.key,"Enter"==t.key&&(r.key="\n")),t.preventDefault(),e?e[i+"KeyHandler"](r):s.push(r)}))}},t.i.htmlwrapper=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.node=document.body,document.body.id="top",this.isAttr=!1}init(){}execute(t){var i=t[0];console.log("execute",i);var s=i.htmlHandle;if(s?this.setnode(s):this.isAttr=!1,null!=this.node)if(0==this.isAttr)if(i.htmlAppend){var e=document.createElement("span");e.innerHTML=i.htmlValue;const t=e.childNodes;var r=[];for(let i=0;i<t.length;i++)r.push(t[i]);for(let t=0;t<r.length;t++)this.node.appendChild(r[t]);e=null}else{if("top"==this.node.id)return void console.log("Cannot replace body code. it would crash the console!");this.node.innerHTML=i.htmlValue}else{var o=this.node.attributes.getNamedItem(this.attrName);if(null==o)return void console.log("Attr '"+this.attrName+"' not found on html node "+this.node.id+"!");o=o.nodeValue,i.htmlAppend?o+=i.htmlValue:o=i.htmlValue,this.node.setAttribute(this.attrName,o)}else console.log("invalid html root")}setnode(t){if(console.log("setnode",t),this.isAttr=!1,".."==t)this.node=this.node.parentNode;else{var i=t.split("."),s=null,e=null;if(i.length>1?(e=i[0],s=i[1]):e=t,""!=e){var r=document.getElementById(e);if(!r)return void console.log("could not find",t);this.node=r}""!=s&&null!=s&&(this.isAttr=!0,this.attrName=s)}}},t.i.basic=class{constructor(t){this.apps=[],this.sys=t}init(){var t=this.sys,i=t.out,s=t.m.htmlwrapper,e=t.m.displaymodes;this.out=i,t.staticTarget?this.worker=new Worker("basicworker.js"):t.dynamicMinTarget?this.worker=new Worker("sys/modules/basic/worker/workerbootstrap_min.js"):this.worker=new Worker("sys/modules/basic/worker/workerbootstrap_max.js"),this.worker.postMessage({type:"inittxtarea",w:i.getColumCount(),h:i.getRowCount()});var r=[-1,-1];i.hasPixels()&&(r=i.getBitmapDimensions()),this.worker.postMessage({type:"initbitmap",w:r[0],h:r[1]});var o=this;this.worker.onmessage=function(r){var l=r.data.message,h=r.data.type;if("syslog"==h)t.log("BWSYS:",r.data.message);else if("syserr"==h)t.logerr("BWERR:",r.data.message);else if("write"==h)for(var n=0;n<l.length;n++)i.write(l[n]);else if("writeln"==h)for(n=0;n<l.length;n++)i.writeln(l[n]);else if("writec"==h)i.writec(l);else if("control"==h)i.control(l);else if("control2"==h)i.control(l.c,l.d);else if("blinkMode"==h)i.blinkMode(l.m);else if("locate"==h)i.setPos(l.c,l.r);else if("html"==h)s.execute(l);else if("htmlnode"==h)s.setnode(l[0].value);else if("displaymode"==h){e.setMode(l.m),i=e.getDriver(),t.out=i;var a=i.getDimensions(),c=[-1,-1];i.hasPixels()&&(c=i.getBitmapDimensions()),this.postMessage({type:"message",processId:l.processId,message:"displaysize",messageObject:{textW:a[0],textH:a[1],bitmapW:c[0],bitmapH:c[1]}})}else if("textupdate"==h){var d={cx:l.cx,cy:l.cy,fg:l.fg,bg:l.bg};t.out.update(d,l.areasList)}else if("textupdate-all"==h)d={cx:l.cx,cy:l.cy,fg:l.fg,bg:l.bg},t.out.updateAll(d,l.cells);else if("gfxupdate"==h)t.out.gfxUpdate(l);else if("export"==h){var f={clazz:o,method:"nullHandler",data:""};t.m.qfs.saveFile("transfer://myprogram.bas",l.code,f)}else"nativeout"==h&&t.out.native(l)}}nullHandler(t){console.log("nullhandler "+t)}loadApp(t){this.sys.log("BSYS:","Load",t);var i={clazz:this,method:"loadedApp",data:null};this.sys.m.qfs.loadFile(t,i)}loadedApp(t){this.sys.log("BSYS:","Loaded",t.args.url),this.out.blinkMode(!1),this.worker.postMessage({type:"loadpgm",pgmData:t.data.data,QPath:t.args.qpath})}setInput(t){this.sys.log("BSYS: Setting input on BAPPS.."),this.input=t,this.input.setInputHandler(this,"input")}inputKeyHandler(t){this.worker.postMessage(t)}},t.i.sfs=class{constructor(t){if(!t)throw"sys expected";this.initialized=!1,this.sys=t,this.prefix=t.SIG+"__"}init(){this.initialize()}initialize(){this.currentDisk="SYS",this.initialized=!0}ready(){return this.initialized}getEmptyDirStructure(t){return{files:[],title:"null"}}getDir(){if(!this.initialized)return getEmptyDirStructure(null);var t=this.prefix+""+this.currentDisk+"_dir",i=sessionStorage.getItem(t),s=JSON.parse(i),e=s.title;if(!i)return{files:[],title:e};s.title=e,s.free=32-s.files.length;for(var r=-1;;){for(var o=0;o<s.files.length;o++)if(null==s.files[o]){r=o;break}if(!(r>-1))break;s.files.splice(r,1),r=-1}return s}setDir(t){if(0!=this.privacy.confirmLocalStorage()&&this.initialized){var i=this.prefix+""+this.currentDisk+"_dir";sessionStorage.setItem(i,JSON.stringify(t))}}existsFile(t){if(!this.initialized)return!1;for(var i=this.getDir(),s=-1,e=0;e<i.files.length;e++)if(i.files[e].fname==t){s=e;break}return s>-1}removeFromDir(t){if(this.initialized){for(var i=this.getDir(),s=-1,e=0;e<i.files.length;e++)if(i.files[e].fname==t){s=e;break}s>-1&&i.files.splice(e,1),this.setDir(i)}}updateDir(t,i,s){if(this.initialized){for(var e=this.getDir(),r=-1,o=0;o<e.files.length;o++)if(e.files[o].fname==t){r=o;break}r>-1?(e.files[o].size=i,e.files[o].type=s):e.files.push({fname:t,size:i,type:s}),this.setDir(e)}}saveFile(t,i,s,e){if(!this.initialized)return!1;if(0==this.privacy.confirmLocalStorage())return!1;var r=t;t.length>32&&(r=t.substr(0,32));var o=this.prefix+""+this.currentDisk+"_"+r,l=JSON.stringify({type:s,data:i});return sessionStorage.setItem(o,l),this.updateDir(r,e,s),!0}loadFile(t){if(!this.initialized)return null;var i=this.prefix+""+this.currentDisk+"_"+t,s=sessionStorage.getItem(i);return JSON.parse(s)}deleteFile(t){if(!this.existsFile(t))return"no such file";try{this.removeFromDir(t),this._removeFile(t)}catch(t){return"unexpected"}return"ok"}_removeFile(t){var i=this.prefix+""+this.currentDisk+"_"+t;sessionStorage.removeItem(i)}formatDisk(){for(var t=this.getDir(),i=0;i<t.files.length;i++){var s=t.files[i].fname;this._removeFile(s)}t.files=[],t.title="Empty",this.setDir()}getFullDisk(){if(!this.initialized){var t={dir:i=this.getDir(),content:[]};return JSON.stringify(t)}for(var i=this.getDir(),s=[],e=0;e<i.files.length;e++){var r=i.files[e].fname,o=this.prefix+""+this.currentDisk+"_"+r,l=sessionStorage.getItem(o);s.push({fname:r,content:l})}t={dir:i,content:s};var h=JSON.stringify(t);return console.log(h),h}},t.i.lfs=class{constructor(t){if(!t)throw"sys expected";this.initialized=!1,this.sys=t,this.prefix=t.SIG+"__",console.log(t)}init(){this.initialize()}initialize(){this.privacy=this.sys.m.priv,this.disks=[],this.currentDisk=null;var t=localStorage.getItem(this.prefix+"disks_list");if(null==t){var i="0001";this.disks=[i],this.currentDisk=i,this.lastDisk=1,1==this.privacy.confirmLocalStorage()&&(localStorage.setItem(this.prefix+"disks_list",JSON.stringify(this.disks)),localStorage.setItem(this.prefix+"0001_dir",JSON.stringify({files:[],title:"Default",readOnly:!1})),localStorage.setItem(this.prefix+"disk_current",i))}else{this.disks=JSON.parse(t),this.currentDisk=localStorage.getItem(this.prefix+"disk_current");for(var s=-1,e=0;e<this.disks.length;e++)parseInt(this.disks[e])>s&&(s=parseInt(this.disks[e]));this.lastDisk=s}this.initialized=!0}isASynch(){return!1}selectDisk(t){this.currentDisk=t,1==this.privacy.confirmLocalStorage()&&localStorage.setItem(this.prefix+"disk_current",t)}ready(){return this.initialized}getDisks(){if(!this.initialized)return[];var t=this.prefix+"disks_list",i=localStorage.getItem(t);return JSON.parse(i)}getEmptyDirStructure(t){return{files:[],title:"null"}}getDir(){if(!this.initialized)return getEmptyDirStructure(null);var t=this.prefix+""+this.currentDisk+"_dir",i=localStorage.getItem(t),s=JSON.parse(i),e=s.title;if(!i)return{files:[],title:e};s.title=e,s.free=32-s.files.length;for(var r=-1;;){for(var o=0;o<s.files.length;o++)if(null==s.files[o]){r=o;break}if(!(r>-1))break;s.files.splice(r,1),r=-1}return s}getSelectedDir(t){if(!this.initialized)return{files:[],title:"null"};var i=this.prefix+""+t+"_dir",s=localStorage.getItem(i),e=JSON.parse(s),r=e.title;return s?(e.title=r,e.free=32-e.files.length,e):{files:[],title:r}}setDir(t){if(this.initialized){var i=this.prefix+""+this.currentDisk+"_dir";1==this.privacy.confirmLocalStorage()&&localStorage.setItem(i,JSON.stringify(t))}}existsFile(t){if(!this.initialized)return!1;for(var i=this.getDir(),s=-1,e=0;e<i.files.length;e++)if(i.files[e].fname==t){s=e;break}return s>-1}removeFromDir(t){if(this.initialized){for(var i=this.getDir(),s=-1,e=0;e<i.files.length;e++)if(i.files[e].fname==t){s=e;break}s>-1&&i.files.splice(e,1),this.setDir(i)}}updateDir(t,i,s){if(this.initialized){for(var e=this.getDir(),r=-1,o=0;o<e.files.length;o++)if(e.files[o].fname==t){r=o;break}r>-1?(e.files[o].size=i,e.files[o].type=s):e.files.push({fname:t,size:i,type:s}),this.setDir(e)}}saveFile(t,i,s,e){if(this.initialized){var r=t;t.length>32&&(r=t.substr(0,32)),r.startsWith("$/")&&(r=r.substr(2));var o=this.prefix+""+this.currentDisk+"_"+r,l=JSON.stringify({type:s,data:i});1==this.privacy.confirmLocalStorage()&&(localStorage.setItem(o,l),this.updateDir(r,e,s))}}loadJSONFile(t){if(!this.initialized)return null;var i=this.prefix+""+this.currentDisk+"_"+t,s=localStorage.getItem(i);return JSON.parse(s)}loadFile(t){if(!this.initialized)return null;var i=t;t.length>32&&(i=t.substr(0,32)),i.startsWith("$/")&&(i=i.substr(2));var s=this.prefix+""+this.currentDisk+"_"+i,e=localStorage.getItem(s);return JSON.parse(e)}deleteFile(t){if(!this.existsFile(t))return"no such file";try{this.removeFromDir(t),this._removeFile(t)}catch(t){return"unexpected"}return"ok"}_removeFile(t){var i=this.prefix+""+this.currentDisk+"_"+t;localStorage.removeItem(i)}formatDisk(){for(var t=this.getDir(),i=0;i<t.files.length;i++){var s=t.files[i].fname;this._removeFile(s)}t.files=[],t.title="Empty",this.setDir()}createDiskFromImage(t,i){this.createDiskFromImage2(t,i,!1)}createSysDiskFromImage(t){this.createDiskFromImage2("SYS",t,!0)}createDiskFromImage2(t,i,s){if(0!=this.privacy.confirmLocalStorage()){var e;s?e="1":(this.lastDisk++,e=""+this.lastDisk),e=e.padStart(4,"0");var r=i.dir,o=i.outtent,l=this.prefix+""+e+"_dir";localStorage.setItem(l,JSON.stringify(r));for(var h=0;h<o.length;h++){var n=o[h].fname;l=this.prefix+""+e+"_"+n,localStorage.setItem(l,o[h].outtent)}this.disks.push(e),localStorage.setItem(this.prefix+"disks_list",JSON.stringify(this.disks))}}createDisk(){if(0!=this.privacy.confirmLocalStorage()){this.getDisks(),this.lastDisk++;var t=""+this.lastDisk;t=t.padStart(4,"0");var i=this.getEmptyDirStructure("NEW DISK"),s=this.prefix+""+t+"_dir";localStorage.setItem(s,JSON.stringify(i)),this.disks.push(t),localStorage.setItem(this.prefix+"disks_list",JSON.stringify(this.disks))}}getFullDisk(){if(!this.initialized){var t={dir:i=this.getDir(),content:[]};return JSON.stringify(t)}for(var i=this.getDir(),s=[],e=0;e<i.files.length;e++){var r=i.files[e].fname,o=this.prefix+""+this.currentDisk+"_"+r,l=localStorage.getItem(o);s.push({fname:r,content:l})}t={dir:i,content:s};var h=JSON.stringify(t);return console.log(h),h}},t.i.ramfs=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.files=[],this.data={}}init(){}isASynch(){return!1}ready(){return!0}getDir(){return this.files}exists(t){for(var i=this.getDir(),s=-1,e=0;e<i.length;e++)if(i[e].fname==t){s=e;break}return s>-1}saveFile(t,i,s,e){if(t.indexOf("/")>-1)throw{message:"saveFile: '"+t+"' - invalid path, RAMFS device only supports flatdir"};if(!this.exists(t)){var r={fname:t,type:s,size:e};this.data[t]={type:s,data:i},this.files.push(r)}}loadFile(t){return this.exists(t)?this.data[t]:null}deleteFile(t){if(!this.existsFile(t))return!1;try{for(var i=this.files,s=0;s<i.length;s++)if(i[s].fname==t){i[s]=void 0;break}this.data[t]=void 0}catch(i){throw{message:"deleteFile: '"+t+"' - "+i.message}}return!0}formatDisk(){this.files=[],this.data={}}},t.i.script=class{constructor(t){if(!t)throw"sys expected";this.sys=t,this.files=[],this.data={}}init(){}isASynch(){return!1}ready(){return!0}exists(t){if(document.getElementById(t))return!0}saveFile(t,i,s,e){throw{message:"saveFile '"+t+"' - SCRIPTURL is readonly"}}loadFile(t){if(!this.exists(t))return null;for(var i=document.getElementById(t).innerText.split("\n"),s="",e=0;e<i.length;e++)""!=s&&(s+="\n"),s+=i[e].trim();return{type:"bas",data:s}}deleteFile(t){throw{message:"deleteFile '"+t+"' - SCRIPTURL is readonly"}}formatDisk(){throw{message:"formatDisk '"+fileName+"' - SCRIPTURL is readonly"}}},t.i.qfs=class{constructor(t,i){if(!t)throw"sys expected";if(!i)throw"dependencies expected";this.dependencies=i,this.initialized=!1,this.sys=t,this.prefix=t.SIG+"__"}init(){this.initialize()}initialize(){this.fsList=[];for(var t=this.dependencies,i=0;i<t.length;i++){var s=t[i],e={token:s,fs:this.sys.m[s],prefix:s+"://"};this.fsList.push(e)}this.initialized=!0}ready(){return this.initialized}getFS(t){for(var i=this.fsList,s=0;s<i.length;s++){var e=i[s];if(t.startsWith(e.prefix))return e}return null}getLPath(t){var i=t.split("://");return i.length<2?null:i[1]}getDir(t){return!!this.initialized&&[]}existsFile(t){return this.initialized,!1}doCallBack(t,i){t.clazz?(t.data&&(i.cbData=t.data),t.clazz[t.method](i)):t(i)}saveFile(t,i,s,e,r){if(!this.initialized)return null;var o=this.getFS(t);if(!o)throw{message:t+" has unknown file system"};var l=this.getLPath(t);if(!l)throw{message:"QPath '"+t+"' has no local path"};if(!o.fs.isASynch()){var h=o.fs.saveFile(l,i,e,r),n={};n.qpath=t,n.type=e,n.length=r;var a={result:h,args:n};this.doCallBack(s,a)}return null}loadFile(t,i){if(!this.initialized)return null;var s=this.getFS(t);if(!s)throw{message:t+" has unknown file system"};var e=this.getLPath(t);if(!e)throw{message:"QPath '"+t+"' has no local path"};if(!s.fs.isASynch()){var r={data:s.fs.loadFile(e),cbData:i.data,args:{qpath:t}};i.clazz[i.method](r)}return null}deleteFile(t){return this.existsFile(fileName)?"error":"no such file"}formatDisk(t){return this.existsFile(fileName)?"error":"no such file"}},t.dep.qfs=["ramfs","lfs","sfs","script"],t.dep.basic=["canvas","tablecon","displaymodes","qfs","htmlwrapper"],t.initSimpleLogging();for(var s=Object.getOwnPropertyNames(t.i),e=0;e<s.length;e++)console.log("construct "+s[e]),t.m[s[e]]=new t.i[s[e]](i,t.dep[s[e]]);i.init.queuedMessages=i.nulcon,i.init.conStyle=t.conStyle,i.init.displayMode=t.displayMode,i.m=t.m,i.m.displaymodes.setMode(t.displayMode);var r=i.m.displaymodes.getDriver();for(t.out=r,i.out=r,e=0;e<s.length;e++)console.log("init "+s[e]),t.m[s[e]].init();try{var o=t.rootScript.dataset.script;null==o&&(o="autorun.bas"),t.onReady="script://"+o}catch(t){throw alert("HALT: Boot-Onready Handler not found!!"),"HALT - Neither root-script-attribute 'basScript' or constant 'BOOT_ONREADY' defined."}i.nulcon=void 0,t.input=t.m.domelinput,console.log("boot.basic=",t.basic),t.m.basic.setInput(t.input),t.m.basic.loadApp(t.onReady)})();
//# sourceMappingURL=basicloader.js.map